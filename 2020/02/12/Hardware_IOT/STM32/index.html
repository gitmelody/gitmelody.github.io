<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Keil 标准库创建STM32F103工程首先创建一个项目目录：  STM32F103RBT Project User Device Driver    打开Keil，选择上方的Project-&amp;gt;New uVersion Project，在Project目录下创建工程文件。在打开的面板左侧选择版型，这里选择STM32F1 Series-&amp;gt;STM32F103-&amp;gt;STM32F103C">
<meta name="keywords" content="STM32F103,UCOS III">
<meta property="og:type" content="article">
<meta property="og:title" content="STM32">
<meta property="og:url" content="https://withz.github.io/2020/02/12/Hardware_IOT/STM32/index.html">
<meta property="og:site_name" content="Withz">
<meta property="og:description" content="Keil 标准库创建STM32F103工程首先创建一个项目目录：  STM32F103RBT Project User Device Driver    打开Keil，选择上方的Project-&amp;gt;New uVersion Project，在Project目录下创建工程文件。在打开的面板左侧选择版型，这里选择STM32F1 Series-&amp;gt;STM32F103-&amp;gt;STM32F103C">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://withz.github.io/2020/02/12/Hardware_IOT/STM32/usb-pid.png">
<meta property="og:updated_time" content="2020-06-22T07:03:55.219Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="STM32">
<meta name="twitter:description" content="Keil 标准库创建STM32F103工程首先创建一个项目目录：  STM32F103RBT Project User Device Driver    打开Keil，选择上方的Project-&amp;gt;New uVersion Project，在Project目录下创建工程文件。在打开的面板左侧选择版型，这里选择STM32F1 Series-&amp;gt;STM32F103-&amp;gt;STM32F103C">
<meta name="twitter:image" content="https://withz.github.io/2020/02/12/Hardware_IOT/STM32/usb-pid.png">






  <link rel="canonical" href="https://withz.github.io/2020/02/12/Hardware_IOT/STM32/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>STM32 | Withz</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Withz</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">50</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">7</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">30</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/withz" class="github-corner" title="打开Github" aria-label="打开Github" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://withz.github.io/2020/02/12/Hardware_IOT/STM32/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Withz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">STM32

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-02-12 17:44:42" itemprop="dateCreated datePublished" datetime="2020-02-12T17:44:42+08:00">2020-02-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-06-22 15:03:55" itemprop="dateModified" datetime="2020-06-22T15:03:55+08:00">2020-06-22</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/物联网与硬件/" itemprop="url" rel="index"><span itemprop="name">物联网与硬件</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Keil-标准库"><a href="#Keil-标准库" class="headerlink" title="Keil 标准库"></a>Keil 标准库</h2><h3 id="创建STM32F103工程"><a href="#创建STM32F103工程" class="headerlink" title="创建STM32F103工程"></a>创建STM32F103工程</h3><p>首先创建一个项目目录：</p>
<ul>
<li>STM32F103RBT<ul>
<li>Project</li>
<li>User</li>
<li>Device</li>
<li>Driver</li>
</ul>
</li>
</ul>
<p>打开Keil，选择上方的<code>Project</code>-&gt;<code>New uVersion Project</code>，在Project目录下创建工程文件。在打开的面板左侧选择版型，这里选择<code>STM32F1 Series</code>-&gt;<code>STM32F103</code>-&gt;<code>STM32F103C8</code>。</p>
<p>下一步会弹出<code>Manage Run-Time Environment</code>，这里是选择外设的地方。<br>这里选择需要的库：</p>
<ul>
<li>CMSIS<ul>
<li>CORE</li>
</ul>
</li>
<li>Device<ul>
<li>DMA</li>
<li>GPIO</li>
<li>Startup</li>
<li>StdPeriph Drivers<ul>
<li>ADC</li>
<li>Framework</li>
<li>RCC</li>
<li>DMA</li>
<li>EXIT</li>
<li>GPIO</li>
<li>DGBMCU</li>
<li>TIM</li>
<li>SPI</li>
<li>USART</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>创建完成后打开<code>Options for Target</code>，在<code>C/C++</code>选项卡的<code>Define</code>项填写：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STM32F10X_MD,USE_STDPERIPH_DRIVER</span><br></pre></td></tr></table></figure></p>
<p>前一项表示板子的类型，由与是C8板，因此是MD型；如果是Z系列或V系列，则为HD型。<br>后一项表示使用标准库。</p>
<p>在<code>Include Paths</code>中填写，这里是<code>.h</code>文件的搜索路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..\Device;..\Driver;..\User;..\Project;..\UCOS;..\UCOS\core;..\UCOS\cpu;..\UCOS\lib</span><br></pre></td></tr></table></figure></p>
<p>在<code>Debug</code>选项卡右侧的<code>Use</code>中选择<code>J-LINK/J-TRACE Cortex</code>。完成后点击<code>Settings</code>，选择<code>Flash Download</code>选项卡，删除<code>Programming Algorithm</code>中的项目，点击<code>ADD</code>，添加第一项。另外，在<code>Debug</code>选项卡可以选择<code>Port</code>，可以是<code>Jtag</code>或<code>SW</code>，可根据下载器选择。完成后确定返回。</p>
<p>这里开始创建一个<code>main.c</code>和一个<code>main.h</code>文件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"main.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GPIO_InitTypeDef gpio;</span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);</span><br><span class="line">    gpio.GPIO_Mode = GPIO_Mode_Out_PP;</span><br><span class="line">    gpio.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    gpio.GPIO_Pin = GPIO_Pin_2;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;gpio);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        GPIO_ResetBits(GPIOA, GPIO_Pin_2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MAIN_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAIN_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stm32f10x.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>之后打开<code>Manage Project Items</code>按钮，编辑项目目录。这可以按照项目目录创建<code>Groups</code>，并在对应的<code>Files</code>中添加相应<code>.c</code>文件。</p>
<p>最后编译下载查看效果。</p>
<h3 id="STM32F4"><a href="#STM32F4" class="headerlink" title="STM32F4"></a>STM32F4</h3><h4 id="宏定义"><a href="#宏定义" class="headerlink" title="宏定义"></a>宏定义</h4><p>USE_STDPERIPH_DRIVER 使用标准库<br>STM32F40_41xxx 选择芯片型号<br>ARM_MATH_CM4 使用<code>ARM MATH</code>库，调用片内DSP</p>
<h4 id="修改时钟源"><a href="#修改时钟源" class="headerlink" title="修改时钟源"></a>修改时钟源</h4><p>由于STM32F4默认HSE为25MHz，而一般的生产厂家配置的是8MHz的晶振，因此默认情况下，程序跑不到168MHz，需要更改默认配置。</p>
<p>打开<code>system_stm32f4xx.c</code>，配置如下选项：</p>
<ol>
<li>找到<code>PLL Parameters</code>下的<code>#if defined(STM32F40_41xxx)</code></li>
<li>配置<code>PLL_M</code>由<code>25</code>改为<code>8</code></li>
<li>配置<code>PLL_N</code>保持为<code>336</code></li>
<li>配置<code>PLL_P</code>保持为<code>2</code></li>
</ol>
<p>打开<code>stm32f4xx.h</code>中定义<code>HSE_VALUE</code><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HSE_VALUE 8000000</span></span><br></pre></td></tr></table></figure></p>
<h2 id="USB"><a href="#USB" class="headerlink" title="USB"></a>USB</h2><h3 id="USB-协议"><a href="#USB-协议" class="headerlink" title="USB 协议"></a>USB 协议</h3><p><a href="https://blog.csdn.net/songze_lee/article/details/77658094" target="_blank" rel="noopener">USB 协议</a><br><a href="https://blog.csdn.net/u014647208/article/details/79994473" target="_blank" rel="noopener">设备枚举</a></p>
<h4 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h4><p>物理层上，USB协议采用差分信号，使用两个数据线<code>D+</code>和<code>D-</code>。</p>
<p>(VOH&gt;2.8V, VOL&lt;0.3V)<br>信号 1, J状态：<code>D+&gt;VOH, D-&lt;VOL</code>  <code>(D+ = 1, D- = 0)</code><br>信号 0, K状态：<code>D+&lt;VOL, D-&gt;VOH</code>  <code>(D+ = 0, D- = 1)</code><br>Reset：<code>D+&lt;VOL, D-&lt;VOL, time&gt;10ms</code>  <code>(D+ = 0, D- = 0)</code><br>SE0状态：<code>(D+ = 0, D- = 1)</code><br>IDLE状态：空闲状态<br>Suspend：J状态保存3ms以上<br>SYNC：3个K J切换后跟随两位时间的K状态<br>Resume：20ms的K状态+低速EOP<br>SOP：从IDLE切换到K状态<br>EOP：持续2位时间的SE0信号，后跟随一位时间的J状态<br>Keep alive：低速EOP信号</p>
<p>主机通过设备在D+或D-上的1.5K上拉来检测设备的连接和断开事件，并由此判别设备的速度。</p>
<p>低速设备：<code>D-</code>被上拉。<br>高速，全速设备：<code>D+</code>被上拉。主机先把高速设备检测为全速设备，然后再通过“Chirp序列”的总线握手机制来识别高速和全速设备</p>
<h4 id="USB-连接与断开"><a href="#USB-连接与断开" class="headerlink" title="USB 连接与断开"></a>USB 连接与断开</h4><p>在连接时，当主机检测到某一个数据线电平拉高并保持了一段时间，就认为有设备连上来了。主机必需在驱动SE0状态以复位设备之前，立刻采样总线状态来判断设备的速度。</p>
<p>在断开时，HOST端的D+和D-数据线上的下拉电阻起作用，使得二者都在低电平，主机端看来就是个SE0状态。当数据线上的SE0状态持续一段时间了，就被主机认为是断开状态。</p>
<h4 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h4><p>USB采用NRZI（非归零编码）对发送的数据包进行编码：<br>输入数据0， 编码成“电平翻转”<br>输入数据1， 编码成“电平不变”</p>
<p>数据流中每6个连续的“1”，就要插入1个“0”，从而保证编码。接收方赋值解码NRZI码流，然后识别出填充位，并丢弃它们。</p>
<h4 id="USB-传输"><a href="#USB-传输" class="headerlink" title="USB 传输"></a>USB 传输</h4><p>传输又分为四种类型：批量传输、等时(同步)传输、中断传输、控制传输。USB传输数据先发数据低位再发高位数据。</p>
<p>一个传输有多个事务组成，一个事务由2或3个包组成。</p>
<h4 id="包"><a href="#包" class="headerlink" title="包"></a>包</h4><p>Packet分四大类： 命令 (Token) 、Packet 帧首 (Start of Frame) 、Packet 数据 (Data) 、Packet 握手 (Handshake) </p>
<p>包的组成：</p>
<ul>
<li>SOP</li>
<li>SYNC</li>
<li>Packet Content<ul>
<li>PID：PID4~7是PID0~4的取反，用来校验PID。</li>
<li>地址：设备地址和端点地址，设备地址7位，端点地址4位。</li>
<li>帧号：11位，主机发出一个帧，帧号+1。达到7FFH时重新计数。</li>
<li>数据：长度从0到1024Byte不等。</li>
<li>CRC</li>
</ul>
</li>
<li>EOP</li>
</ul>
<table>
<thead>
<tr>
<th>PID 类型</th>
<th>PID 名称</th>
<th>Package 种类</th>
</tr>
</thead>
<tbody>
<tr>
<td>Token 令牌</td>
<td>OUT/INT/SETUP/SOF</td>
<td>令牌包，帧首包</td>
</tr>
<tr>
<td>Data 数据</td>
<td>DATA0/DATA1/DATA2/MDATA</td>
<td>数据包</td>
</tr>
<tr>
<td>Handshake 握手</td>
<td>ACK/NAK/STALL/NYET</td>
<td>握手包</td>
</tr>
<tr>
<td>Special 特殊</td>
<td>PRE/ERR/SPLIT/PING</td>
<td>无</td>
</tr>
</tbody>
</table>
<p><img src="/2020/02/12/Hardware_IOT/STM32/usb-pid.png" alt="USB PID"></p>
<p>令牌包：用来启动一次USB传输。没有帧号和数据部分。</p>
<p>输出（OUT）令牌包：用来通知设备将要输出一个数据包<br>输入（IN）令牌包：用来通知设备返回一个数据包<br>建立（SETUP）令牌包：只用在控制传输中，和输出令牌包作用一样，也是通知设备将要输出一个数据包，两者区别在于:<br>SETUP令牌包后只使用DATA0数据包，且只能发送到设备的控制端点，并且设备必须要接收，而OUT令牌包没有这些限制</p>
<p>帧起始包：在每帧（或微帧）开始时发送，以广播的形式发送，所有USB全速设备和高速设备都可以接收到SOF包。没有地址和数据部分。</p>
<p>数据包：没有地址和帧号。</p>
<p>握手包：只有PID部分。</p>
<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>事务可分为3类：<br>Setup transaction：主机用来向设备发送控制命令<br>Data IN transaction：主机用来从设备读取数据<br>Data OUT transaction：主机用来向设备发送数据 </p>
<p>包组成：<br>Token packet：总是由主机发出<br>Data packet：包含此次transaction的数据负载 </p>
<h4 id="传输"><a href="#传输" class="headerlink" title="传输"></a>传输</h4><p>四种传输类型：</p>
<p>批量(大容量数据)传输(Bulk Transfers): 非周期性，突发<br>大容量数据的通信，数据可以占用任意带宽，并容忍延迟 。如USB打印机、扫描仪、大容量储存设备等 </p>
<p>中断传输(Interrupt Transfers): 周期性，低频率<br>允许有限延迟的通信 如人机接口设备（HID）中的鼠标、键盘、轨迹球等</p>
<p>等时(同步)传输(Isochronous Transfers): 周期性<br>持续性的传输，用于传输与时效相关的信息，并且在数据中保存时间戳的信息 ,如音频视频设备</p>
<p>控制传输(Control Transfers): 非周期性，突发<br>用于命令和状态的传输</p>
<h5 id="批量传输"><a href="#批量传输" class="headerlink" title="批量传输"></a>批量传输</h5><p>批量输出事务</p>
<p>(1)主机先发出一个OUT令牌包（包含设备地址，端点号）</p>
<p>(2)然后再发送一个DATA包，这时地址和端点匹配的设备就会收下这个数据包，主机切换到接收模式，等待设备返回握手包</p>
<p>（3）设备解码令牌包，数据包都准确无误，并且有足够的缓冲区来保存数据后就会使用ACK/NYET握手包来应答主机（只有高速模式才有NYET握手包，他表示本次数据成功接收，但是没有能力接收下一次传输），如果没有足够的缓冲区来保存数据，就返回NAC，告诉主机目前没有缓冲区可用，主机会在稍后时间重新该批量传输事务。如果设备检查到数据正确，但端点处于挂起状态，返回STALL。如果检测到有错误（如校验错误，位填充错误），则不做任何响应，让主机等待超时。</p>
<p>批量输入事务</p>
<p>(1)主机首先发送一个IN令牌包（包含设备地址，端点号）</p>
<p>（2）主机切换到接收数据状态等待设备返回数据。如果设备检测到错误，不做任何响应，主机等待超时。如果此时有地址和端点匹配的设备，并且没有检测到错误，则该设备作出反应：设备有数据需要返回，就将一个数据包放在总线上；如果没有数据需要返回，设备返回NAK响应主机；如果该端点处于挂起状态，设备返回STALL。如果主机收到设备发送的数据包并解码正确后，使用ACK握手包应答设备。如果主机检测到错误，则不做任何响应，设备会检测到超时。注意：USB协议规定，不允许主机使用NAK来拒绝接收数据包。主机收到NAK，知道设备暂时没有数据返回，主机会在稍后时间重新该批量输入事务。</p>
<p>PING令牌包</p>
<p>不发送数据，直到等待设备的握手包。</p>
<h5 id="中断传输"><a href="#中断传输" class="headerlink" title="中断传输"></a>中断传输</h5><p>中断传输是一种保证查询频率的传输。中断端点在端点描述符中要报告它的查询间隔，主机会保证在小于这个时间间隔的范围内安排一次传输。</p>
<h5 id="等时传输"><a href="#等时传输" class="headerlink" title="等时传输"></a>等时传输</h5><p>等时（同步）传输用在数据量大、对实时性要求高的场合，如音频设备，视频设备等，这些设备对数据的延迟很敏感。对于音频或视频设备数据的100%正确性要求不高，少量的数据错误是可以容忍的，主要是保证数据不能停顿，所以等时传输是不保证数据100%正确的。当数据错误时，不再重传操作。因此等时传输没有应答包，数据是否正确，由数据的CRC校验来确认。</p>
<h5 id="控制传输"><a href="#控制传输" class="headerlink" title="控制传输"></a>控制传输</h5><p>控制传输可分为三个过程：<br>（1）建立过程<br>（2）数据过程（可选）<br>（3）状态过程</p>
<p>每个USB设备都必须有控制端点，支持控制传输来进行命令和状态的传输。USB主机驱动将通过控制传输与USB设备的控制端点通信，完成USB设备的枚举和配置</p>
<p>控制传输是双向的传输，必须有IN和OUT两个方向上的特定端点号的控制端点来完成两个方向上的控制传输 </p>
<h4 id="USB-标准请求"><a href="#USB-标准请求" class="headerlink" title="USB 标准请求"></a>USB 标准请求</h4><p>标准请求结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">请求类型：</span></span><br><span class="line"><span class="comment">D7：数据传输方向，0 Host -&gt; Device, 1 Device -&gt; Host</span></span><br><span class="line"><span class="comment">D65：请求类型，0 标准，1 类，2 厂商，3 保留</span></span><br><span class="line"><span class="comment">D43210：请求的接收者，0 设备，1 接口，2 端点，3 其他，其余保留</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">u8  bmRequestType;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求代码</span></span><br><span class="line">u8  bRequest;</span><br><span class="line">u16 wValue;</span><br><span class="line">u16 wIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据过程所需传输的字节数</span></span><br><span class="line">u16 wLength;</span><br></pre></td></tr></table></figure>
<p>请求代码<code>bRequest</code>枚举：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET_STATUS      = <span class="number">0</span>,</span><br><span class="line">CLEAR_FEATURE   = <span class="number">1</span>,</span><br><span class="line">SET_FEATURE     = <span class="number">3</span>,</span><br><span class="line">SET_ADDRESS     = <span class="number">5</span>,</span><br><span class="line">GET_DESCRIPTOR  = <span class="number">6</span>,</span><br><span class="line">SET_DESCRIPTOR  = <span class="number">7</span>,</span><br><span class="line">GET_CONFIGURATION  = <span class="number">8</span>,</span><br><span class="line">SET_CONFIGURATION  = <span class="number">9</span>,</span><br><span class="line">GET_INTERFACE   = <span class="number">10</span>,</span><br><span class="line">SET_INTERFACE   = <span class="number">11</span>,</span><br><span class="line">SYNCH_FRAME     = <span class="number">12</span></span><br></pre></td></tr></table></figure></p>
<h4 id="设备枚举和描述符"><a href="#设备枚举和描述符" class="headerlink" title="设备枚举和描述符"></a>设备枚举和描述符</h4><p>当一个USB设备插入主机后，会有以下活动：</p>
<ul>
<li>供电</li>
<li>复位</li>
<li>获取设备描述符前8 Bytes</li>
<li>复位</li>
<li>分配地址</li>
<li>获取设备描述符</li>
<li>获取Configuration Descriptor</li>
<li>获取String Descriptor</li>
<li>配置</li>
</ul>
<p>配置描述符：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_config_descriptor</span> &#123;</span></span><br><span class="line">    __u8  bLength;</span><br><span class="line">    __u8  bDescriptorType;</span><br><span class="line"> </span><br><span class="line">    __le16 wTotalLength;</span><br><span class="line">    __u8  bNumInterfaces;</span><br><span class="line">    __u8  bConfigurationValue;</span><br><span class="line">    __u8  iConfiguration;</span><br><span class="line">    __u8  bmAttributes;</span><br><span class="line">    __u8  bMaxPower;</span><br><span class="line">&#125; __attribute__ ((packed));</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USB_DT_CONFIG_SIZE        9</span></span><br></pre></td></tr></table></figure></p>
<p>接口描述符：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_interface_descriptor</span> &#123;</span></span><br><span class="line">    __u8  bLength;</span><br><span class="line">    __u8  bDescriptorType;</span><br><span class="line"> </span><br><span class="line">    __u8  bInterfaceNumber;</span><br><span class="line">    __u8  bAlternateSetting;</span><br><span class="line">    __u8  bNumEndpoints;</span><br><span class="line">    __u8  bInterfaceClass;</span><br><span class="line">    __u8  bInterfaceSubClass;</span><br><span class="line">    __u8  bInterfaceProtocol;</span><br><span class="line">    __u8  iInterface;</span><br><span class="line">&#125; __attribute__ ((packed));</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USB_DT_INTERFACE_SIZE        9</span></span><br></pre></td></tr></table></figure></p>
<p>类描述符：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_device_descriptor</span> &#123;</span></span><br><span class="line">    __u8  bLength;</span><br><span class="line">    __u8  bDescriptorType;</span><br><span class="line"> </span><br><span class="line">    __le16 bcdUSB;</span><br><span class="line">    __u8  bDeviceClass;</span><br><span class="line">    __u8  bDeviceSubClass;</span><br><span class="line">    __u8  bDeviceProtocol;</span><br><span class="line">    __u8  bMaxPacketSize0;</span><br><span class="line">    __le16 idVendor;</span><br><span class="line">    __le16 idProduct;</span><br><span class="line">    __le16 bcdDevice;</span><br><span class="line">    __u8  iManufacturer;</span><br><span class="line">    __u8  iProduct;</span><br><span class="line">    __u8  iSerialNumber;</span><br><span class="line">    __u8  bNumConfigurations;</span><br><span class="line">&#125; __attribute__ ((packed));</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USB_DT_DEVICE_SIZE        18</span></span><br></pre></td></tr></table></figure></p>
<p>端点描述符：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_endpoint_descriptor</span> &#123;</span></span><br><span class="line">    __u8  bLength;</span><br><span class="line">    __u8  bDescriptorType;</span><br><span class="line"> </span><br><span class="line">    __u8  bEndpointAddress;</span><br><span class="line">    __u8  bmAttributes;</span><br><span class="line">    __le16 wMaxPacketSize;</span><br><span class="line">    __u8  bInterval;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* <span class="doctag">NOTE:</span>  these two are _only_ in audio endpoints. */</span></span><br><span class="line">    <span class="comment">/* use USB_DT_ENDPOINT*_SIZE in bLength, not sizeof. */</span></span><br><span class="line">    __u8  bRefresh;</span><br><span class="line">    __u8  bSynchAddress;</span><br><span class="line">&#125; __attribute__ ((packed));</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USB_DT_ENDPOINT_SIZE        7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Audio extension */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USB_DT_ENDPOINT_AUDIO_SIZE    9</span></span><br></pre></td></tr></table></figure></p>
<p>字符串描述符：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_string_descriptor</span> &#123;</span></span><br><span class="line">    __u8  bLength;</span><br><span class="line">    __u8  bDescriptorType;</span><br><span class="line"> </span><br><span class="line">    __le16 wData[<span class="number">1</span>];        <span class="comment">/* UTF-16LE encoded */</span></span><br><span class="line">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure></p>
<p>在STM32的代码中，USB配置描述符，接口描述符，端点描述符这3个被整合为一个USB描述符，然后还是叫做USB配置描述符。例如（使用USB复合设备）：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* All Descriptors (配置描述符, 接口描述符, 端点描述符, 类描述符 */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> Composite_ConfigDescriptor[CUSTOMHID_SIZ_CONFIG_DESC] =</span><br><span class="line">&#123;</span><br><span class="line">  配置描述符   <span class="comment">//Configuration Descriptor 只能有1个</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*功能1——VCP虚拟串口接口*/</span></span><br><span class="line">  IAD描述符    <span class="comment">//复合设备才有 在单接口的设备这个可以不要</span></span><br><span class="line">  接口<span class="number">1</span>描述符   <span class="comment">//Interface Descriptor</span></span><br><span class="line">  类描述符    <span class="comment">//Class Desdriptor</span></span><br><span class="line">  端点描述符  <span class="comment">//Endpoint Descriptor</span></span><br><span class="line">  </span><br><span class="line">  接口<span class="number">2</span>描述符   <span class="comment">//Interface Descriptor</span></span><br><span class="line">  类描述符    <span class="comment">//Class Desdriptor</span></span><br><span class="line">  端点描述符  <span class="comment">//Endpoint Descriptor</span></span><br><span class="line">  端点描述符  <span class="comment">//Endpoint Descriptor如果此接口有多个端点，可接着添加端点描述符</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*如果有多个接口 下面还可以继续添加以下描述符*/</span></span><br><span class="line">  <span class="comment">/*功能2——HID键盘*/</span></span><br><span class="line">  IAD描述符    <span class="comment">//复合设备才有 在单接口的设备这个可以不要</span></span><br><span class="line">  接口描述符   <span class="comment">//Interface Descriptor</span></span><br><span class="line">  类描述符    <span class="comment">//Class Desdriptor</span></span><br><span class="line">  端点描述符  <span class="comment">//Endpoint Descriptor</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*如果有多个接口 下面还可以继续添加以下描述符*/</span></span><br><span class="line">  <span class="comment">/*接口3 */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> Composite_ConfigDescriptor[CUSTOMHID_SIZ_CONFIG_DESC] =</span><br><span class="line">&#123;</span><br><span class="line">     <span class="number">0x09</span>, <span class="comment">/* bLength: Configuration Descriptor size */</span></span><br><span class="line">    USB_CONFIGURATION_DESCRIPTOR_TYPE, <span class="comment">/* bDescriptorType: Configuration */</span></span><br><span class="line">    CUSTOMHID_SIZ_CONFIG_DESC,</span><br><span class="line">    <span class="comment">/* wTotalLength: Bytes returned */</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x03</span>,         <span class="comment">/* bNumInterfaces: 3 interface 共3个接口 CDC 2个 HID一个*/</span></span><br><span class="line">    <span class="number">0x01</span>,         <span class="comment">/* bConfigurationValue: Configuration value */</span></span><br><span class="line">    <span class="number">0x00</span>,         <span class="comment">/* iConfiguration: Index of string descriptor describing</span></span><br><span class="line"><span class="comment">                                 the configuration*/</span></span><br><span class="line">    <span class="number">0xC0</span>,         <span class="comment">/* bmAttributes: Self powered */</span></span><br><span class="line">    <span class="number">0x32</span>,         <span class="comment">/* MaxPower 100 mA: this current is used for detecting Vbus */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*************************************功能1 HID键盘**************************************/</span></span><br><span class="line">    <span class="comment">/*IAD描述符*/</span></span><br><span class="line">    <span class="number">0x08</span>,   <span class="comment">//bLength：IAD描述符大小 </span></span><br><span class="line">    <span class="number">0x0B</span>,   <span class="comment">//bDescriptorType：IAD描述符类型</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">//bFirstInterface：功能1 HID键盘的第一个接口描述符是在总的配置描述符中的第几个从0开始数</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">//bInferfaceCount：功能1 HID键盘有1个接口描述符</span></span><br><span class="line">    <span class="number">0x03</span>,   <span class="comment">//bFunctionClass：同单HID功能时，设备符中的bDeviceClass</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">//bFunctionSubClass：同单HID功能时，设备符中的bDeviceSubClass</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">//bFunctionProtocol：同单HID功能时，设备符中的bDeviceProtocol</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">//iFunction：字符串描述中关于此设备的索引(个人理解是一个字符串描述符中有比如0~5是功能1的字符串，</span></span><br><span class="line">            <span class="comment">//6~10是功能2的字符串,如果是功能2的话，此值为6)</span></span><br><span class="line">    </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/************** Descriptor of Custom HID interface ****************/</span></span><br><span class="line">    <span class="comment">/* 09 */</span></span><br><span class="line">    <span class="number">0x09</span>,         <span class="comment">/* bLength: Interface Descriptor size */</span></span><br><span class="line">    USB_INTERFACE_DESCRIPTOR_TYPE,<span class="comment">/* bDescriptorType: Interface descriptor type */</span></span><br><span class="line">    <span class="number">0x00</span>,         <span class="comment">/* bInterfaceNumber: Number of Interface */</span> <span class="comment">//&lt;接口 0&gt;</span></span><br><span class="line">    <span class="number">0x00</span>,         <span class="comment">/* bAlternateSetting: Alternate setting */</span></span><br><span class="line">    <span class="number">0x02</span>,         <span class="comment">/* bNumEndpoints */</span></span><br><span class="line">    <span class="number">0x03</span>,         <span class="comment">/* bInterfaceClass: HID */</span></span><br><span class="line">    <span class="number">0x01</span>,         <span class="comment">/* bInterfaceSubClass : 1=BOOT, 0=no boot */</span></span><br><span class="line">    <span class="number">0x01</span>,         <span class="comment">/* nInterfaceProtocol : 0=none, 1=keyboard, 2=mouse */</span></span><br><span class="line">    <span class="number">0</span>,            <span class="comment">/* iInterface: Index of string descriptor */</span></span><br><span class="line">    <span class="comment">/******************** Descriptor of Custom HID HID ********************/</span></span><br><span class="line">    <span class="comment">/* 18 */</span></span><br><span class="line">    <span class="number">0x09</span>,         <span class="comment">/* bLength: HID Descriptor size */</span></span><br><span class="line">    HID_DESCRIPTOR_TYPE, <span class="comment">/* bDescriptorType: HID */</span></span><br><span class="line">    <span class="number">0x10</span>,         <span class="comment">/* bcdHID: HID Class Spec release number */</span></span><br><span class="line">    <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">0x00</span>,         <span class="comment">/* bCountryCode: Hardware target country */</span></span><br><span class="line">    <span class="number">0x01</span>,         <span class="comment">/* bNumDescriptors: Number of HID class descriptors to follow */</span></span><br><span class="line">    <span class="number">0x22</span>,         <span class="comment">/* bDescriptorType */</span></span><br><span class="line">    CUSTOMHID_SIZ_REPORT_DESC,</span><br><span class="line">    <span class="comment">//KEYBOARD_SIZ_REPORT_DESC,/* wItemLength: Total length of Report descriptor */</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">/******************** Descriptor of Custom HID endpoints ******************/</span></span><br><span class="line">    <span class="comment">/* 27 */</span></span><br><span class="line">    <span class="number">0x07</span>,          <span class="comment">/* bLength: Endpoint Descriptor size */</span></span><br><span class="line">    USB_ENDPOINT_DESCRIPTOR_TYPE, <span class="comment">/* bDescriptorType: */</span></span><br><span class="line">    <span class="number">0x84</span>,          <span class="comment">/* bEndpointAddress: Endpoint Address (IN) */</span></span><br><span class="line">    <span class="number">0x03</span>,          <span class="comment">/* bmAttributes: Interrupt endpoint */</span></span><br><span class="line">    <span class="number">0x08</span>,          <span class="comment">/* wMaxPacketSize: 8 Bytes max */</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x20</span>,          <span class="comment">/* bInterval: Polling Interval (32 ms) */</span></span><br><span class="line">    <span class="comment">/* 34 */</span>	</span><br><span class="line">    <span class="number">0x07</span>,	<span class="comment">/* bLength: Endpoint Descriptor size */</span></span><br><span class="line">    USB_ENDPOINT_DESCRIPTOR_TYPE,	<span class="comment">/* bDescriptorType: */</span></span><br><span class="line">    <span class="number">0x04</span>,	<span class="comment">/* bEndpointAddress:Endpoint Address (OUT) */</span></span><br><span class="line">    <span class="number">0x03</span>,	<span class="comment">/* bmAttributes: Interrupt endpoint */</span></span><br><span class="line">    <span class="number">0x01</span>,	<span class="comment">/* wMaxPacketSize: 1 Bytes max  */</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x20</span>,	<span class="comment">/* bInterval: Polling Interval (20 ms) */</span></span><br><span class="line">    <span class="comment">/* 41 */</span></span><br><span class="line">    <span class="comment">/********************************功能2 VCP虚拟串口*****************************/</span></span><br><span class="line">    <span class="comment">/*IAD描述符*/</span></span><br><span class="line">    <span class="comment">/* Interface Association Descriptor(IAD Descriptor)  */</span> </span><br><span class="line">    <span class="number">0x08</span>,   <span class="comment">/*  bLength  */</span></span><br><span class="line">    <span class="number">0x0B</span>,   <span class="comment">/*  bDescriptorType*/</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/*  bFirstInterface*/</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/*  bInterfaceCount*/</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/*  bFunctionClass --CDC*/</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/*  bFunctionSubClass*/</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/*  bFunctionProtocoll*/</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/*  iFunction */</span></span><br><span class="line">    </span><br><span class="line">     <span class="comment">/**VCP虚拟串口**/</span></span><br><span class="line">    <span class="comment">/*Interface Descriptor接口描述符*/</span></span><br><span class="line">    <span class="number">0x09</span>,   <span class="comment">/* bLength: Interface Descriptor size */</span></span><br><span class="line">    USB_INTERFACE_DESCRIPTOR_TYPE,  <span class="comment">/* bDescriptorType: Interface */</span></span><br><span class="line">    <span class="comment">/* Interface descriptor type */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* bInterfaceNumber: Number of Interface */</span>   <span class="comment">//&lt;接口 1&gt;</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bAlternateSetting: Alternate setting */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* bNumEndpoints: One endpoints used 该接口非0端点数*/</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bInterfaceClass: Communication Interface Class */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bInterfaceSubClass: Abstract Control Model */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* bInterfaceProtocol: Common AT commands */</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* iInterface: */</span></span><br><span class="line">    <span class="comment">/*Header Functional Descriptor类描述符*/</span></span><br><span class="line">    <span class="number">0x05</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></span><br><span class="line">    <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bDescriptorSubtype: Header Func Desc */</span></span><br><span class="line">    <span class="number">0x10</span>,   <span class="comment">/* bcdCDC: spec release number */</span></span><br><span class="line">    <span class="number">0x01</span>,</span><br><span class="line">    <span class="comment">/*Call Management Functional Descriptor*/</span></span><br><span class="line">    <span class="number">0x05</span>,   <span class="comment">/* bFunctionLength */</span></span><br><span class="line">    <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* bDescriptorSubtype: Call Management Func Desc */</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bmCapabilities: D0+D1 */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* bDataInterface: 1 */</span></span><br><span class="line">    <span class="comment">/*ACM Functional Descriptor*/</span></span><br><span class="line">    <span class="number">0x04</span>,   <span class="comment">/* bFunctionLength */</span></span><br><span class="line">    <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bDescriptorSubtype: Abstract Control Management desc */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bmCapabilities */</span></span><br><span class="line">    <span class="comment">/*Union Functional Descriptor*/</span></span><br><span class="line">    <span class="number">0x05</span>,   <span class="comment">/* bFunctionLength */</span></span><br><span class="line">    <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></span><br><span class="line">    <span class="number">0x06</span>,   <span class="comment">/* bDescriptorSubtype: Union func desc */</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bMasterInterface: Communication class interface */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* bSlaveInterface0: Data Class Interface */</span></span><br><span class="line">    <span class="comment">/*Endpoint 2 Descriptor端点描述符*/</span></span><br><span class="line">    <span class="number">0x07</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></span><br><span class="line">    USB_ENDPOINT_DESCRIPTOR_TYPE,   <span class="comment">/* bDescriptorType: Endpoint */</span></span><br><span class="line">    <span class="number">0x82</span>,   <span class="comment">/* bEndpointAddress: (IN2) */</span></span><br><span class="line">    <span class="number">0x03</span>,   <span class="comment">/* bmAttributes: Interrupt */</span></span><br><span class="line">    VIRTUAL_COM_PORT_INT_SIZE,      <span class="comment">/* wMaxPacketSize: */</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xFF</span>,   <span class="comment">/* bInterval: */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*Data class interface descriptor类描述符*/</span></span><br><span class="line">    <span class="number">0x09</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></span><br><span class="line">    USB_INTERFACE_DESCRIPTOR_TYPE,  <span class="comment">/* bDescriptorType: */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bInterfaceNumber: Number of Interface */</span><span class="comment">//&lt;接口 2&gt;</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bAlternateSetting: Alternate setting */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bNumEndpoints: Two endpoints used */</span></span><br><span class="line">    <span class="number">0x0A</span>,   <span class="comment">/* bInterfaceClass: CDC */</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bInterfaceSubClass: */</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bInterfaceProtocol: */</span></span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* iInterface: */</span></span><br><span class="line">    <span class="comment">/*Endpoint 3 Descriptor端点描述符*/</span></span><br><span class="line">    <span class="number">0x07</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></span><br><span class="line">    USB_ENDPOINT_DESCRIPTOR_TYPE,   <span class="comment">/* bDescriptorType: Endpoint */</span></span><br><span class="line">    <span class="number">0x03</span>,   <span class="comment">/* bEndpointAddress: (OUT3) */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bmAttributes: Bulk */</span></span><br><span class="line">    VIRTUAL_COM_PORT_DATA_SIZE,             <span class="comment">/* wMaxPacketSize: */</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,   <span class="comment">/* bInterval: ignore for Bulk transfer */</span></span><br><span class="line">    <span class="comment">/*Endpoint 1 Descriptor 端点描述符*/</span></span><br><span class="line">    <span class="number">0x07</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></span><br><span class="line">    USB_ENDPOINT_DESCRIPTOR_TYPE,   <span class="comment">/* bDescriptorType: Endpoint */</span></span><br><span class="line">    <span class="number">0x81</span>,   <span class="comment">/* bEndpointAddress: (IN1) */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* bmAttributes: Bulk */</span></span><br><span class="line">    VIRTUAL_COM_PORT_DATA_SIZE,             <span class="comment">/* wMaxPacketSize: */</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>    <span class="comment">/* bInterval */</span></span><br><span class="line">&#125;; <span class="comment">/* CustomHID_ConfigDescriptor */</span></span><br></pre></td></tr></table></figure></p>
<p>另外，对于HID设备还要有报告描述符。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> CustomHID_ReportDescriptor[CUSTOMHID_SIZ_REPORT_DESC] =</span><br><span class="line">  &#123;       </span><br><span class="line"><span class="comment">//0x05:0000 01 01 这是个全局条目，用途页选择为普通桌面页</span></span><br><span class="line">	<span class="number">0x05</span>, <span class="number">0x01</span>, <span class="comment">// USAGE_PAGE (Generic Desktop)</span></span><br><span class="line">	<span class="comment">//0x09:0000 10 01 这是个全局条目，用途选择为键盘</span></span><br><span class="line">	<span class="number">0x09</span>, <span class="number">0x06</span>, <span class="comment">// USAGE (Keyboard)</span></span><br><span class="line">	<span class="comment">//0xa1:1010 00 01 这是个主条目，选择为应用集合，</span></span><br><span class="line">	<span class="number">0xa1</span>, <span class="number">0x01</span>, <span class="comment">// COLLECTION (Application)</span></span><br><span class="line">	<span class="comment">//0x05:0000 01 11 这是个全局条目，用途页选择为键盘/按键</span></span><br><span class="line">	<span class="number">0x05</span>, <span class="number">0x07</span>, <span class="comment">// USAGE_PAGE (Keyboard/Keypad)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//0x19:0001 10 01 这是个局部条目，用途的最小值为0xe0，对应键盘上的左ctrl键</span></span><br><span class="line">	<span class="number">0x19</span>, <span class="number">0xe0</span>, <span class="comment">// USAGE_MINIMUM (Keyboard LeftControl)</span></span><br><span class="line">	<span class="comment">//0x29:0010 10 01 这是个局部条目，用途的最大值为0xe7，对应键盘上的有GUI(WIN)键</span></span><br><span class="line">	<span class="number">0x29</span>, <span class="number">0xe7</span>, <span class="comment">// USAGE_MAXIMUM (Keyboard Right GUI)</span></span><br><span class="line">	<span class="comment">//0x15:0001 01 01 这是个全局条目，说明数据的逻辑值最小值为0</span></span><br><span class="line">	<span class="number">0x15</span>, <span class="number">0x00</span>, <span class="comment">// LOGICAL_MINIMUM (0)</span></span><br><span class="line">	<span class="comment">//0x25:0010 01 01 这是个全局条目，说明数据的逻辑值最大值为1</span></span><br><span class="line">	<span class="number">0x25</span>, <span class="number">0x01</span>, <span class="comment">// LOGICAL_MAXIMUM (1)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//0x95:1001 01 01 这是个全局条目，数据域的数量为8个</span></span><br><span class="line">	<span class="number">0x95</span>, <span class="number">0x08</span>, <span class="comment">// REPORT_COUNT (8)</span></span><br><span class="line">	<span class="comment">//0x75:0111 01 01 这是个全局条目，每个数据域的长度为1位</span></span><br><span class="line">	<span class="number">0x75</span>, <span class="number">0x01</span>, <span class="comment">// REPORT_SIZE (1)	   </span></span><br><span class="line">	<span class="comment">//0x81:1000 00 01 这是个主条目，有8*1bit数据域作为输入，属性为:Data,Var,Abs</span></span><br><span class="line">	<span class="number">0x81</span>, <span class="number">0x02</span>, <span class="comment">// INPUT (Data,Var,Abs)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//0x95:1001 01 01 这是个全局条目,数据域的数量为1个</span></span><br><span class="line">	<span class="number">0x95</span>, <span class="number">0x01</span>, <span class="comment">// REPORT_COUNT (1)</span></span><br><span class="line">	<span class="comment">//0x75:0111 01 01 这是个全局条目，每个数据域的长度为8位</span></span><br><span class="line">	<span class="number">0x75</span>, <span class="number">0x08</span>, <span class="comment">// REPORT_SIZE (8)</span></span><br><span class="line">	<span class="comment">//0x81:1000 00 01 这是个主条目，有1*8bit数据域作为输入，属性为:Cnst,Var,Abs</span></span><br><span class="line">	<span class="number">0x81</span>, <span class="number">0x03</span>, <span class="comment">// INPUT (Cnst,Var,Abs)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//0x95:1001 01 01 这是个全局条目，数据域的数量为6个</span></span><br><span class="line">	<span class="number">0x95</span>, <span class="number">0x06</span>, <span class="comment">// REPORT_COUNT (6)</span></span><br><span class="line">	<span class="comment">//0x75:0111 01 01 这是个全局条目，每个数据域的长度为8位</span></span><br><span class="line">	<span class="number">0x75</span>, <span class="number">0x08</span>, <span class="comment">// REPORT_SIZE (8)</span></span><br><span class="line">	<span class="comment">//0x25:0010 01 01 这是个全局条目，逻辑最大值为255</span></span><br><span class="line">	<span class="number">0x25</span>, <span class="number">0xFF</span>, <span class="comment">// LOGICAL_MAXIMUM (255)</span></span><br><span class="line">	<span class="comment">//0x19:0001 10 01 这是个局部条目，用途的最小值为0</span></span><br><span class="line">	<span class="number">0x19</span>, <span class="number">0x00</span>, <span class="comment">// USAGE_MINIMUM (Reserved (no event indicated))</span></span><br><span class="line">	<span class="comment">//0x29:0010 10 01 这是个局部条目，用途的最大值为0x65</span></span><br><span class="line">	<span class="number">0x29</span>, <span class="number">0x65</span>, <span class="comment">// USAGE_MAXIMUM (Keyboard Application)</span></span><br><span class="line">	<span class="comment">//0x81:1000 00 01 这是个主条目，有6*8bit的数据域作为输入，属相为属性为:Data,Var,Abs</span></span><br><span class="line">	<span class="number">0x81</span>, <span class="number">0x00</span>, <span class="comment">// INPUT (Data,Ary,Abs)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//0x25:0010 01 01 这是个全局条目，逻辑的最大值为1</span></span><br><span class="line">	<span class="number">0x25</span>, <span class="number">0x01</span>, <span class="comment">// LOGICAL_MAXIMUM (1)</span></span><br><span class="line">	<span class="comment">//0x95:1001 01 01 这是个全局条目，数据域的数量为2</span></span><br><span class="line">	<span class="number">0x95</span>, <span class="number">0x02</span>, <span class="comment">// REPORT_COUNT (2)</span></span><br><span class="line">	<span class="comment">//0x75:0111 01 01 这是个全局条目，每个数据域的长度为1位</span></span><br><span class="line">	<span class="number">0x75</span>, <span class="number">0x01</span>, <span class="comment">// REPORT_SIZE (1)</span></span><br><span class="line">	<span class="comment">//0x05:0000 01 01 这是个全局条目，用途页选择为LED页</span></span><br><span class="line">	<span class="number">0x05</span>, <span class="number">0x08</span>, <span class="comment">// USAGE_PAGE (LEDs)</span></span><br><span class="line">	<span class="comment">//0x19:0001 10 01 这是个局部条目，用途的最小值为0x01,对应键盘上的Num Lock</span></span><br><span class="line">	<span class="number">0x19</span>, <span class="number">0x01</span>, <span class="comment">// USAGE_MINIMUM (Num Lock)</span></span><br><span class="line">	<span class="comment">//0x29:0010 10 01 这是个局部条目，用途的最大值为0x02,对应键盘上的Caps Lock</span></span><br><span class="line">	<span class="number">0x29</span>, <span class="number">0x02</span>, <span class="comment">// USAGE_MAXIMUM (Caps Lock)</span></span><br><span class="line">	<span class="comment">//0x91:1001 00 01 这是个主条目，有2*1bit的数据域作为输出，属性为:Data,Var,Abs</span></span><br><span class="line">	<span class="number">0x91</span>, <span class="number">0x02</span>, <span class="comment">// OUTPUT (Data,Var,Abs)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//0x95:1001 01 01 这是个全局条目，数据域的数量为1个</span></span><br><span class="line">	<span class="number">0x95</span>, <span class="number">0x01</span>, <span class="comment">// REPORT_COUNT (1)</span></span><br><span class="line">	<span class="comment">//0x75:0111 01 01 这是个全局条目，每个数据域的长度为6bit,正好与前面的2bit组成1字节</span></span><br><span class="line">	<span class="number">0x75</span>, <span class="number">0x06</span>, <span class="comment">// REPORT_SIZE (6)</span></span><br><span class="line">	<span class="comment">//0x91:1001 00 01 这是个主条目，有1*6bit数据域最为输出，属性为:Cnst,Var,Abs</span></span><br><span class="line">	<span class="number">0x91</span>, <span class="number">0x03</span>, <span class="comment">// OUTPUT (Cnst,Var,Abs)</span></span><br><span class="line"></span><br><span class="line">	<span class="number">0xc0</span>        <span class="comment">// END_COLLECTION</span></span><br><span class="line"></span><br><span class="line">&#125;; <span class="comment">/* CustomHID_ReportDescriptor */</span></span><br></pre></td></tr></table></figure>
<h4 id="常见-USB-设备类"><a href="#常见-USB-设备类" class="headerlink" title="常见 USB 设备类"></a>常见 USB 设备类</h4><p>音频类（Audio）<br>通信设备类（CDC）<br>设备固件升级类（DFU）<br>人机接口类（HID）<br>大容量存储设备类（Mass Storage）</p>
<h3 id="USB-代码库结构"><a href="#USB-代码库结构" class="headerlink" title="USB 代码库结构"></a>USB 代码库结构</h3><p>usb_regs.c：操作USB控制寄存器。<br>usb_init.c：初始化USB控制器。<br>usb_int.c：处理中断。CTR_LP：负责USB低优先级中断的处理，CTR_HP：负责USB高优先级中断的处理。<br>usb_mem.c：处理PMA数据，是stm32内部用于USB/CAN的专用数据缓冲区。PMAToUserBufferCopy：将USB数据传送到主机UserToPMABufferCopy：将主机数据传送到USB。<br>usb_core.c：处理USB2.0协议。<br>usb_sil.c：为USB端点提供简化的读写访问函数。</p>
<p>hw_config.c：配置硬件，比如初始化USB时钟、USB中断、低功耗模式处理等。<br>usb_desc.c：处理描述符。<br>usb_endp.c：处理正确传输中断回调函数，用于非控制传输<br>usb_istr.c：处理USB中断<br>usb_prop.c：处理所有设备相关事件<br>usb_pwr.c：管理USB控制器的电源</p>
<h3 id="STM32F103-中使用-USB"><a href="#STM32F103-中使用-USB" class="headerlink" title="STM32F103 中使用 USB"></a>STM32F103 中使用 USB</h3><p>导入代码。</p>
<p>加入头文件<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hw_config.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usb_lib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usb_init.h"</span></span></span><br></pre></td></tr></table></figure></p>
<p>初始化USB<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重启 USB</span></span><br><span class="line">USB_Port_Set(<span class="number">0</span>); </span><br><span class="line">delay_ms(<span class="number">700</span>);</span><br><span class="line">USB_Port_Set(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 初始化 USB</span></span><br><span class="line">Set_USBClock(); </span><br><span class="line">USB_Interrupts_Config();</span><br><span class="line">USB_Init();</span><br></pre></td></tr></table></figure></p>
<h3 id="STM32F4-中导入USB-OTG开发包"><a href="#STM32F4-中导入USB-OTG开发包" class="headerlink" title="STM32F4 中导入USB-OTG开发包"></a>STM32F4 中导入USB-OTG开发包</h3><p>首先去官网下载最新的<a href>USB开发包</a>，将Libraries下的STM32_USB_Device_Library，STM32_USB_HOST_Library，STM32_USB_OTG_Driver三个文件夹拷贝到项目目录下。其中OTG_Driver是另外两个的基础驱动。在项目中，分别添加这三个目录下的Core文件到项目中，并从中提取以下文件单独放置到Config项目目录下。</p>
<ul>
<li>Device_Library\Core\inc\usbd_conf_template.h</li>
<li>HOST_Library\Core\inc\usbh_conf_template.h</li>
<li>OTG_Driver\Core\src\usb_bsp_template.h</li>
<li>OTG_Driver\Core\inc\usb_bsp_template.h</li>
<li>Device_Library\Class\cdc\src\usbd_cdc_if_template.c</li>
<li>Device_Library\Class\cdc\inc\usbd_cdc_if_template.h</li>
</ul>
<p>另外，到Project\USB_Device_Examples下找到VCP目录，复制如下文件到Config下</p>
<ul>
<li>inc\usb_conf.h</li>
<li>inc\usbd_cdc_vcp.h</li>
<li>inc\usbd_conf.h</li>
<li>inc\usbd_desc.h</li>
<li>src\app.c</li>
<li>src\usb_bsp.c</li>
<li>src\usbd_desc.c</li>
<li>src\usbd_usr.c</li>
</ul>
<p>更改为合适的名字后，等待下一步修改。</p>
<h4 id="USB-CONF-H"><a href="#USB-CONF-H" class="headerlink" title="USB_CONF.H"></a>USB_CONF.H</h4><p>打开开关</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USE_USB_OTG_FS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USE_HOST_MODE</span></span><br></pre></td></tr></table></figure>
<h4 id="USBD-CONF-H"><a href="#USBD-CONF-H" class="headerlink" title="USBD_CONF.H"></a>USBD_CONF.H</h4><p>定义<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_CFG_MAX_NUM           1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_ITF_MAX_NUM           4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USB_MAX_STR_DESC_SIZ       64 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_EP0_MAX_PACKET_SIZE   64</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_SELF_POWERED</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   VCP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CDC_IN_EP                       0x81  <span class="comment">/* EP1 for data IN */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CDC_OUT_EP                      0x01  <span class="comment">/* EP1 for data OUT */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CDC_CMD_EP                      0x82  <span class="comment">/* EP2 for CDC commands */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_USB_OTG_HS</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CDC_DATA_MAX_PACKET_SIZE       64   <span class="comment">/* Endpoint IN &amp; OUT Packet size */</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CDC_CMD_PACKET_SZE             8    <span class="comment">/* Control Endpoint Packet size */</span></span></span><br><span class="line"></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CDC_IN_FRAME_INTERVAL          40   <span class="comment">/* Number of micro-frames between IN transfers */</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> APP_RX_DATA_SIZE               2048 <span class="comment">/* Total size of IN buffer: </span></span></span><br><span class="line"><span class="meta"><span class="comment">                                                APP_RX_DATA_SIZE*8/MAX_BAUDARATE*1000 should be &gt; CDC_IN_FRAME_INTERVAL*8 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CDC_DATA_MAX_PACKET_SIZE       64   <span class="comment">/* Endpoint IN &amp; OUT Packet size */</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CDC_CMD_PACKET_SZE             8    <span class="comment">/* Control Endpoint Packet size */</span></span></span><br><span class="line"></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CDC_IN_FRAME_INTERVAL          5    <span class="comment">/* Number of frames between IN transfers */</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> APP_RX_DATA_SIZE               2048 <span class="comment">/* Total size of IN buffer: </span></span></span><br><span class="line"><span class="meta"><span class="comment">                                                APP_RX_DATA_SIZE*8/MAX_BAUDARATE*1000 should be &gt; CDC_IN_FRAME_INTERVAL */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_USB_OTG_HS */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> APP_FOPS                        VCP_fops</span></span><br></pre></td></tr></table></figure></p>
<h4 id="USB-DESC-C"><a href="#USB-DESC-C" class="headerlink" title="USB_DESC.C"></a>USB_DESC.C</h4><p>修改设备类型<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// USBD_DeviceDesc</span></span><br><span class="line"><span class="number">0x02</span>,                         <span class="comment">/* bDeviceClass */</span></span><br><span class="line"><span class="number">0x00</span>,                         <span class="comment">/* bDeviceSubClass */</span></span><br></pre></td></tr></table></figure></p>
<h4 id="USB-APP-C"><a href="#USB-APP-C" class="headerlink" title="USB_APP.C"></a>USB_APP.C</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">USBH_HOST  USB_Host;</span><br><span class="line">USB_OTG_CORE_HANDLE  USB_OTG_Core_dev; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OTG_FS_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   		    </span><br><span class="line">	<span class="keyword">if</span> (USB_OTG_IsHostMode(&amp;USB_OTG_Core_dev)) <span class="comment">//È·¶¨ÊÇ²»ÊÇUSBÖ÷»úÄ£Ê½?</span></span><br><span class="line">	&#123;  </span><br><span class="line">		USBH_OTG_ISR_Handler(&amp;USB_OTG_Core_dev);<span class="comment">//USBÖ÷»úÖÐ¶Ï</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		USBD_OTG_ISR_Handler(&amp;USB_OTG_Core_dev);<span class="comment">//USB´Ô»úÖÐ¶Ï</span></span><br><span class="line">	&#125;											 </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USBD_Configuration</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    USBD_Init(&amp;USB_OTG_Core_dev, USB_OTG_FS_CORE_ID, &amp;USR_desc, &amp;USBD_CDC_cb, &amp;USBD_USR_cb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析-Datasheet"><a href="#分析-Datasheet" class="headerlink" title="分析 Datasheet"></a>分析 Datasheet</h2><p>一般在Datasheet里有如下几个部分：</p>
<ul>
<li>芯片基本信息</li>
<li>电器特性</li>
<li>引脚特性</li>
<li>封装尺寸</li>
<li>参考电路</li>
<li>寄存器和软件</li>
<li>其他</li>
</ul>
<p>阅读Datasheet的步骤：</p>
<ul>
<li>快速阅读</li>
<li>应用场景和参考电路</li>
<li>关键参数与指标</li>
<li>涉及到的相关算法，协议，配合器件做延伸阅读</li>
<li>读剩下的部分</li>
<li>对比芯片家族</li>
<li>对比类似产品</li>
</ul>
<p>一般文档的首页是该芯片的重要信息，有些参数如电源、封装、通道数是属于功能应用信息，而如精度、分辨率等属于性能应用信息。比较而言，功能应用信息首先要关注。</p>
<p>参数：</p>
<ul>
<li>电器参数，这里只关注重要参数，且要做标记；</li>
<li>极限参数，对于部分需要的极限参数也要看；</li>
<li>管脚参数，防止使用不当。</li>
</ul>
<p>性能测试图：大概浏览即可。</p>
<p>芯片应用：这部分需要仔细看，搞定时序，逻辑等。</p>
<p>封装信息：在绘制封装时需要看。</p>
<p>最后注意：不要尽信Datasheet，因为可能会有错误。</p>
<h2 id="芯片目录"><a href="#芯片目录" class="headerlink" title="芯片目录"></a>芯片目录</h2><h3 id="模拟芯片"><a href="#模拟芯片" class="headerlink" title="模拟芯片"></a>模拟芯片</h3><h3 id="数字芯片"><a href="#数字芯片" class="headerlink" title="数字芯片"></a>数字芯片</h3><h3 id="主控"><a href="#主控" class="headerlink" title="主控"></a>主控</h3><h3 id="电压芯片"><a href="#电压芯片" class="headerlink" title="电压芯片"></a>电压芯片</h3><p>AMS-1117：线性降压<br>SX1308：升压芯片</p>
<h2 id="uC-OS-III-参考"><a href="#uC-OS-III-参考" class="headerlink" title="uC/OS-III 参考"></a>uC/OS-III 参考</h2><h3 id="uC-OS-III-代码架构"><a href="#uC-OS-III-代码架构" class="headerlink" title="uC/OS-III 代码架构"></a>uC/OS-III 代码架构</h3><p>主要有：配置文件，应用程序，系统代码，库文件，CPU相关代码，BSP板级支持包等。</p>
<p>配置文件：cpu_cfg.h，lib_cfg.h，os_cfg.h，os_cfg_app.h</p>
<p>应用程序：app.c，app.h</p>
<p>库文件：lib_*</p>
<p>系统代码：os_cfg_app.c，os_type.h，os_core.c，os_dgb.c，os_flag.c，os_int.c，os_mem.c，os_msg.c，os_mutex.c，os_pend_multi.c，os_g.c，os_sem.c，os_stat.c，os_tick.c，os_time.c，os_tmr.c，os_var.c，os.h</p>
<p>CPU相关代码：os_cpu.h，os_cpu_a.asm，os_cpu_c.c，cpu_def.h，cpu_c.c，cpu_a.asm，cpu_core.c，cpu_core.h</p>
<p>BSP板级支持包：bsp.h，bsp.c</p>
<h3 id="uC-OS-III-代码移植"><a href="#uC-OS-III-代码移植" class="headerlink" title="uC/OS III 代码移植"></a>uC/OS III 代码移植</h3><p>首先去<a href="https://www.micrium.com" target="_blank" rel="noopener">官方代码下载</a>，下载uC/OS III 代码，对于F103可以下载STM32F107的代码，选择Keil版，uC/OS III。</p>
<p>下载完成后，代码目录如下：</p>
<ul>
<li>Software<ul>
<li>EvalBoards<ul>
<li>Micrium<ul>
<li>uC-Eval-STM32F107<ul>
<li>BSP</li>
<li>uCOS-III</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>uC-CPU<ul>
<li>ARM-Cortex-M3<ul>
<li>GNU</li>
<li>IAR</li>
<li>RealView</li>
</ul>
</li>
</ul>
</li>
<li>uC-LIB<ul>
<li>Port<ul>
<li>ARM-Cortex-M3<ul>
<li>GNU</li>
<li>IAR</li>
<li>RealView</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>uCOS-III<ul>
<li>Source</li>
<li>Ports<ul>
<li>ARM-Cortex-M3 <ul>
<li>GNU</li>
<li>IAR</li>
<li>RealView</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>首先在我们的项目文件夹下建立目录：</p>
<ul>
<li>STM32F103RBT<ul>
<li>Project</li>
<li>User</li>
<li>Device</li>
<li>Driver</li>
<li>Ucos<ul>
<li>lib</li>
<li>core</li>
<li>cpu</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>之后：</p>
<ul>
<li>将代码目录<code>\uC-CPU</code>以及<code>\uC-CPU\ARM-Cortex-M3\RealView</code>下的文件（不包括文件夹）全部拷贝到我们的项目目录<code>\STM32F103RBT\Ucos\cpu</code>下；</li>
<li>将代码目录<code>\uC-LIB</code>以及<code>\uC-LIB\Ports\ARM-Cortex-M3\RealView</code>下的文件（不包括文件夹）全部拷贝到我们的项目目录<code>\STM32F103RBT\Ucos\lib</code>下；</li>
<li>将代码目录<code>\uCOS-III\Source</code>以及<code>\uCOS-III\Ports\ARM-Cortex-M3\Generic\RealView</code>下的文件（不包括文件夹）全部拷贝到我们的项目目录<code>\STM32F103RBT\Ucos\core</code>下；</li>
<li>将代码目录<code>\EvalBoards\Micrium\uC-Eval-STM32F107\uCOS-III</code>下的文件（不包括文件夹与<code>stm32f10x_conf.h</code>）全部拷贝到我们的项目目录<code>\STM32F103RBT\User</code>下。</li>
<li>将代码目录<code>\EvalBoards\Micrium\uC-Eval-STM32F107\BSP</code>下的<code>bsp.c</code>与<code>bsp.h</code>拷贝到我们的项目目录<code>\STM32F103RBT\User</code>下。</li>
</ul>
<p>打开<code>Manage Project Items</code>按钮，编辑项目目录。这可以按照项目目录创建<code>Groups</code>，并在对应的<code>Files</code>中添加相应<code>.c</code>文件和汇编（<code>.asm</code>，<code>.a</code>，<code>.s</code>）文件。</p>
<p>修改<code>startup_stm32f10x_md.s</code>：</p>
<ul>
<li><code>PendSV_Handler</code>改为<code>OS_CPU_PendSVHandler</code>，共3处；</li>
<li><code>SysTick_Handler</code>改为<code>OS_CPU_SysTickHandler</code>，共3处；</li>
</ul>
<p>修改<code>includes.h</code>：</p>
<ul>
<li><code>#include &lt;stm32f10x_lib.h&gt;</code>改为<code>#include &quot;stm32f10x.h&quot;</code>；</li>
</ul>
<p>修改<code>cpu_cfg.h</code>：</p>
<ul>
<li><code>CPU_CFG_TS_32_EN</code>后面的选项为<code>DEF_ENABLED</code>；</li>
<li><code>CPU_CFG_INT_DIS_MEAS_EN</code>上面的<code>#if 0</code>为<code>#if 1</code>；</li>
</ul>
<p>修改<code>app_cfg.h</code>：</p>
<ul>
<li><code>APP_CFG_SERIAL_EN</code>后面的选项为<code>DEF_DISABLED</code>；</li>
</ul>
<p>修改<code>lib_cfg.h</code>:</p>
<ul>
<li><code>LIB_MEM_CFG_HEAP_SIZE</code>后面的大小改为<code>2u * 1024u</code> </li>
</ul>
<p>修改<code>app.c</code>：</p>
<ul>
<li><code>BSP_IntDisAll();</code>去掉；</li>
<li>修改<code>AppTaskStart</code>函数的内容；</li>
</ul>
<p>删除下面的部分；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APP_TRACE_INFO((<span class="string">"Creating Application Tasks...\n\r"</span>));</span><br><span class="line">AppTaskCreate();                                            <span class="comment">/* Create Application Tasks                             */</span></span><br><span class="line"></span><br><span class="line">APP_TRACE_INFO((<span class="string">"Creating Application Events...\n\r"</span>));</span><br><span class="line">AppObjCreate();                                             <span class="comment">/* Create Application Objects                           */</span></span><br><span class="line"></span><br><span class="line">BSP_LED_Off(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>修改while中的部分；<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (DEF_TRUE) &#123; </span><br><span class="line">    Led_on();</span><br><span class="line">    OSTimeDlyHMSM(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>,</span><br><span class="line">                    OS_OPT_TIME_HMSM_STRICT,</span><br><span class="line">                    &amp;err);</span><br><span class="line">    Led_off();</span><br><span class="line">    OSTimeDlyHMSM(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>,</span><br><span class="line">                    OS_OPT_TIME_HMSM_STRICT,</span><br><span class="line">                    &amp;err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改<code>bsp.h</code>内容为：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span>  BSP_PRESENT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  BSP_PRESENT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>   BSP_MODULE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  BSP_EXT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  BSP_EXT  extern</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;cpu.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;cpu_core.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;lib_ascii.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;lib_def.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;lib_mem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;lib_str.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;stm32f10x.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;app_cfg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>         <span class="title">BSP_Init</span>                    <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function">CPU_INT32U   <span class="title">BSP_CPU_ClkFreq</span>             <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Led_on</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Led_off</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>修改<code>bsp.c</code>文件为：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  BSP_MODULE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bsp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">CPU_INT32U  BSP_CPU_ClkFreq_MHz;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DWT_CR      *(CPU_REG32 *)0xE0001000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DWT_CYCCNT  *(CPU_REG32 *)0xE0001004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DEM_CR      *(CPU_REG32 *)0xE000EDFC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DBGMCU_CR   *(CPU_REG32 *)0xE0042004</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DBGMCU_CR_TRACE_IOEN_MASK       0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DBGMCU_CR_TRACE_MODE_ASYNC      0x00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DBGMCU_CR_TRACE_MODE_SYNC_01    0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DBGMCU_CR_TRACE_MODE_SYNC_02    0x80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DBGMCU_CR_TRACE_MODE_SYNC_04    0xC0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DBGMCU_CR_TRACE_MODE_MASK       0xC0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DEM_CR_TRCENA                   (1 &lt;&lt; 24)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DWT_CR_CYCCNTENA                (1 &lt;&lt;  0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BSP_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef gpio;</span><br><span class="line">	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE);</span><br><span class="line">	gpio.GPIO_Mode = GPIO_Mode_Out_PP;</span><br><span class="line">	gpio.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	gpio.GPIO_Pin = GPIO_Pin_2;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;gpio);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Led_on</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_ResetBits(GPIOA, GPIO_Pin_2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Led_off</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_SetBits(GPIOA, GPIO_Pin_2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">CPU_INT32U <span class="title">BSP_CPU_ClkFreq</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RCC_ClocksTypeDef  rcc_clocks;</span><br><span class="line">    RCC_GetClocksFreq(&amp;rcc_clocks);</span><br><span class="line">    <span class="keyword">return</span> ((CPU_INT32U)rcc_clocks.HCLK_Frequency);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (CPU_CFG_TS_TMR_EN == DEF_ENABLED)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">CPU_TS_TmrInit</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CPU_INT32U  cpu_clk_freq_hz;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DEM_CR         |= (CPU_INT32U)DEM_CR_TRCENA;                <span class="comment">/* Enable Cortex-M3's DWT CYCCNT reg.                   */</span></span><br><span class="line">    DWT_CYCCNT      = (CPU_INT32U)<span class="number">0u</span>;</span><br><span class="line">    DWT_CR         |= (CPU_INT32U)DWT_CR_CYCCNTENA;</span><br><span class="line"></span><br><span class="line">    cpu_clk_freq_hz = BSP_CPU_ClkFreq();</span><br><span class="line">    CPU_TS_TmrFreqSet(cpu_clk_freq_hz);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (CPU_CFG_TS_TMR_EN == DEF_ENABLED)</span></span><br><span class="line"><span class="function">CPU_TS_TMR  <span class="title">CPU_TS_TmrRd</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((CPU_TS_TMR)DWT_CYCCNT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>接下来的开发将主要在<code>app.c</code>和<code>bsp.c</code>中了。</p>
<h3 id="系统综述"><a href="#系统综述" class="headerlink" title="系统综述"></a>系统综述</h3><p>在ucos-iii中，可以创建无数多个任务。另外，在初始化的时候，系统还会窗空闲任务OS_IdleTask()和时基任务OS_TickTask()，以及三个可选任务：软件定时器任务OS_TmrTaks()，中断延迟提交任务OS_IntQTask()和统计任务OS_StatTask()。</p>
<p>任务具有五种状态：</p>
<ul>
<li>休眠：声明但尚未创建，不受系统管理。</li>
<li>就绪：等待CPU使用权。</li>
<li>运行：正在运行。</li>
<li>等待：等待IO或某事件。</li>
<li>中断服务：进入中断函数。</li>
</ul>
<p>ucos-iii中对任务定义了9种状态：</p>
<ul>
<li>OS_TASK_STATE_RDY：就绪状态；</li>
<li>OS_TASK_STATE_DLY：延时状态；</li>
<li>OS_TASK_STATE_DEL：删除状态；</li>
<li>OS_TASK_STATE_SUSPENDED：挂起状态；</li>
<li>OS_TASK_STATE_PEND：无限期等待，直到某事件发生；</li>
<li>OS_TASK_STATE_PEND_TIMEOUT：有限期等待，超时则继续执行；</li>
<li>OS_TASK_STATE_DLY_SUSPENDED：在延时中被挂起；</li>
<li>OS_TASK_STATE_PEND_SUSPENDED：无限等待中被挂起；</li>
<li>OS_TASK_STATE_PEND_TIMEOUT_SUSPENDED：优先等待中被挂起</li>
</ul>
<p>另外，系统还提供软件定时器，多值信号量，互斥信号量，消息队列，事件标志组，任务信号量，消息队列，内存管理（分区）等功能。</p>
<h3 id="中断管理"><a href="#中断管理" class="headerlink" title="中断管理"></a>中断管理</h3><p>关闭中断（进入临界区）：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OS_CRITICAL_ENTER</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OS_CRITICAL_ENTER_CPU_EXIT</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>开启中断（退出临界区）：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OS_CRITICAL_EXIT</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OS_CRITICAL_EXIT_NO_SCHED</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>在进入中断服务函数后，应当调用函数将中断嵌套计数器加1，并在退出时减1。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中断嵌套计数 + 1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSIntEnter</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// 中断嵌套计数 - 1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSIntExit</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="时钟节拍"><a href="#时钟节拍" class="headerlink" title="时钟节拍"></a>时钟节拍</h3><p>时钟节拍就是系统以固定的频率产生中断（时基中断），并在中断中处理与时间相关的事件，推动所有任务向前运行。时钟节拍需要依赖于硬件定时器，在STM32裸机程序中经常使用的<code>SysTick</code>时钟是MCU的内核定时器，通常都使用该定时器产生操作系统的时钟节拍。</p>
<p>用户需要先在<code>os_cfg_app.h</code>中设定时钟节拍的频率<code>OS_CFG_TICK_RATE_HZ</code>，该频率越高，操作系统检测事件就越频繁，可以增强任务的实时性，但太频繁也会增加操作系统内核的负担加重，所以用户需要权衡该频率的设置。一般采用1ms的设置，也就是1000Hz。</p>
<p>定时器的初始化是在<code>AppTaskStart()</code>函数中。在初始化过程中，会开启<code>SysTick</code>中断，同时在<code>SysTick</code>中断中会给<code>OS_TickTask()</code>任务发送信号量。<code>OS_TickTask()</code>任务收到信号量后就会进入就绪状态，准备运行。</p>
<p>在实际运行中，由软件产生的定时器效果精度较硬件定时器低，误差约在1%以内，一般该精度足够用了。</p>
<h3 id="时间管理"><a href="#时间管理" class="headerlink" title="时间管理"></a>时间管理</h3><p>时间管理的相关函数有：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">延时执行当前任务，延时结束后再回来执行当前任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_DLY Dly 为相对时间，就是从现在起延时多长时间， 到时钟节拍总计数OSTickCtr = OSTickCtr 当前+ dly 时延时结束。</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_TIMEOUT 跟OS_OPT_TIME_DLY 情况一样。</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_MATCH Dly 为绝对时间，就是从系统开始运行（调用OSStart()）时到节拍总计数OSTickCtr = dly 时延时结束。</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_PERIODIC 周期性延时，跟OS_OPT_TIME_DLY差不多。如果是长时间延时，该选项更精准一些。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_DLY_ISR 在中断中使用该函数。</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_ZERO_DLY Dly 为0。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTimeDly</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK dly,    <span class="comment">// 延时的节拍数</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,    </span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err  </span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">延时执行当前任务，延时结束后再回来执行当前任务。</span></span><br><span class="line"><span class="comment">开关：os_cfg.h\OS_CFG_TIME_DLY_HMSM_EN</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_DLY Dly 为相对时间，就是从现在起延时多长时间， 到时钟节拍总计数OSTickCtr = OSTickCtr 当前+ dly 时延时结束。</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_TIMEOUT 跟OS_OPT_TIME_DLY 情况一样。</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_MATCH Dly 为绝对时间，就是从系统开始运行（调用OSStart()）时到节拍总计数OSTickCtr = dly 时延时结束。</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_PERIODIC 周期性延时，跟OS_OPT_TIME_DLY差不多。如果是长时间延时，该选项更精准一些。</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_HMSM_STRICT 延时时间取值比较严格。</span></span><br><span class="line"><span class="comment">    hours (0...99)</span></span><br><span class="line"><span class="comment">    minutes (0...59)</span></span><br><span class="line"><span class="comment">    seconds (0...59)</span></span><br><span class="line"><span class="comment">    milliseconds (0...999)</span></span><br><span class="line"><span class="comment">OS_OPT_TIME_HMSM_NON_STRICT 延时时间取值比较宽松。</span></span><br><span class="line"><span class="comment">    hours (0...999)</span></span><br><span class="line"><span class="comment">    minutes (0...9999)</span></span><br><span class="line"><span class="comment">    seconds (0...65535)</span></span><br><span class="line"><span class="comment">    milliseconds (0...4294967295)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_DLY_ISR 在中断中使用该函数。</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_INVALID_HOURS 小时数不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_INVALID_MINUTES 分钟数不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_INVALID_SECONDS 秒数不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_INVALID_MILLISECONDS 毫秒数不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_ZERO_DLY 延时时间为0。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTimeDlyHMSM</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_INT16U hours,    <span class="comment">// 小时数</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_INT16U minutes,  <span class="comment">// 分钟数</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_INT16U seconds,  <span class="comment">// 秒数</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_INT32U milli,    <span class="comment">// 毫秒数</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结束其他任务的延时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment">OS_ERR_STATE_INVALID 任务状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TIME_DLY_RESUME_ISR 在中断中结束延时。</span></span><br><span class="line"><span class="comment">OS_ERR_ TASK_NOT_DLY 任务不在延时。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_SUSPENDED 任务被挂起。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">开关：os_cfg.h\OS_CFG_TIME_DLY_RESUME_EN</span></span><br><span class="line"><span class="comment">该函数的p_tcb 参数不可以是当前任务。</span></span><br><span class="line"><span class="comment">不可以用该函数结束等待事件。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTimeDlyResume</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,  <span class="comment">// 任务的任务控制块指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">获取当前的时钟节拍计数值。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：当前的时钟节拍计数值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_TICK <span class="title">OSTimeGet</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">设置当前的时钟节拍计数值。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">该函数谨慎使用。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTimeSet</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK ticks,   <span class="comment">// 时钟节拍数</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="软件定时器"><a href="#软件定时器" class="headerlink" title="软件定时器"></a>软件定时器</h3><p>软件定时器启动之后是由软件定时器任务<code>OS_TmrTask()</code>统一管理，在创建软件定时器之前必须先使能软件定时器和配置软件定时器的相关参数。</p>
<p>软件定时器开启位置：<code>os_cfg.h\OS_CFG_TMR_EN</code><br>软件定时器配置位置：<code>os_cpu_app.h\OS_CFG_TMR_TASK_PRIO</code></p>
<p>相应的API有：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个软件定时器。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_TMR_ONE_SHOT 周期性定时。</span></span><br><span class="line"><span class="comment">OS_OPT_TMR_PERIODIC 一次性定时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME 非法创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_CREATED 该定时器已被创建过</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL 定时器对象为空</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE 定时器对象无效</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID_DLY 定时初始实参无效</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID_PERIOD 周期重载实参无效</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_ISR 在中断函数中定时</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">一次性定时时dly 不能为0。</span></span><br><span class="line"><span class="comment">周期性定时时period 不能为0。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTmrCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TMR *p_tmr,          <span class="comment">// 定时器控制块指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_CHAR *p_name,       <span class="comment">// 定时器名称。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK dly,            <span class="comment">// 初始定时节拍数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK period,         <span class="comment">// 周期定时重载节拍数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TMR_CALLBACK_PTR p_callback,  <span class="comment">// 定时到期时的回调函数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_callback_arg,   <span class="comment">// 传给回调函数的参数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err           </span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">启动一个软件定时器。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME 非法创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_CREATED 该定时器已被创建过</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL 定时器对象为空</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE 定时器对象无效</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项不可用。</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID_DLY 定时初始实参无效</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID_PERIOD 周期重载实参无效</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_ISR 在中断函数中定时</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">DEF_TRUE，执行成功。</span></span><br><span class="line"><span class="comment">DEF_FALSE，执行失败。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">一次性定时时dly 不能为0。</span></span><br><span class="line"><span class="comment">周期性定时时period 不能为0。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">CPU_BOOLEAN <span class="title">OSTmrStart</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TMR *p_tmr,        <span class="comment">// 定时器控制块指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">停止一个软件定时器。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_TMR_NONE 只需停止定时器，不需执行指定事件。</span></span><br><span class="line"><span class="comment">OS_OPT_TMR_CALLBACK 停止定时器，并执行回调函数。</span></span><br><span class="line"><span class="comment">OS_OPT_TMR_CALLBACK_ARG 停止定时器，并执行回调函数，且将p_callback_arg 作为新实参。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_tmr 不是一个定时器指针</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID opt 非法</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INACTIVE 定时器为被创建</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID p_tmr 为空</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID_STATE 定时器状态非法</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_ISR 在中断中被调用</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_NO_CALLBACK 定时器不存在回调函数</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_STOPPED 定时器已被停止</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">DEF_TRUE ， 停止成功（ 包括定时器已被停止， 即错误类型为“OS_ERR_TMR_STOPPED”）。</span></span><br><span class="line"><span class="comment">DEF_FALSE，停止失败。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">CPU_BOOLEAN <span class="title">OSTmrStop</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TMR *p_tmr,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_callback_arg,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">删除一个软件定时器。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_tmr 不是一个定时器类型</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID p_tmr 为空</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_ISR 在中断中被调用</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INACTIVE 定时器未被创建过</span></span><br><span class="line"><span class="comment">OS_ERR_TMR_INVALID_STATE 定时器处于非法状态</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">DEF_TRUE，删除成功；</span></span><br><span class="line"><span class="comment">DEF_FALSE，删除失败，或者有错误。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_BOOLEAN <span class="title">OSTmrDel</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TMR *p_tmr,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>软件定时器结构体：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">os_tmr</span> &#123;</span></span><br><span class="line">    OS_OBJ_TYPE          Type;  </span><br><span class="line">    CPU_CHAR            *NamePtr;   </span><br><span class="line">    OS_TMR_CALLBACK_PTR  CallbackPtr;  </span><br><span class="line">    <span class="keyword">void</span>                *CallbackPtrArg; </span><br><span class="line">    OS_TMR              *NextPtr;   </span><br><span class="line">    OS_TMR              *PrevPtr;</span><br><span class="line">    OS_TICK              Match;   </span><br><span class="line">    OS_TICK              Remain;  </span><br><span class="line">    OS_TICK              Dly;   </span><br><span class="line">    OS_TICK              Period; </span><br><span class="line">    OS_OPT               Opt; </span><br><span class="line">    OS_STATE             State;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_DBG_EN &gt; 0u</span></span><br><span class="line">    OS_TMR              *DbgPrevPtr;</span><br><span class="line">    OS_TMR              *DbgNextPtr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="多值信号量"><a href="#多值信号量" class="headerlink" title="多值信号量"></a>多值信号量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个多值信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_CREATE_ISR 在中断中调用该函数</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME 在调用OSSafetyCriticalStart()函数后创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_NAME p_name 为空指针</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_CREATED 信号量已经被创建过</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_sem 是个空指针</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_sem 已被初始化到另一种对象类型</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSSemCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM *p_sem,    <span class="comment">// 多值信号量指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_CHAR *p_name, <span class="comment">// 多值信号量名称。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM_CTR cnt,   <span class="comment">// 资源数目。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">发布多值信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_1 发布给等待该信号量中最高优先级的任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_ALL 发布给等待该信号量的所有任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_1 |OS_OPT_POST_NO_SCHED发布给等待该信号量中最高优先级的任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_ALL |OS_OPT_POST_NO_SCHED发布给等待该信号量的所有任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_sem 为空</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_sem 不是多值信号量类型对象</span></span><br><span class="line"><span class="comment">OS_ERR_SEM_OVF 该发布将导致了信号量的计数值溢出</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，有错误。</span></span><br><span class="line"><span class="comment">其他值，信号量的计数值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_SEM_CTR <span class="title">OSSemPost</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM *p_sem,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">等待一个多值信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_BLOCKING 如果不能立即获得信号量，就堵塞当前任务，继续等待信号量。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_NON_BLOCKING 如果不能立即获得信号量，不堵塞当前任务，不继续等待信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误，获得信号量。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_DEL p_sem 被删除。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_sem 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_sem 不是信号量类型对象。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID opt 非法。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT 等待被另一个任务中止。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ISR 在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_WOULD_BLOCK 缺乏堵塞。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_STATUS_INVALID 等待状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TIMEOUT 等待超时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，信号量的当前计数值为0，或有错误。</span></span><br><span class="line"><span class="comment">其他值，信号量的当前计数值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">OS_SEM_CTR <span class="title">OSSemPend</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM *p_sem,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK timeout,   <span class="comment">// 等待超时时间（单位：时钟节拍），0代表无期限等待。opt 为OS_OPT_PEND_BLOCKING 时该参数才起作用。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_TS *p_ts,   <span class="comment">// 时间戳，用于存储信号量最后一次被发布的时间戳，或者等待被中止的时间戳，或者信号量被删除时的时间戳，具体返回哪个时间戳，要根据返回的p_err 判断。该参数可以为NULL，表示用户不需要获得时间戳。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">中止对一个多值信号量的等待。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1 只中止该信号量等待列表中的最高优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL 中止该信号量等待列表中的所有优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1|OS_OPT_POST_NO_SCHED  只中止该信号量等待列表中的最高优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL|OS_OPT_POST_NO_SCHED  中止该信号量等待列表中的所有优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_sem 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_sem 不是多值信号量类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_NONE 没有任务在等待该信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，没有任务在等待该信号量，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，被中止的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSSemPendAbort</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM *p_sem,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">删除一个多值信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_NO_PEND 如果没有任务等待p_sem，才删除p_sem。</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_ALWAYS 必须删除p_sem。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment">OS_ERR_DEL_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_sem 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_sem 不是多值信号量类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_WAITING 还有任务在等待该信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，没有任务在等待该信号量，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，信号量被删除前等待其的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSSemDel</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM *p_sem,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">设置多值信号量的计数值。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment">OS_ERR_SET_ISR 函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_sem 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_sem 不是多值信号量类型。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_WAITING 还有任务在等待p_sem。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSSemSet</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM *p_sem,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_SEM_CTR cnt,   <span class="comment">// 要设置的信号量计数值。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">os_sem</span> &#123;</span>    </span><br><span class="line">    OS_OBJ_TYPE          Type;   </span><br><span class="line">    CPU_CHAR            *NamePtr; </span><br><span class="line">    OS_PEND_LIST         PendList;   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_DBG_EN &gt; 0u</span></span><br><span class="line">    OS_SEM              *DbgPrevPtr;</span><br><span class="line">    OS_SEM              *DbgNextPtr;</span><br><span class="line">    CPU_CHAR            *DbgNamePtr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    OS_SEM_CTR           Ctr;</span><br><span class="line">    CPU_TS               TS;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="互斥信号量"><a href="#互斥信号量" class="headerlink" title="互斥信号量"></a>互斥信号量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个互斥信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_CREATE_ISR 在中断中调用该函数</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME 在调用OSSafetyCriticalStart() 函数后创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_NAME p_name 为空指针</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_CREATED 信号量已经被创建过</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_mutex 是个空指针</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSMutexCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MUTEX *p_mutex,  <span class="comment">// 互斥信号量指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_CHAR *p_name,   <span class="comment">// 互斥信号量名称。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">释放互斥信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NONE 释放信号量后，如果信号量可用，而且有任务正在等待，就（默认）进行任务调度。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NO_SCHED 释放信号量后，如果信号量可用，而且有任务正在等待，不进行任务调度，继续运行当前任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误。</span></span><br><span class="line"><span class="comment">OS_ERR_MUTEX_NESTING p_mutex 被嵌套。</span></span><br><span class="line"><span class="comment">OS_ERR_MUTEX_NOT_OWNER 当前任务不持有p_mutex。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_mutex 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_mutex 不是多值信号量类型。</span></span><br><span class="line"><span class="comment">OS_ERR_POST_ISR 在中断中释放多值信号量。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSMutexPost</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MUTEX *p_mutex,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">申请一个互斥信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_BLOCKING 如果不能立即获得信号量，就堵塞当前任务，继续等待信号量。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_NON_BLOCKING 如果不能立即获得信号量，不堵塞当前任务，不继续等待信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误，获得信号量。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_DEL p_sem 被删除。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_sem 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_sem 不是信号量类型对象。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID opt 非法。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT 等待被另一个任务中止。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ISR 在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_WOULD_BLOCK 缺乏堵塞。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_STATUS_INVALID 等待状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TIMEOUT 等待超时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，有错误。</span></span><br><span class="line"><span class="comment">其他值，信号量的计数值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSMutexPend</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MUTEX *p_mutex,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK timeout,   <span class="comment">// 等待超时时间（ 单位： 时钟节拍）， 0 代表无期限等待。opt 为OS_OPT_PEND_BLOCKING 时该参数才起作用。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_TS *p_ts,  <span class="comment">// 时间戳</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">中止对一个互斥信号量的等待。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1 只中止该信号量等待列表中的最高优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL 中止该信号量等待列表中的所有优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1 |OS_OPT_POST_NO_SCHED只中止该信号量等待列表中的最高优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL |OS_OPT_POST_NO_SCHED中止该信号量等待列表中的所有优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_mutex 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_mutex 不是多值信号量类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_NONE 没有任务在等待该信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，没有任务在等待该信号量，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，被中止的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSMutexPendAbort</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MUTEX *p_mutex,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">删除一个互斥信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_NO_PEND 如果没有任务等待p_mutex，才删除p_mutex。</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_ALWAYS 必须删除p_mutex。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误。</span></span><br><span class="line"><span class="comment">OS_ERR_DEL_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_mutex 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_mutex 不是互斥信号量类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_STATE_INVALID 持有信号量任务状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_WAITING 还有任务在等待该信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，没有任务在等待该信号量，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，信号量被删除前等待其的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSMutexDel</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MUTEX *p_mutex,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">os_mutex</span> &#123;</span>        </span><br><span class="line">    OS_OBJ_TYPE          Type; </span><br><span class="line">    CPU_CHAR            *NamePtr;</span><br><span class="line">    OS_PEND_LIST         PendList;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_DBG_EN &gt; 0u</span></span><br><span class="line">    OS_MUTEX            *DbgPrevPtr;</span><br><span class="line">    OS_MUTEX            *DbgNextPtr;</span><br><span class="line">    CPU_CHAR            *DbgNamePtr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    OS_TCB              *OwnerTCBPtr;</span><br><span class="line">    OS_PRIO              OwnerOriginalPrio;</span><br><span class="line">    OS_NESTING_CTR       OwnerNestingCtr; </span><br><span class="line">    CPU_TS               TS;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个消息队列。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误</span></span><br><span class="line"><span class="comment">OS_ERR_CREATE_ISR 在中断中调用该函数</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME 在调用OSSafetyCriticalStart() 函数后创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_NAME p_name 为空指针</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_CREATED 该消息队列已经被创建过</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_q 是个空指针</span></span><br><span class="line"><span class="comment">OS_ERR_Q_SIZE max_qty 为0.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSQCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_Q *p_q,         <span class="comment">// 消息队列指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_CHAR *p_name,  <span class="comment">// 消息队列名称。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MSG_QTY max_qty, <span class="comment">// 最大消息数目。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">向消息队列发布一个消息。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FIFO 把消息发布到队列的入口端，并且只唤醒一个等待任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_LIFO 把消息发布到队列的出口端，并且只唤醒一个等待任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FIFO |OS_OPT_POST_ALL 把消息发布到队列的入口端，并且唤醒全部等待任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_LIFO |OS_OPT_POST_ALL 把消息发布到队列的出口端，并且唤醒全部</span></span><br><span class="line"><span class="comment">等待任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FIFO |OS_OPT_POST_NO_SCHED 把消息发布到队列的入口端；只唤醒一个等待任务；不进行任务调度，继续运行当前任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_LIFO |OS_OPT_POST_NO_SCHED 把消息发布到队列的出口端；只唤醒一个等待任务；不进行任务调度，继续运行当前任</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 调用成功，消息被发布了。</span></span><br><span class="line"><span class="comment">OS_ERR_MSG_POOL_EMPTY 消息池没可用消息。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_q 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_q 不是消息队列类型。</span></span><br><span class="line"><span class="comment">OS_ERR_Q_MAX 消息队列已满。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSQPost</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_Q *p_q,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_void,   <span class="comment">// 消息指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MSG_SIZE msg_size,   <span class="comment">// 消息大小（字节）</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">等待一个消息队列的消息。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_BLOCKING 如果不能立即获得消息，就堵塞当前任务，继续等待消息。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_NON_BLOCKING 如果不能立即获得消息，不堵塞当前任务，不继续等待消息。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误，任务获得消息。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_q 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_PTR_INVALID p_msg_size 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_q 不是消息队列类型对象。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT 等待被中止。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ISR 在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_WOULD_BLOCK 缺乏堵塞。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_STATUS_INVALID 等待状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TIMEOUT 等待超时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">!= (void *)0，接收到的消息的指针（首地址）。</span></span><br><span class="line"><span class="comment">== (void *)0，接收到一个空消息，或者没接收到消息，或者所等待的消息队列不存在，或者用户传给p_q 的不是消息队列类型的对象。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">OSQPend</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_Q *p_q,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK timeout,    <span class="comment">// 等待超时时间</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,          </span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MSG_SIZE *p_msg_size,  <span class="comment">// 消息大小（单位：字节）。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_TS *p_ts,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">中止任务对一个消息队列的等待。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1 只中止该消息队列等待列表中的最高优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL 中止该消息队列等待列表中的所有优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1 |OS_OPT_POST_NO_SCHED只中止该消息队列等待列表中的最高优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL |OS_OPT_POST_NO_SCHED中止该消息队列等待列表中的所有优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_q 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_q 不是消息队列类型。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_NONE 没有任务在等待该消息队列。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，没有任务在等待该信号量，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，被中止的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSQPendAbort</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_Q *p_q,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">删除一个消息队列。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_NO_PEND 如果没有任务等待p_q，才删除p_q。</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_ALWAYS 必须删除p_q。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误。</span></span><br><span class="line"><span class="comment">OS_ERR_DEL_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_q 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_q 不是消息队列类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_WAITING 还有任务在等待该消息队列。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，没有任务在等待该消息队列，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，消息队列被删除前等待其的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSQDel</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_Q *p_q,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">清空一个消息队列（的消息）。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，执行成功。</span></span><br><span class="line"><span class="comment">OS_ERR_FLUSH_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_q 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_q 不是消息队列类型。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">清空消息队列前队列里的消息数目。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_MSG_QTY <span class="title">OSQFlush</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_Q *p_q,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">os_q</span> &#123;</span></span><br><span class="line">    OS_OBJ_TYPE          Type; </span><br><span class="line">    CPU_CHAR            *NamePtr;</span><br><span class="line">    OS_PEND_LIST         PendList;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_DBG_EN &gt; 0u</span></span><br><span class="line">    OS_Q                *DbgPrevPtr;</span><br><span class="line">    OS_Q                *DbgNextPtr;</span><br><span class="line">    CPU_CHAR            *DbgNamePtr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    OS_MSG_Q             MsgQ; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="事件标志组"><a href="#事件标志组" class="headerlink" title="事件标志组"></a>事件标志组</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个事件标志组。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，创建成功。</span></span><br><span class="line"><span class="comment">OS_ERR_CREATE_ISR 在中断中调用该函数</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME 在调用OSSafetyCriticalStart() 函数后创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_NAME p_name 为空指针</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_CREATED 该事件标志组已经被创建过</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_q 是个空指针</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSFlagCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAG_GRP *p_grp,  <span class="comment">// 事件标志组指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_CHAR *p_name,    <span class="comment">// 事件标志组名称。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAGS flags,      <span class="comment">// 事件标志初始值。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">发布一个事件标志组。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FLAG_SET 把选定的标志位置1。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FLAG_CLR 把选定的标志位清0。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FLAG_SET |OS_OPT_POST_NO_SCHED 把消息发布到队列的末端，并且唤醒全部等待任务；不进行任务调度，继续运行当前任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FLAG_CLR |OS_OPT_POST_NO_SCHED 把消息发布到队列的前端，并且唤醒全部等待任务；不进行任务调度，继续运行当前任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 调用成功。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_grp 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_grp 不是事件标志组类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">事件标志组的标志值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_FLAGS <span class="title">OSFlagPost</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAG_GRP *p_grp,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAGS flags,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">等待一个事件标志组的事件组合发生。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ALL 等待flags 指定位均被清0。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ANY 等待flags 指定位有一位被清0 即可。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ALL 等待flags 指定位均被置1。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ANY 等待flags 指定位有一位被置1 即可。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ALL |OS_OPT_PEND_FLAG_CONSUME 等待flags 指定位均被清0；等到后把触发位取反。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ANY |OS_OPT_PEND_FLAG_CONSUME 等待flags 指定位有一位被清0 即可；等到后把触发位取反。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ALL |OS_OPT_PEND_FLAG_CONSUME等待flags 指定位均被置1；等到后把触发位取反。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ANY |OS_OPT_PEND_FLAG_CONSUME等待flags 指定位有一位被置1 即可；等到后把触发位取反。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ALL |OS_OPT_PEND_NON_BLOCKING要求flags 指定位均被清0；不符合要求不等待。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ANY |OS_OPT_PEND_NON_BLOCKING要求flags 指定位有一位被清0；不符合要求不等待。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ALL |OS_OPT_PEND_NON_BLOCKING要求flags 指定位均被置1；不符合要求不等待。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ANY |OS_OPT_PEND_NON_BLOCKING要求flags 指定位有一位被置1；不符合要求不等待。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ALL |OS_OPT_PEND_FLAG_CONSUME |OS_OPT_PEND_NON_BLOCKING要求flags 指定位均被清0；符合要求就把触发位取反；不符合要求不等待；。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_CLR_ANY |OS_OPT_PEND_FLAG_CONSUME |OS_OPT_PEND_NON_BLOCKING要求flags 指定位有一位被清0；符合要求就把触发位取反；不符合要求不等待；。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ALL |OS_OPT_PEND_FLAG_CONSUME |OS_OPT_PEND_NON_BLOCKING要求flags 指定位均被置1；符合要求就把触发位取反；不符合要求不等待；。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_FLAG_SET_ANY |OS_OPT_PEND_FLAG_CONSUME |OS_OPT_PEND_NON_BLOCKING要求flags 指定位有一位被置1；符合要求就把触发位取反；不符合要求不等待；。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 等待成功，指定事件组合发生。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_grp 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_grp 不是事件标志组类型对象。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT 等待被中止。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ISR 在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_WOULD_BLOCK 缺乏堵塞。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_TIMEOUT 等待超时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">!= (void *)0，任务脱离等待时的事件标志组的标志成员值。</span></span><br><span class="line"><span class="comment">== (void *)0，有错误，或者等待超时。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_FLAGS <span class="title">OSFlagPend</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAG_GRP *p_grp,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAGS flags,     <span class="comment">// 要等待的事件（位）的组合</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_TS *p_ts,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">中止任务对一个事件标志组的等待。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1 只中止该事件标志组等待列表中的最高优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL 中止该事件标志组等待列表中的所有优先级任务。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_1 |OS_OPT_POST_NO_SCHED只中止该事件标志组等待列表中的最高优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_ABORT_ALL |OS_OPT_POST_NO_SCHED中止该事件标志组等待列表中的所有优先级任务，但不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_grp 为空</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_grp 不是事件标志组类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_NONE 没有任务在等待该事件标志组。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，没有任务在等待该事件标志组，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，被中止的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSFlagPendAbort</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAG_GRP *p_grp,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">删除一个事件标志组。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_NO_PEND 如果没有任务等待p_grp，才删除p_grp。</span></span><br><span class="line"><span class="comment">OS_OPT_DEL_ALWAYS 必须删除p_grp。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误。</span></span><br><span class="line"><span class="comment">OS_ERR_DEL_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_PTR_NULL p_grp 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_OBJ_TYPE p_grp 不是事件标志组类型。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_WAITING 还有任务在等待该事件标志组。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回</span></span><br><span class="line"><span class="comment">0，没有任务在等待该事件标志组，或者有错误产生。</span></span><br><span class="line"><span class="comment">&gt;0，事件标志组被删除前等待其的任务数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSFlagDel</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_FLAG_GRP *p_grp,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">os_flag_grp</span> &#123;</span> </span><br><span class="line">    OS_OBJ_TYPE          Type; </span><br><span class="line">    CPU_CHAR            *NamePtr;  </span><br><span class="line">    OS_PEND_LIST         PendList; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_DBG_EN &gt; 0u</span></span><br><span class="line">    OS_FLAG_GRP         *DbgPrevPtr;</span><br><span class="line">    OS_FLAG_GRP         *DbgNextPtr;</span><br><span class="line">    CPU_CHAR            *DbgNamePtr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    OS_FLAGS             Flags; </span><br><span class="line">    CPU_TS               TS;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="等待多个内核对象"><a href="#等待多个内核对象" class="headerlink" title="等待多个内核对象"></a>等待多个内核对象</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">等待多个内核对象（多值信号量或消息队列）。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_BLOCKING 如果目前没有对象已被发布，阻塞任务，等待对象被发布。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_NON_BLOCKING 如果目前没有对象已被发布，不阻塞任务。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_OBJ_QTY <span class="title">OSPendMulti</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_PEND_DATA *p_pend_data_tbl,  <span class="comment">// 要等待的内核对象，等待两个或以上对象时一般为数组。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OBJ_QTY tbl_size,  <span class="comment">// 等待对象的数目。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">os_pend_data</span> &#123;</span></span><br><span class="line">    OS_PEND_DATA        *PrevPtr;</span><br><span class="line">    OS_PEND_DATA        *NextPtr;</span><br><span class="line">    OS_TCB              *TCBPtr;</span><br><span class="line">    OS_PEND_OBJ         *PendObjPtr;</span><br><span class="line">    OS_PEND_OBJ         *RdyObjPtr;</span><br><span class="line">    <span class="keyword">void</span>                *RdyMsgPtr;</span><br><span class="line">    OS_MSG_SIZE          RdyMsgSize;</span><br><span class="line">    CPU_TS               RdyTS;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="任务信号量"><a href="#任务信号量" class="headerlink" title="任务信号量"></a>任务信号量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">给一个任务发布任务信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NONE 没有选项。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NO_SCHED 不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误</span></span><br><span class="line"><span class="comment">OS_ERR_SEM_OVF 该发布将导致了信号量的计数值溢出。</span></span><br><span class="line"><span class="comment">OS_ERR_STATE_INVALID 任务状态非法。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，有错误。</span></span><br><span class="line"><span class="comment">其他值，任务信号量的当前计数值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_SEM_CTR <span class="title">OSTaskSemPost</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,    <span class="comment">// 目标任务控制块。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">等待任务信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_BLOCKING 如果不能立即获得信号量，就堵塞当前任务，继续等待信号量。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_NON_BLOCKING 如果不能立即获得信号量，不堵塞当前任务，不继续等待信号量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误，成功获得信号量。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT 等待被另一个任务中止。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ISR 在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_WOULD_BLOCK 缺乏堵塞。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_STATUS_INVALID 等待状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TIMEOUT 等待超时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，信号量的当前计数值为0，或有错误。</span></span><br><span class="line"><span class="comment">其他值，信号量的当前计数值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_SEM_CTR <span class="title">OSTaskSemPend</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_TS *p_ts,</span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_TS *p_ts,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">中止一个任务对其任务信号量的等待。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NONE 没有选项。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NO_SCHED 不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误，成功中止。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_NONE 目标任务并未在等待任务信号量。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_SELF 目标任务是自身。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">== DEF_FALSE&gt;0，目标任务没在等待任务信号量，或者有错误。</span></span><br><span class="line"><span class="comment">== DEF_TRUE，目标任务确实在等待任务信号量，而且等待成功被中止。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">目标任务不可以是自身（当前运行任务）。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_BOOLEAN <span class="title">OSTaskSemPendAbort</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="任务消息队列"><a href="#任务消息队列" class="headerlink" title="任务消息队列"></a>任务消息队列</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">向任务消息队列发布一个消息。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FIFO 把消息发布到队列的入口端。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_LIFO 把消息发布到队列的出口端。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_FIFO |OS_OPT_POST_NO_SCHED把消息发布到队列的入口端；不进行任务调度，继续运行当前任务。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_LIFO |OS_OPT_POST_NO_SCHED把消息发布到队列的出口端；不进行任务调度，继续运行当前任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，消息成功被发布了。</span></span><br><span class="line"><span class="comment">OS_ERR_Q_MAX 任务消息队列已满。</span></span><br><span class="line"><span class="comment">OS_ERR_MSG_POOL_EMPTY 消息池没可用消息。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskQPost</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,   <span class="comment">// 目标任务。如果该参数为NULL，消息将发送给当前运行任务。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_void,    <span class="comment">// 消息指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MSG_SIZE msg_size,  <span class="comment">// 消息长度。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">等待任务消息队列的消息。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_BLOCKING 如果不能立即获得消息，就堵塞当前任务，继续等待消息。</span></span><br><span class="line"><span class="comment">OS_OPT_PEND_NON_BLOCKING 如果不能立即获得消息，不堵塞当前任务，不继续等待消息。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 没错误，任务成功获得消息。</span></span><br><span class="line"><span class="comment">OS_ERR_PTR_INVALID p_msg_size 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT 等待被中止。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ISR 在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_WOULD_BLOCK 缺乏堵塞。</span></span><br><span class="line"><span class="comment">OS_ERR_Q_EMPTY 任务消息队列里没有消息</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_TIMEOUT 等待超时。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">!= NULL，接收到的消息的指针（首地址）。</span></span><br><span class="line"><span class="comment">== NULL，接收到一个空消息，或者有错误。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">OSTaskQPend</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MSG_SIZE *p_msg_size,   <span class="comment">// 消息长度。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_TS *p_ts,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">中止一个任务对其消息队列的等待。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NONE 没有选项要求。</span></span><br><span class="line"><span class="comment">OS_OPT_POST_NO_SCHED 不进行任务调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，中止成功。</span></span><br><span class="line"><span class="comment">OS_ERR_OPT_INVALID 选项非法。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_ISR 该函数在中断中被调用。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_NONE 目标任务没在等待任务消息队列。</span></span><br><span class="line"><span class="comment">OS_ERR_PEND_ABORT_SELF 目标任务是自身（当前运行任务）。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">== DEF_FALSE，目标任务没在等待任务消息队列，或有错误。</span></span><br><span class="line"><span class="comment">== DEF_TRUE，目标任务是在等待任务消息队列，而且等待被中止。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">p_tcb 不能为NULL 或当前运行任务。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_BOOLEAN <span class="title">OSTaskQPendAbort</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个内存管理对象。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，创建成功。</span></span><br><span class="line"><span class="comment">OS_ERR_CREATE_ISR 在中断中调用该函数</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME 在调用OSSafetyCriticalStart() 函数后创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_INVALID_BLKS 内存块数目非法。</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_INVALID_P_ADDR 内存分区地址非法。</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_INVALID_SIZE 内存空间大小非法。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSMemCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MEM *p_mem,   <span class="comment">// 内存管理对象。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_CHAR *p_name,  <span class="comment">// 命名内存管理对象。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_addr,    <span class="comment">// 内存分区首地址。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MEM_QTY n_blks,  <span class="comment">// 内存块数目，要求不小于2。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MEM_SIZE blk_size,  <span class="comment">// 内存块空间字节数，不少于一个指针的字节数。（STM32 是的指针的字节数是4）。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">向内存管理对象获取一个空闲内存块。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，获取成功。</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_INVALID_P_MEM p_mem 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_NO_FREE_BLKS 没有空闲的内存块。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">获取到的内存块。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">OSMemGet</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MEM *p_mem,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">内存块退还回内存管理对象。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，退还成功。</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_FULL 内存分区的空闲内存块已满。</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_INVALID_P_BLK p_blk 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_MEM_INVALID_P_MEM p_mem 为空。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSMemPut</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MEM *p_mem,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_blk,   <span class="comment">// 要退还的内存块（的首地址）。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="任务管理"><a href="#任务管理" class="headerlink" title="任务管理"></a>任务管理</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">选项：</span></span><br><span class="line"><span class="comment">OS_OPT_TASK_NONE 没有选项要求。</span></span><br><span class="line"><span class="comment">OS_OPT_TASK_STK_CHK允许任务进行堆栈检测。</span></span><br><span class="line"><span class="comment">OS_OPT_TASK_STK_CLR堆栈全部进行清0 初始化。</span></span><br><span class="line"><span class="comment">OS_OPT_TASK_SAVE_FP在上下文切换时保存浮点寄存器。STM32 芯片没有浮点寄存器，该项一般不用。</span></span><br><span class="line"><span class="comment">OS_OPT_TASK_NO_TLS屏蔽任务的TLS 支持。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，创建成功。</span></span><br><span class="line"><span class="comment">OS_ERR_ILLEGAL_CREATE_RUN_TIME在调用OSSafetyCriticalStart()函数后创建内核对象</span></span><br><span class="line"><span class="comment">OS_ERR_NAME p_name 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_PRIO_INVALID prio&gt;= S_CFG_PRIO_MAX-1，或者在</span></span><br><span class="line"><span class="comment">OS_CFG_ISR_POST_DEFERRED_EN 被置1 时prio=0。</span></span><br><span class="line"><span class="comment">OS_ERR_STK_SIZE_INVALID p_stk_base 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_STK_LIMIT_INVALID stk_limit 大于stk_size。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_CREATE_ISR 在中断中创建任务。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_INVALID p_task 为空。</span></span><br><span class="line"><span class="comment">OS_ERR_TCB_INVALID p_tcb 为空。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,          <span class="comment">// 任务控制块指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_CHAR *p_name,       <span class="comment">// 命名任务。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TASK_PTR p_task,     <span class="comment">// 任务函数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_arg,            <span class="comment">// 传递给任务函数的参数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_PRIO prio,           <span class="comment">// 任务优先级。uC/OS-III 允许任务拥有相同的优先级。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_STK *p_stk_base,    <span class="comment">// 任务堆栈指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_STK_SIZE stk_limit, <span class="comment">// 任务堆栈的限制空间。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_STK_SIZE stk_size,  <span class="comment">// 任务堆栈总空间。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_MSG_QTY q_size,      <span class="comment">// 任务消息队列容量。只有使能了任务消息队列，该参数才有效。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK time_quanta,    <span class="comment">// 时间片（单位：时钟节拍）。如果该参数设为0，表示使用系统默认值</span></span></span></span><br><span class="line"><span class="function"><span class="params">（ OSCfg_TickRate_Hz / <span class="number">10</span>）。</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *p_ext,            <span class="comment">// 任务扩展内容的指针。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_OPT opt,            </span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err          </span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">挂起一个任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，挂起任务成功。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 挂起当前任务时调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_SUSPEND_ISR 在禁用中断延迟发布的情况下，在中断中调用该函数。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_SUSPEND_IDLE 挂起空闲任务。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_SUSPEND_INT_HANDLER 在使能中断延迟发布的情况下，挂起中断延迟提交任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">不能挂起空闲任务。</span></span><br><span class="line"><span class="comment">当OS_CFG_ISR_POST_DEFERRED_EN = 0u 时，不能在中断中调用该函数。</span></span><br><span class="line"><span class="comment">当OS_CFG_ISR_POST_DEFERRED_EN &gt; 0u 时，不能挂起中断延迟提交任务。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskSuspend</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,  <span class="comment">// 任务控制块指针，0 表自身。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">解嵌一个被挂起的任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，解嵌成功。</span></span><br><span class="line"><span class="comment">OS_ERR_STATE_INVALID 任务状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_RESUME_ISR 在禁用中断延迟发布的情况下，在中断中调用该函数。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_RESUME_SELF 解嵌自身。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_NOT_SUSPENDED 任务p_tcb 未被挂起。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">不能解嵌自身，即p_tcb 不能为0 或当前运行任务。</span></span><br><span class="line"><span class="comment">当OS_CFG_ISR_POST_DEFERRED_EN = 0u 时，不能在中断中调用该函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskResume</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">改变一个任务的优先级。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，调用成功。</span></span><br><span class="line"><span class="comment">OS_ERR_PRIO_INVALID 当使能了中断延迟发布时，prio_new = 0；或者，prio_new &gt;=(OS_CFG_PRIO_MAX-1)。</span></span><br><span class="line"><span class="comment">OS_ERR_STATE_INVALID 目标任务的任务状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_CHANGE_PRIO_ISR 在中断中调用该函数。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">当OS_CFG_ISR_POST_DEFERRED_EN &gt; 0u 时，prio_new 不能为0；prio_new 不能&gt;=(OS_CFG_PRIO_MAX-1)。</span></span><br><span class="line"><span class="comment">不能在中断中调用该函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskChangePrio</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_PRIO prio_new,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">删除一个任务。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，调用成功。</span></span><br><span class="line"><span class="comment">OS_ERR_STATE_INVALID 任务状态非法。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_DEL_IDLE p_tcb 为空闲任务。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_DEL_INVALID 当使能了中断延迟发布时，p_tcb 为中断延迟提交任务。</span></span><br><span class="line"><span class="comment">OS_ERR_TASK_DEL_ISR 在中断中调用该函数。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">当OS_CFG_ISR_POST_DEFERRED_EN &gt; 0u 时，不能删除中断延迟提交任务。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskDel</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">配置时间片轮转调度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">当OS_CFG_ISR_POST_DEFERRED_EN = 0u 时，不能在中断中调用该函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSSchedRoundRobinCfg</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    CPU_BOOLEAN en,           <span class="comment">// 使能 DEF_ENABLED/禁用 DEF_DISABLED事件片轮转调度</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK dflt_time_quanta, <span class="comment">// 设置默认时间片：&gt;0 把dflt_time_quanta 设为默认时间片值；=0 把系统默认值OSCfg_TickRate_Hz / 10 设为默认时间片值。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">放弃时间片。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，调用成功。</span></span><br><span class="line"><span class="comment">OS_ERR_ROUND_ROBIN_1 当前优先级的就绪列表中只有一个任务（当前任务）。</span></span><br><span class="line"><span class="comment">OS_ERR_ROUND_ROBIN_DISABLED 未使能时间片轮转调度。</span></span><br><span class="line"><span class="comment">OS_ERR_SCHED_LOCKED 调度器被锁。</span></span><br><span class="line"><span class="comment">OS_ERR_YIELD_ISR 在中断中调用该函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSSchedRoundRobinYield</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">设置一个任务的时间片。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，调用成功。</span></span><br><span class="line"><span class="comment">OS_ERR_SET_ISR 在中断中调用该函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskTimeQuantaSet</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TICK time_quanta,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">设置一个任务的某个任务寄存器的值。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">错误：</span></span><br><span class="line"><span class="comment">OS_ERR_NONE 无错误，调用成功。</span></span><br><span class="line"><span class="comment">OS_ERR_REG_ID_INVALID Id 不在[ 0，OS_CFG_TASK_REG_TBL_SIZE – 1 ]内。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskRegSet</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_REG_ID id,  <span class="comment">// 任务寄存器的id，取值范围为[ 0，OS_CFG_TASK_REG_TBL_SIZE – 1 ]。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_REG value,  <span class="comment">// 设置任务寄存器的内容。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">获取一个任务的某个任务寄存器的值。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，获取的任务寄存器的值为0（p_err == OS_ERR_NONE），或有错误（p_err !=</span></span><br><span class="line"><span class="comment">OS_ERR_NONE）。</span></span><br><span class="line"><span class="comment">其他，获取的任务寄存器的值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">OS_REG <span class="title">OSTaskRegGet</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_TCB *p_tcb,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_REG_ID id,</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">os_tcb</span> &#123;</span></span><br><span class="line">    CPU_STK             *StkPtr;</span><br><span class="line">    <span class="keyword">void</span>                *ExtPtr;   </span><br><span class="line">    CPU_STK             *StkLimitPtr; </span><br><span class="line"></span><br><span class="line">    OS_TCB              *NextPtr;  </span><br><span class="line">    OS_TCB              *PrevPtr;  </span><br><span class="line"></span><br><span class="line">    OS_TCB              *TickNextPtr;</span><br><span class="line">    OS_TCB              *TickPrevPtr;</span><br><span class="line"></span><br><span class="line">    OS_TICK_SPOKE       *TickSpokePtr; </span><br><span class="line"></span><br><span class="line">    CPU_CHAR            *NamePtr;  </span><br><span class="line">    CPU_STK             *StkBasePtr; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_CFG_TLS_TBL_SIZE) &amp;&amp; (OS_CFG_TLS_TBL_SIZE &gt; 0u)</span></span><br><span class="line">    OS_TLS               TLS_Tbl[OS_CFG_TLS_TBL_SIZE];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    OS_TASK_PTR          TaskEntryAddr; </span><br><span class="line">    <span class="keyword">void</span>                *TaskEntryArg; </span><br><span class="line"></span><br><span class="line">    OS_PEND_DATA        *PendDataTblPtr;</span><br><span class="line">    OS_STATE             PendOn;</span><br><span class="line">    OS_STATUS            PendStatus; </span><br><span class="line">    OS_STATE             TaskState;  </span><br><span class="line">    OS_PRIO              Prio; </span><br><span class="line">    CPU_STK_SIZE         StkSize;   </span><br><span class="line">    OS_OPT               Opt;</span><br><span class="line">    OS_OBJ_QTY           PendDataTblEntries;</span><br><span class="line">    CPU_TS               TS; </span><br><span class="line">    OS_SEM_CTR           SemCtr; </span><br><span class="line">    OS_TICK              TickCtrPrev; </span><br><span class="line">    OS_TICK              TickCtrMatch;</span><br><span class="line">    OS_TICK              TickRemain; </span><br><span class="line">    OS_TICK              TimeQuanta;</span><br><span class="line">    OS_TICK              TimeQuantaCtr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_MSG_EN &gt; 0u</span></span><br><span class="line">    <span class="keyword">void</span>                *MsgPtr; </span><br><span class="line">    OS_MSG_SIZE          MsgSize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_TASK_Q_EN &gt; 0u</span></span><br><span class="line">    OS_MSG_Q             MsgQ;   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_TASK_PROFILE_EN &gt; 0u</span></span><br><span class="line">    CPU_TS               MsgQPendTime; </span><br><span class="line">    CPU_TS               MsgQPendTimeMax;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_TASK_REG_TBL_SIZE &gt; 0u</span></span><br><span class="line">    OS_REG               RegTbl[OS_CFG_TASK_REG_TBL_SIZE]; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_FLAG_EN &gt; 0u</span></span><br><span class="line">    OS_FLAGS             FlagsPend;</span><br><span class="line">    OS_FLAGS             FlagsRdy; </span><br><span class="line">    OS_OPT               FlagsOpt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_TASK_SUSPEND_EN &gt; 0u</span></span><br><span class="line">    OS_NESTING_CTR       SuspendCtr; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_TASK_PROFILE_EN &gt; 0u</span></span><br><span class="line">    OS_CPU_USAGE         CPUUsage;</span><br><span class="line">    OS_CPU_USAGE         CPUUsageMax;</span><br><span class="line">    OS_CTX_SW_CTR        CtxSwCtr;</span><br><span class="line">    CPU_TS               CyclesDelta;</span><br><span class="line">    CPU_TS               CyclesStart;</span><br><span class="line">    OS_CYCLES            CyclesTotal;</span><br><span class="line">    OS_CYCLES            CyclesTotalPrev; </span><br><span class="line"></span><br><span class="line">    CPU_TS               SemPendTime;  </span><br><span class="line">    CPU_TS               SemPendTimeMax;  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_STAT_TASK_STK_CHK_EN &gt; 0u</span></span><br><span class="line">    CPU_STK_SIZE         StkUsed; </span><br><span class="line">    CPU_STK_SIZE         StkFree;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CPU_CFG_INT_DIS_MEAS_EN</span></span><br><span class="line">    CPU_TS               IntDisTimeMax;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_SCHED_LOCK_TIME_MEAS_EN &gt; 0u</span></span><br><span class="line">    CPU_TS               SchedLockTimeMax;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CFG_DBG_EN &gt; 0u</span></span><br><span class="line">    OS_TCB              *DbgPrevPtr;</span><br><span class="line">    OS_TCB              *DbgNextPtr;</span><br><span class="line">    CPU_CHAR            *DbgNamePtr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="中断管理-1"><a href="#中断管理-1" class="headerlink" title="中断管理"></a>中断管理</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">标记进入中断服务函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSIntEnter</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">标记退出中断服务函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSIntExit</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">获取整个程序目前的最大关中断时间。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">整个程序目前的最大关中断时间（时间戳时间）。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_TS_TMR <span class="title">CPU_IntDisMeasMaxGet</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">开始测量一个程序段的最大关中断时间。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">上一次测量的程序段最大关中断时间（时间戳时间）。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_TS_TMR <span class="title">CPU_IntDisMeasMaxCurReset</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结束一个程序段的最大关中断时间的测量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">测量的程序段最大关中断时间（时间戳时间）。</span></span><br><span class="line"><span class="comment">返回值是一个以CPU 时钟运行的计数值，通过BSP_CPU_ClkFreq() 函数可以获取CPU 时钟频率。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_TS_TMR <span class="title">CPU_IntDisMeasMaxCurGet</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br></pre></td></tr></table></figure>
<h3 id="统计信息"><a href="#统计信息" class="headerlink" title="统计信息"></a>统计信息</h3><p>统计信息的开关在：<code>os_cfg.h\OS_CFG_STAT_TASK_EN</code>。</p>
<p>CPU 使用率和其最大记录分别保存于全局变量<code>OSStatTaskCPUUsage</code> 和<code>OSStatTaskCPUUsageMax</code>，一个任务的CPU 使用率和其最大记录分别保存于其任务控制块的<code>CPUUsage</code> 和<code>CPUUsageMax</code> 成员，一个任务的任务堆栈的空闲大小和已用大小分别保存于其任务控制块的<code>StkFree</code> 和<code>StkUsed</code> 成员。需要注意，<code>OSStatTaskCPUUsage</code>、<code>OSStatTaskCPUUsageMax</code>、<code>CPUUsage</code> 和<code>CPUUsageMax</code> 均被放大了10000 倍，所以这几个值缩小10000 倍后才是真实值。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">获取CPU 主频。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">CPU 的主频（单位：HZ），即HCLK 时钟频率。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_INT32U <span class="title">BSP_CPU_ClkFreq</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">获取系统版本号。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回：</span></span><br><span class="line"><span class="comment">0，有错误，获取uC/OS 系统版本号失败。</span></span><br><span class="line"><span class="comment">其他值，uC/OS 系统版本号。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回的版本号是一个被去掉“.”符号的整数，用户需要自行处理获取真实的版本</span></span><br><span class="line"><span class="comment">号。如版本号为“V3.01.02”就返回30102</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CPU_INT16U <span class="title">OSVersion</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OS_ERR *p_err</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>除了前面讲述的统计信息外，uC/OS 系统还为我们提供了很多统计信息。前一章讲述的最大关中断时间就是个很重要参数。此外，全局变量OSTaskCtxSwCtr 记录了任务切换总次数，OSTaskQty 记录了被创建任务的数目， OSSchedLockTimeMax （ 需使能OS_CFG_SCHED_LOCK_TIME_MEAS_EN，位于“os_cfg.h”）记录了调度器被锁的最大时间，OSIntQNbrEntriesMax 记录了中断队列成员被使用的最大数目，OSFlagQty 记录了事件标志组对象的数目，OSMemQty 记录了内存管理（分区）对象的数目，OSMutexQty 记录了互斥信号量对象的数目，OSQQty 记录了消息队列对象的数目，OSSemQty 记录了多值信号量对象的数目，等等。</p>
<h3 id="uC-OS-II-与-uC-OS-III-区别"><a href="#uC-OS-II-与-uC-OS-III-区别" class="headerlink" title="uC/OS-II 与 uC/OS-III 区别"></a>uC/OS-II 与 uC/OS-III 区别</h3><table>
<thead>
<tr>
<th>功能</th>
<th>uC/OS-II</th>
<th>uC/OS-III</th>
</tr>
</thead>
<tbody>
<tr>
<td>最大任务数</td>
<td>256</td>
<td>无限制</td>
</tr>
<tr>
<td>每个优先级的任务数</td>
<td>1</td>
<td>无限制</td>
</tr>
<tr>
<td>时间片轮转</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>互斥信号量</td>
<td>不可嵌套</td>
<td>可嵌套</td>
</tr>
<tr>
<td>消息邮箱</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>不通过信号量标记任务</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>不通过消息队列发送消息</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>任务的停止与恢复</td>
<td>不可嵌套</td>
<td>可嵌套</td>
</tr>
<tr>
<td>代码段需求</td>
<td>6k~26k</td>
<td>6k~20k</td>
</tr>
<tr>
<td>运行时配置</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>嵌入的测量功能</td>
<td>有限制</td>
<td>大量的</td>
</tr>
<tr>
<td>时间戳</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>汇编可视化</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>任务级的时基定时器处理</td>
<td>否</td>
<td>是</td>
</tr>
</tbody>
</table>
<h2 id="uC-OS-II-参考"><a href="#uC-OS-II-参考" class="headerlink" title="uC/OS-II 参考"></a>uC/OS-II 参考</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>代码分为与处理器相关和无关的代码，以及应用相关的代码。</p>
<p>处理器无关的代码有：ucos_ii.h，ucos_ii.c，os_tmr.c，os_time.c，os_task.c，os_sem.c，os_q.c，os_mutex.c，os_mem.c，os_mbox.c，os_flag.c，os_core.c</p>
<p>处理器相关的代码有：os_cpu.h，os_cou_a.asm，os_cpu_c.c</p>
<p>应用相关的代码有：os_cfg.h，includes.h</p>
<h3 id="任务管理-1"><a href="#任务管理-1" class="headerlink" title="任务管理"></a>任务管理</h3><p>任务是由程序，数据和PCB构成，任务之间由链表连接。</p>
<p>任务管理的相关函数：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OSTaskCreate()      <span class="comment">// 创建任务 OS_TASK_CREATE_EN      </span></span><br><span class="line">OSTaskCreateExt()   <span class="comment">// 创建任务 OS_TASK_CREATE_EXT_EN</span></span><br><span class="line">OSTaskStkChk()      <span class="comment">// 堆栈检验 OS_TASK_CREATE_EXT_EN  </span></span><br><span class="line">OSTaskDel()         <span class="comment">// 删除任务 OS_TASK_DEL_EN     </span></span><br><span class="line">OSTaskDelReq()      <span class="comment">// 请求删除任务 OS_TASK_DEL_EN     </span></span><br><span class="line">OSTaskSuuspend()    <span class="comment">// 挂起任务 OS_TASK_SUSPEND_EN</span></span><br><span class="line">OSTaskResume()      <span class="comment">// 恢复任务 OS_TASK_SUSPEND_EN</span></span><br><span class="line">OSTaskChangePrio()  <span class="comment">// 改变优先级 OS_TASK_CHANGE_PRIO_EN </span></span><br><span class="line">OSTaskQuery()       <span class="comment">// 查询任务信息 OS_TASK_QUERY_EN</span></span><br></pre></td></tr></table></figure></p>
<p>创建任务要求：</p>
<ul>
<li>创建任务不能在中断中创建；</li>
<li>且优先级范围是0~63，每个优先级与每个任务一一对应；</li>
<li>系统在运行期间可以创建任务。</li>
</ul>
<p>创建任务：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">void (*task)(void *p_arg)：任务函数指针</span></span><br><span class="line"><span class="comment">void *p_arg：堆栈指针</span></span><br><span class="line"><span class="comment">OS_STK *ptos：堆栈栈顶指针</span></span><br><span class="line"><span class="comment">INT8U prio：任务优先级</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">返回值：返回函数错误信息</span></span><br><span class="line"><span class="comment">如果没有错误，返回OS_NO_ERR</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">INT8U <span class="title">OSTaskCreate</span><span class="params">(<span class="keyword">void</span> (*task)(<span class="keyword">void</span> *p_arg), <span class="keyword">void</span> *pdata, OS_STK *ptos, INT8U prio)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>其他任务函数<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// INT8U prio：优先级</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除任务</span></span><br><span class="line"><span class="function">INT8U <span class="title">OSTaskDel</span><span class="params">(INT8U prio)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 任务挂起</span></span></span><br><span class="line"><span class="function">INT8U <span class="title">OSTaskSuspend</span><span class="params">(INT8U prio)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 任务恢复</span></span></span><br><span class="line"><span class="function">INT8U <span class="title">OSTaskResume</span><span class="params">(INT8U prio)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 修改优先级</span></span></span><br><span class="line"><span class="function">INT8U <span class="title">OSTaskChangePrio</span><span class="params">(INT8U oldprio, INT8U newprio)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 查询信息</span></span></span><br><span class="line"><span class="function">INT8U <span class="title">OSTaskChangePrio</span><span class="params">(INT8U prio, OS_TCB *pdata)</span></span></span><br></pre></td></tr></table></figure></p>
<p>结构体OS_TCB主要包含：</p>
<ul>
<li>栈顶指针</li>
<li>控制块扩展指针</li>
<li>栈底指针</li>
<li>堆栈长度</li>
<li>创建任务的选项</li>
<li>保留</li>
<li>后一个TCB指针</li>
<li>前一个TCB指针</li>
<li>任务等待的时限</li>
<li>任务状态</li>
<li>优先级</li>
<li>用于快速访问就绪表的数据</li>
</ul>
<p>例如创建函数的使用：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Code</span></span><br><span class="line">    OSInit();  <span class="comment">// 系统初始化</span></span><br><span class="line">    <span class="comment">// Code</span></span><br><span class="line">    OSTaskCreate(Task, args);  <span class="comment">// 创建任务</span></span><br><span class="line">    OSTaskCreate(Task, args);  <span class="comment">// 创建任务</span></span><br><span class="line">    <span class="comment">// Code</span></span><br><span class="line">    OSStart();  <span class="comment">// 运行系统</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>任务代码结构：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Task</span><span class="params">(<span class="keyword">void</span> *pdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化部分</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">// 其他部分</span></span><br><span class="line">        OS_ENTER_CRITICAL();   <span class="comment">// 关中断</span></span><br><span class="line">        <span class="comment">// 不可中断部分</span></span><br><span class="line">        OS_EXIT_CRITICAL();    <span class="comment">// 开中断</span></span><br><span class="line">        <span class="comment">// 其他部分</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外还有空闲任务和统计任务：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 空闲任务，优先最低</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSTaskIddle</span><span class="params">(<span class="keyword">void</span> *pdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pdata = pdata;  <span class="comment">// 防止报错，没啥用</span></span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        OS_ENTER_CRITICAL(); <span class="comment">// 关中断</span></span><br><span class="line">        OSIdleCtr++；        <span class="comment">// 计数</span></span><br><span class="line">        OS_EXIT_CRITICAL();  <span class="comment">// 开中断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计任务，用于统计CPU使用率：OSCPUsage</span></span><br><span class="line"><span class="comment">// 开启需要在OS_CFG.H中配置OS_TASK_STAT_EN 为 1</span></span><br><span class="line"><span class="comment">// 且需要在初始化 OSStatInit()</span></span><br><span class="line">OSTaskStart()</span><br></pre></td></tr></table></figure></p>
<h3 id="任务调度"><a href="#任务调度" class="headerlink" title="任务调度"></a>任务调度</h3><p>调度器负责在任务就绪队列中选取任务，并将切换出的任务放入等待队列。调度时机有：</p>
<ul>
<li>操作系统运行开始的时候</li>
<li>任务用完一个时间片</li>
<li>产生了一个中断</li>
<li>任务自身转为等待</li>
<li>任务自身被删除</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭调度</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSSchedLock</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// 打开调度</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSSchedUnlock</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// 切换任务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OSSched</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="时钟"><a href="#时钟" class="headerlink" title="时钟"></a>时钟</h3><p>ucos必须需要一个定时器用来做系统时钟。开启时钟必须在OSStart()之后，也就是用户任务中开启。</p>
<p>时钟管理的相关函数：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OSTickISR()  <span class="comment">// 时钟中断</span></span><br><span class="line">OSTimeDly()  <span class="comment">// 节拍延时</span></span><br><span class="line">OSTimeDlyHMSM() <span class="comment">// 时钟延时</span></span><br><span class="line">OSTimeDlyResume() <span class="comment">// 唤醒延时</span></span><br><span class="line">OSTimeGet()  <span class="comment">// 获取当前时钟</span></span><br><span class="line">OSTimeSet()  <span class="comment">// 设置当前时钟</span></span><br></pre></td></tr></table></figure></p>
<h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OSSemCreate()  <span class="comment">// 创建信号量</span></span><br><span class="line">OSSemPend()    <span class="comment">// 获取信号量，会挂起</span></span><br><span class="line">OSSemPost()    <span class="comment">// 发送信号量，中断可用</span></span><br><span class="line">OSSemDel()     <span class="comment">// 删除信号量</span></span><br><span class="line">OSSemAccept()  <span class="comment">// 无等待获取信号量，中断可用</span></span><br><span class="line">OSSemQuery()   <span class="comment">// 查询信号量，中断可用</span></span><br></pre></td></tr></table></figure>
<h3 id="消息邮箱"><a href="#消息邮箱" class="headerlink" title="消息邮箱"></a>消息邮箱</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">OSMboxCreate()  <span class="comment">// 创建邮箱</span></span><br><span class="line">OSMboxPend()    <span class="comment">// 等待消息</span></span><br><span class="line">OSMboxPost()    <span class="comment">// 发送消息</span></span><br><span class="line">OSMboxPostOpt() <span class="comment">// 发送消息</span></span><br><span class="line">OSMboxDel()     <span class="comment">// 删除消息</span></span><br><span class="line">OSMboxAccept()  <span class="comment">// 无等待获取消息</span></span><br><span class="line">OSMboxQuery()   <span class="comment">// 查询消息</span></span><br></pre></td></tr></table></figure>
<h3 id="消息队列-1"><a href="#消息队列-1" class="headerlink" title="消息队列"></a>消息队列</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OSQCreate()     <span class="comment">// 创建消息队列</span></span><br><span class="line">OSQPend()       <span class="comment">// 等待获取消息</span></span><br><span class="line">OSQPostFront()  <span class="comment">// 发送消息</span></span><br><span class="line">OSQPostOpt()    <span class="comment">// 发送消息</span></span><br><span class="line">OSQFlush()      <span class="comment">// 发送消息</span></span><br><span class="line">OSQDel()        <span class="comment">// 删除消息</span></span><br><span class="line">OSQQuery()      <span class="comment">// 查询消息</span></span><br><span class="line">OSQAccept()     <span class="comment">// 无等待获取消息</span></span><br></pre></td></tr></table></figure>
<h3 id="内存管理-1"><a href="#内存管理-1" class="headerlink" title="内存管理"></a>内存管理</h3><p>采用固定分区法。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OSMemCreate()   <span class="comment">// 创建内存分区</span></span><br><span class="line">OSMemGet()      <span class="comment">// 申请内存块</span></span><br><span class="line">OSMemPut()      <span class="comment">// 释放内存块</span></span><br><span class="line">OSMemQuery()    <span class="comment">// 查看分区状态</span></span><br><span class="line">OSMemNameGet()  <span class="comment">// 获取分区名称</span></span><br><span class="line">OSMemNameSet()  <span class="comment">// 设置分区名称</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/STM32F103/" rel="tag"># STM32F103</a>
          
            <a href="/tags/UCOS-III/" rel="tag"># UCOS III</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/11/Others/System/" rel="next" title="系统维护相关">
                <i class="fa fa-chevron-left"></i> 系统维护相关
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/14/GPU_ML/cudaFirst/" rel="prev" title="CUDA 入门">
                CUDA 入门 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MzY0MS8yMDE4MA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Peng</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">50</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/yourname" title="GitHub &rarr; https://github.com/yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Keil-标准库"><span class="nav-text">Keil 标准库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建STM32F103工程"><span class="nav-text">创建STM32F103工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STM32F4"><span class="nav-text">STM32F4</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#宏定义"><span class="nav-text">宏定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改时钟源"><span class="nav-text">修改时钟源</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#USB"><span class="nav-text">USB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#USB-协议"><span class="nav-text">USB 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#物理层"><span class="nav-text">物理层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USB-连接与断开"><span class="nav-text">USB 连接与断开</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据传输"><span class="nav-text">数据传输</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USB-传输"><span class="nav-text">USB 传输</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#包"><span class="nav-text">包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务"><span class="nav-text">事务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#传输"><span class="nav-text">传输</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#批量传输"><span class="nav-text">批量传输</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#中断传输"><span class="nav-text">中断传输</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#等时传输"><span class="nav-text">等时传输</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#控制传输"><span class="nav-text">控制传输</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USB-标准请求"><span class="nav-text">USB 标准请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设备枚举和描述符"><span class="nav-text">设备枚举和描述符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#常见-USB-设备类"><span class="nav-text">常见 USB 设备类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#USB-代码库结构"><span class="nav-text">USB 代码库结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STM32F103-中使用-USB"><span class="nav-text">STM32F103 中使用 USB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STM32F4-中导入USB-OTG开发包"><span class="nav-text">STM32F4 中导入USB-OTG开发包</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#USB-CONF-H"><span class="nav-text">USB_CONF.H</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USBD-CONF-H"><span class="nav-text">USBD_CONF.H</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USB-DESC-C"><span class="nav-text">USB_DESC.C</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USB-APP-C"><span class="nav-text">USB_APP.C</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析-Datasheet"><span class="nav-text">分析 Datasheet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#芯片目录"><span class="nav-text">芯片目录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟芯片"><span class="nav-text">模拟芯片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数字芯片"><span class="nav-text">数字芯片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主控"><span class="nav-text">主控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#电压芯片"><span class="nav-text">电压芯片</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uC-OS-III-参考"><span class="nav-text">uC/OS-III 参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#uC-OS-III-代码架构"><span class="nav-text">uC/OS-III 代码架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uC-OS-III-代码移植"><span class="nav-text">uC/OS III 代码移植</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统综述"><span class="nav-text">系统综述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中断管理"><span class="nav-text">中断管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时钟节拍"><span class="nav-text">时钟节拍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时间管理"><span class="nav-text">时间管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#软件定时器"><span class="nav-text">软件定时器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多值信号量"><span class="nav-text">多值信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#互斥信号量"><span class="nav-text">互斥信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息队列"><span class="nav-text">消息队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件标志组"><span class="nav-text">事件标志组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#等待多个内核对象"><span class="nav-text">等待多个内核对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务信号量"><span class="nav-text">任务信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务消息队列"><span class="nav-text">任务消息队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存管理"><span class="nav-text">内存管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务管理"><span class="nav-text">任务管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中断管理-1"><span class="nav-text">中断管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#统计信息"><span class="nav-text">统计信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uC-OS-II-与-uC-OS-III-区别"><span class="nav-text">uC/OS-II 与 uC/OS-III 区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uC-OS-II-参考"><span class="nav-text">uC/OS-II 参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#代码"><span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务管理-1"><span class="nav-text">任务管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#任务调度"><span class="nav-text">任务调度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时钟"><span class="nav-text">时钟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#信号量"><span class="nav-text">信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息邮箱"><span class="nav-text">消息邮箱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息队列-1"><span class="nav-text">消息队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存管理-1"><span class="nav-text">内存管理</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Peng</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.1</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,255,128" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  
    <script>
  window.livereOptions = {
    refer: '2020/02/12/Hardware_IOT/STM32/'
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
<script>
if ($('body').find('div.pdf').length) {
  $.ajax({
    type: 'GET',
    url: '//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js',
    dataType: 'script',
    cache: true,
    success: function() {
      $('body').find('div.pdf').each(function(i, o) {
        PDFObject.embed($(o).attr('target'), $(o), {
          pdfOpenParams: {
            navpanes: 0,
            toolbar: 0,
            statusbar: 0,
            pagemode: 'thumbs',
            view: 'FitH'
          },
          PDFJS_URL: '/lib/pdf/web/viewer.html',
          height: $(o).attr('height') || '600px'
        });
      });
    },
  });
}
</script>


  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  



<!-- <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script> -->


</body>
</html>
