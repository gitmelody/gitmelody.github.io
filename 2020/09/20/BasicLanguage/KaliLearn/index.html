<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="综述网络安全：要求数据在互联网上：真实，可靠，完整，可控的传输与存储。 Kali 渗透测试标准PETS：  前期交互，获取范围，一次一个系统 情报收集，安全防护机制 威胁建模 漏洞分析 渗透攻击 后渗透测试 报告  Linux 扫描与防御主机扫描netstat 查看端口123-l # 正在监听的端口-t # TCP 协议-n # 不解析主机名 禁用 ICMP 连接1sysctl -w net.ip">
<meta name="keywords" content="Kali,汇编,逆向">
<meta property="og:type" content="article">
<meta property="og:title" content="网络安全学习">
<meta property="og:url" content="https://withz.github.io/2020/09/20/BasicLanguage/KaliLearn/index.html">
<meta property="og:site_name" content="Withz">
<meta property="og:description" content="综述网络安全：要求数据在互联网上：真实，可靠，完整，可控的传输与存储。 Kali 渗透测试标准PETS：  前期交互，获取范围，一次一个系统 情报收集，安全防护机制 威胁建模 漏洞分析 渗透攻击 后渗透测试 报告  Linux 扫描与防御主机扫描netstat 查看端口123-l # 正在监听的端口-t # TCP 协议-n # 不解析主机名 禁用 ICMP 连接1sysctl -w net.ip">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-10-10T03:31:28.920Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="网络安全学习">
<meta name="twitter:description" content="综述网络安全：要求数据在互联网上：真实，可靠，完整，可控的传输与存储。 Kali 渗透测试标准PETS：  前期交互，获取范围，一次一个系统 情报收集，安全防护机制 威胁建模 漏洞分析 渗透攻击 后渗透测试 报告  Linux 扫描与防御主机扫描netstat 查看端口123-l # 正在监听的端口-t # TCP 协议-n # 不解析主机名 禁用 ICMP 连接1sysctl -w net.ip">






  <link rel="canonical" href="https://withz.github.io/2020/09/20/BasicLanguage/KaliLearn/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>网络安全学习 | Withz</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Withz</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">50</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">7</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">29</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/withz" class="github-corner" title="打开Github" aria-label="打开Github" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://withz.github.io/2020/09/20/BasicLanguage/KaliLearn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Withz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">网络安全学习

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-09-20 12:45:18" itemprop="dateCreated datePublished" datetime="2020-09-20T12:45:18+08:00">2020-09-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-10-10 11:31:28" itemprop="dateModified" datetime="2020-10-10T11:31:28+08:00">2020-10-10</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维相关/" itemprop="url" rel="index"><span itemprop="name">运维相关</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h1><p>网络安全：要求数据在互联网上：真实，可靠，完整，可控的传输与存储。</p>
<h1 id="Kali-渗透测试"><a href="#Kali-渗透测试" class="headerlink" title="Kali 渗透测试"></a>Kali 渗透测试</h1><h2 id="标准"><a href="#标准" class="headerlink" title="标准"></a>标准</h2><p><a href="http://www.pentest-standard.org" target="_blank" rel="noopener">PETS</a>：</p>
<ul>
<li>前期交互，获取范围，一次一个系统</li>
<li>情报收集，安全防护机制</li>
<li>威胁建模</li>
<li>漏洞分析</li>
<li>渗透攻击</li>
<li>后渗透测试</li>
<li>报告</li>
</ul>
<h1 id="Linux-扫描与防御"><a href="#Linux-扫描与防御" class="headerlink" title="Linux 扫描与防御"></a>Linux 扫描与防御</h1><h2 id="主机扫描"><a href="#主机扫描" class="headerlink" title="主机扫描"></a>主机扫描</h2><h3 id="netstat-查看端口"><a href="#netstat-查看端口" class="headerlink" title="netstat 查看端口"></a>netstat 查看端口</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-l <span class="comment"># 正在监听的端口</span></span><br><span class="line">-t <span class="comment"># TCP 协议</span></span><br><span class="line">-n <span class="comment"># 不解析主机名</span></span><br></pre></td></tr></table></figure>
<h3 id="禁用-ICMP-连接"><a href="#禁用-ICMP-连接" class="headerlink" title="禁用 ICMP 连接"></a>禁用 ICMP 连接</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1</span><br></pre></td></tr></table></figure>
<h3 id="TCP-Dump"><a href="#TCP-Dump" class="headerlink" title="TCP Dump"></a>TCP Dump</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -np -ieth0</span><br></pre></td></tr></table></figure>
<h3 id="fping-批量主机扫描工具（ICMP）"><a href="#fping-批量主机扫描工具（ICMP）" class="headerlink" title="fping 批量主机扫描工具（ICMP）"></a>fping 批量主机扫描工具（ICMP）</h3><p>作用：批量，并行发送，结果易懂。<br><a href="http://fping.org" target="_blank" rel="noopener">下载地址</a><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">man fping <span class="comment"># 查看帮助</span></span><br><span class="line">fping IP1 IP2</span><br><span class="line">-a <span class="comment"># 只显示存活的主机</span></span><br><span class="line">-u <span class="comment"># 只显示未存活的主机</span></span><br><span class="line">-g <span class="comment"># 主机段 </span></span><br><span class="line">-f <span class="comment"># 从文件读取</span></span><br></pre></td></tr></table></figure></p>
<h3 id="hping-批量主机扫描工具（TCP-IP）"><a href="#hping-批量主机扫描工具（TCP-IP）" class="headerlink" title="hping 批量主机扫描工具（TCP/IP）"></a>hping 批量主机扫描工具（TCP/IP）</h3><p>作用：探测TCP端口，模拟DDOS攻击。<br><a href="http://www.hping.org" target="_blank" rel="noopener">下载地址</a><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hping -h <span class="comment"># 帮助</span></span><br><span class="line">-p port_num <span class="comment"># 端口探测</span></span><br><span class="line">-S <span class="comment"># 设置TCP模式下的 SYN 包</span></span><br><span class="line">-a <span class="comment"># 伪造IP地址</span></span><br></pre></td></tr></table></figure></p>
<h2 id="路由扫描"><a href="#路由扫描" class="headerlink" title="路由扫描"></a>路由扫描</h2><h3 id="Trace-Route"><a href="#Trace-Route" class="headerlink" title="Trace Route"></a>Trace Route</h3><p>让每一个路由返回一个ICMP包。</p>
<ul>
<li>Windows：发送 ICMP 包。</li>
<li>Linux：发送 UDP 包，端口号大于30000。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">traceroute IP <span class="comment"># 默认 UDP</span></span><br><span class="line">-T <span class="comment"># 使用 TCP</span></span><br><span class="line">-p <span class="comment"># 使用 TCP 的端口号</span></span><br><span class="line">-I <span class="comment"># 使用 ICMP</span></span><br><span class="line">-n <span class="comment"># 延时时间</span></span><br></pre></td></tr></table></figure>
<h3 id="MTR"><a href="#MTR" class="headerlink" title="MTR"></a>MTR</h3><p>测试主机到每一个路由的连通性，实时。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mtr IP</span><br></pre></td></tr></table></figure></p>
<h2 id="扫描服务"><a href="#扫描服务" class="headerlink" title="扫描服务"></a>扫描服务</h2><h3 id="NMAP"><a href="#NMAP" class="headerlink" title="NMAP"></a>NMAP</h3><p>批量扫描主机和服务<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-P   <span class="comment"># ICMP ping 简单</span></span><br><span class="line">-sS  <span class="comment"># TCP SYN   不易检测，通用</span></span><br><span class="line">-sT  <span class="comment"># TCP 连接  真实</span></span><br><span class="line">-sU  <span class="comment"># UDP       可能穿透防火墙，会很慢：Linux限制单位时间内返回ICMP的次数</span></span><br><span class="line"></span><br><span class="line">nmap -sP 10.10.10.0/24 <span class="comment"># 得到存活的主机</span></span><br><span class="line">nmap -sS 10.10.10.12   <span class="comment"># 得到主机上存活的TCP服务（默认0-1024和特殊端口）</span></span><br><span class="line">nmap -sS -p 0-30000 10.10.10.12 <span class="comment"># 指定端口</span></span><br></pre></td></tr></table></figure></p>
<h3 id="NCAT"><a href="#NCAT" class="headerlink" title="NCAT"></a>NCAT</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-w <span class="comment"># 超时时间</span></span><br><span class="line">-z <span class="comment"># 输入输出模式</span></span><br><span class="line">-v <span class="comment"># 显示命令执行过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认 TCP</span></span><br><span class="line">nc -v -z -w2 10.10.10.12 1-50 <span class="comment"># 端口范围1-50</span></span><br><span class="line"><span class="comment"># UDP</span></span><br><span class="line">nc -v -u -z -w2 10.10.10.12 1-50</span><br></pre></td></tr></table></figure>
<h2 id="攻击防御"><a href="#攻击防御" class="headerlink" title="攻击防御"></a>攻击防御</h2><p>攻击者伪造源IP，发送SYN包，耗尽目标机器资源。<br>防御方式：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：设置重置次数，默认都是5次</span></span><br><span class="line">sysctl -w net.ipv4.tcp_synack_retries=3</span><br><span class="line">sysctl -w net.ipv4.tcp_syn_retries=3</span><br><span class="line"><span class="comment"># 方式2：设置SYN Cookies</span></span><br><span class="line">sysctl -w net.ipv4.tcp_syncookies=1</span><br><span class="line"><span class="comment"># 方式3：增大backlog队列（保存SYN请求的缓冲区）</span></span><br><span class="line">sysctl -w net.ipv4.tcp_max_syn_backlog=2048</span><br></pre></td></tr></table></figure></p>
<p>关闭ICMP：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=1</span><br></pre></td></tr></table></figure></p>
<p>设置IP Tables防止扫描。</p>
<h2 id="IP-Tables"><a href="#IP-Tables" class="headerlink" title="IP Tables"></a>IP Tables</h2><h1 id="Web-漏洞"><a href="#Web-漏洞" class="headerlink" title="Web 漏洞"></a>Web 漏洞</h1><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>跨站脚本攻击：通过在网站中提交含可执行代码的内容，被其他用户访问的时候执行。</p>
<p>类型包括：<br>反射型：URL带注入。可以用短网址隐藏。<br>存储型：存到数据库。其他用户访问时被攻击。</p>
<h3 id="注入点"><a href="#注入点" class="headerlink" title="注入点"></a>注入点</h3><p>HTML 结点内容：用户输入的动态信息。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>HTML 属性：由用户输入。<br>用户输入了 <code>1&quot; onerror=&quot;alert(1)</code><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">"alert(1)"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>JavaScript 代码。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">富文本。</span><br><span class="line">```html</span><br></pre></td></tr></table></figure></p>
<h3 id="拦截"><a href="#拦截" class="headerlink" title="拦截"></a>拦截</h3><p>设置Header：关闭可能的XSS攻击（浏览器自带功能）。只拦截反射型，且只拦截HTML内容和属性种的。：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">'X-XSS-Protection'</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>转义：将<code>&lt;, &gt;, &quot;, &#39;, ...</code>替换为HTML实体。可以在上传时替换，也可以在显示时替换。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">str = str.replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>);</span><br><span class="line">str = str.replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>);</span><br><span class="line">str = str.replace(<span class="regexp">/"/g</span>, <span class="string">'&amp;quto;'</span>);</span><br><span class="line">str = str.replace(<span class="regexp">/'/g</span>, <span class="string">'&amp;#39;'</span>);</span><br><span class="line">str = str.replace(<span class="regexp">/ /g</span>, <span class="string">'&amp;#32;'</span>);</span><br></pre></td></tr></table></figure></p>
<p>同时转义Javascript内部的代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str = str.replace(<span class="regexp">/\\/g</span>, <span class="string">'\\\\'</span>);  <span class="comment">// 放在最前</span></span><br><span class="line">str = str.replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>);</span><br><span class="line">str = str.replace(<span class="regexp">/'/g</span>, <span class="string">'\\'</span><span class="string">');</span></span><br></pre></td></tr></table></figure></p>
<p>Javascript内部的代码最保险的方法是使用Encode：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.stringify();</span><br></pre></td></tr></table></figure></p>
<p>富文本的过滤：富文本最复杂，使用黑名单和白名单。一般在输入时过滤。<br>黑名单方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;script&gt;</span></span><br><span class="line">str = str.replace(<span class="regexp">/&lt;\s*\/?script\s*/</span>&gt;);  </span><br><span class="line"><span class="comment">// &lt;a href="javascript:alert(1)"&gt;123&lt;/a&gt;</span></span><br><span class="line">str = str.replace(<span class="regexp">/javascript:[^'"]*/</span>&gt;);</span><br><span class="line"><span class="comment">// &lt;img src="123" onerror="alert(1)"&gt;  </span></span><br><span class="line">str = str.replace(<span class="regexp">/onerror\s*=\s*/</span>&gt;);</span><br><span class="line"><span class="comment">// 其他形式 ...</span></span><br></pre></td></tr></table></figure></p>
<p>白名单方法：先解析HTML，再将必要的标签输出<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>)</span><br><span class="line"><span class="keyword">const</span> $ = cheerio.load(HTML_To_Filt)</span><br><span class="line"><span class="keyword">var</span> white_list = &#123;</span><br><span class="line">    <span class="string">'img'</span>: [<span class="string">'src'</span>]</span><br><span class="line">&#125;</span><br><span class="line">$(<span class="string">'*'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">index, elem</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!white_list[elem.name])&#123;</span><br><span class="line">        $(elem).remove();</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> attr <span class="keyword">in</span> elem.attribs)&#123;</span><br><span class="line">        <span class="keyword">if</span>(white_list[elem.name].indexOf(attr) === <span class="number">-1</span>)&#123;</span><br><span class="line">            $(elem).attr(attr, <span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">$.html()</span><br></pre></td></tr></table></figure></p>
<h3 id="XSS-拦截集成库"><a href="#XSS-拦截集成库" class="headerlink" title="XSS 拦截集成库"></a>XSS 拦截集成库</h3><p><a href="https://github.com/leizongmin/js-xss.git" target="_blank" rel="noopener">Github 地址</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xss = <span class="built_in">require</span>(<span class="string">'xss'</span>)</span><br><span class="line"><span class="keyword">var</span> html = xss(<span class="string">''</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="CSP-内容安全策略"><a href="#CSP-内容安全策略" class="headerlink" title="CSP 内容安全策略"></a>CSP 内容安全策略</h3><p>HTTP头，用于指定哪些可以执行。<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self' http://www.com; content-src 'none'; script-src http://www.com</span><br></pre></td></tr></table></figure></p>
<h2 id="CSRF-跨站请求伪造"><a href="#CSRF-跨站请求伪造" class="headerlink" title="CSRF 跨站请求伪造"></a>CSRF 跨站请求伪造</h2><p>用户打开某一个第三方网站，则第三方网站伪装成用户在某网站进行操作。甚至可以用来制造网络蠕虫。</p>
<p>攻击步骤：</p>
<ol>
<li>用户登录A网站</li>
<li>A网站确认身份</li>
<li>B网站前端向A网站发起请求，附带身份</li>
</ol>
<p>危害：</p>
<ul>
<li>冒用用户的身份</li>
<li>用户不知情</li>
<li>盗取用户资金</li>
</ul>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p>禁止第三方网站前端带Cookies访问：<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Set-Cookie</span>: samesite=strict</span><br><span class="line"><span class="attribute">Set-Cookie</span>: samesite=lax</span><br></pre></td></tr></table></figure></p>
<p>但该方法只有Chrome和苹果浏览器支持。</p>
<p>使用验证码和Token：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证码</span></span><br><span class="line"><span class="keyword">var</span> captcha = ccap(); <span class="comment">// 调用外部模块生成验证码</span></span><br><span class="line"><span class="keyword">var</span> data = captcha.get(); <span class="comment">// 0 - 图片  1 - 文字</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Token</span></span><br><span class="line"><span class="comment">// 后端生成Token，表单或Meta中一份，Cookie中一份。</span></span><br><span class="line"><span class="comment">// 后端收到提交后，判断表单和Cookie中Token是否一致。</span></span><br><span class="line"><span class="comment">// 攻击者没有表单中的Token，也拿不到Cookie中的Token。</span></span><br></pre></td></tr></table></figure></p>
<p>验证Referer：Referer是HTTP请求头中的部分，可以通过验证该字段是否是A网站来判断请求的合法性。<br>但是有时一些浏览器没有Referer，因此这种验证是否需要要看需求。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这种验证方法仍然有局限性，可以使用正则表达式</span></span><br><span class="line"><span class="keyword">var</span> referer = ctx.request.headers.referer;</span><br><span class="line"><span class="keyword">if</span>(referer.indexOf(<span class="string">'localhost'</span>) === <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Request Error'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h2><p>特点：</p>
<ul>
<li>存储在前端</li>
<li>后端可以通过设置HTTP头，设置Cookie</li>
<li>请求时，通过HTTP头，交给后端</li>
<li>前端也可以读写</li>
<li>遵守同源策略：协议，域名，端口必须一致。</li>
<li>有有效期</li>
<li>可以用路径(Path)分类</li>
<li>HTTP-ONLY</li>
<li>HTTPS-ONLY (Security)</li>
</ul>
<p>操作：</p>
<ul>
<li>删除：通过设置有效期为过去的时间<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>().toGMTString();</span><br><span class="line"><span class="built_in">document</span>.cookie = <span class="string">'name=1; expires='</span> + now;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>使用：</p>
<ul>
<li>为了防止被篡改，登录凭证使用：用户ID + 签名</li>
<li>也可以用加密</li>
<li>设置HTTP-ONLY / HTTPS-ONLY / same-site</li>
<li>SessionID 一般存放到数据库中</li>
</ul>
<p>与网络攻击：</p>
<ul>
<li>XSS可能偷取Cookie</li>
<li>CSRF利用Cookie，但是无法读写Cookie</li>
</ul>
<h2 id="点击劫持"><a href="#点击劫持" class="headerlink" title="点击劫持"></a>点击劫持</h2><p>通过设置一个透明的IFrame，用另外的页面诱骗用户点击一系列位置（目标网站的一系列按钮）。</p>
<p>防御：防止网站被内嵌。</p>
<ul>
<li><p>使用判断条件：（但是可以被sandbox属性屏蔽）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top !== <span class="built_in">window</span></span><br><span class="line">top.location != <span class="built_in">window</span>.location</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以设置头部：X-FRAME-OPTIONS</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">'X-Frame-Options'</span>, <span class="string">'DENY'</span>); </span><br><span class="line"><span class="comment">// SAME-ORIGIN / ALLOW-FROM / DENY</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置验证码</p>
</li>
</ul>
<h2 id="HTTP-传输窃听"><a href="#HTTP-传输窃听" class="headerlink" title="HTTP 传输窃听"></a>HTTP 传输窃听</h2><h1 id="Windows-逆向"><a href="#Windows-逆向" class="headerlink" title="Windows 逆向"></a>Windows 逆向</h1><h2 id="OD"><a href="#OD" class="headerlink" title="OD"></a>OD</h2><h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>打开程序：F3<br>执行单步语句：F8<br>断点：F2</p>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>CmdBar<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db 0x12FFDC  <span class="comment"># d 表示查看数据  b 表示 byte</span></span><br><span class="line"><span class="comment"># 还可以是 dw dd</span></span><br></pre></td></tr></table></figure></p>
<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p>32位寄存器：<br>EAX 累加器<br>EBX DS段数据指针<br>ECX 计数<br>EDX IO指针<br>ESI 字符串操作源指针 SS段指针<br>ESP 堆栈指针<br>EBP SS段指针<br>EDI 字符串目标指针 ES段指针</p>
<p>16位寄存器：<br>AX, CX, DX, BX, SP, BP, SI, DI<br>0 , 1 , 2 , 3 , 4 , 5 , 6 , 7</p>
<p>8位寄存器：<br>AL, CL, DL, BL, AH, CH, DH, BH<br>0 , 1 , 2 , 3 , 4 , 5 , 6 , 7</p>
<p>如果是64位程序，则所有的寄存器中的E换成R。例如：<br>EAX变为RAX；ESP变为RSP。<br>另外QWORD表示4字64位。</p>
<h3 id="MOV-类"><a href="#MOV-类" class="headerlink" title="MOV 类"></a>MOV 类</h3><p>MOV<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">MOV</span> 通用寄存器/段寄存器/内存, 通用寄存器/段寄存器/内存/立即数</span><br></pre></td></tr></table></figure></p>
<p>源操作数和目标操作数不能同时是内存。<br>源操作数和目标操作数必须等宽。</p>
<p>MOVS<br>允许两边同时为内存。但是执行后，结果依据DF位判断增减的方向。DF为1时，减偏移量。一般用于字符串复制。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOVS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[ebi], <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]</span><br></pre></td></tr></table></figure></p>
<p>MOVSX<br>先符号扩展，再复制变量。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOVSX</span> <span class="built_in">cx</span>, <span class="built_in">al</span></span><br></pre></td></tr></table></figure></p>
<p>MOVZX<br>先零扩展，再复制变量。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOVZX</span> <span class="built_in">cx</span>, <span class="built_in">al</span></span><br></pre></td></tr></table></figure></p>
<h3 id="ADD-SUB"><a href="#ADD-SUB" class="headerlink" title="ADD / SUB"></a>ADD / SUB</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">SUB</span> 目标操作数, 源操作数</span><br></pre></td></tr></table></figure>
<p>源操作数和目标操作数不能同时是内存。<br>结果存入目标操作数的位置。</p>
<h3 id="AND-OR-XOR-NOT"><a href="#AND-OR-XOR-NOT" class="headerlink" title="AND / OR / XOR / NOT"></a>AND / OR / XOR / NOT</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">AND</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">OR</span>  目标操作数, 源操作数</span><br><span class="line"><span class="keyword">XOR</span> 目标操作数, 源操作数</span><br><span class="line"><span class="keyword">NOT</span> 目标操作数</span><br></pre></td></tr></table></figure>
<p>源操作数和目标操作数不能同时是内存。<br>结果存入目标操作数的位置。</p>
<h3 id="ADC-SBB"><a href="#ADC-SBB" class="headerlink" title="ADC / SBB"></a>ADC / SBB</h3><p>通过标志寄存器的进位位计算结果。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ANC 目标操作数, 源操作数 <span class="comment">; 考虑进位的加法</span></span><br><span class="line"><span class="keyword">SBB</span> 目标操作数, 源操作数 <span class="comment">; 考虑进位的减法</span></span><br></pre></td></tr></table></figure></p>
<h3 id="CMP-TEST"><a href="#CMP-TEST" class="headerlink" title="CMP / TEST"></a>CMP / TEST</h3><p>CMP功能和SUB一样，TEST功能和AND一样，但都只修改标志寄存器的值。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMP</span>  目标操作数, 源操作数 </span><br><span class="line"><span class="keyword">TEST</span> 目标操作数, 源操作数</span><br></pre></td></tr></table></figure></p>
<p>CMP判断结果：<br>Z=1：相等。<br>S=1：目标操作数小于源操作数。<br>TEST判断结果：<br><code>TEST eax, eax</code> Z=1：EAX为零。</p>
<h3 id="JCC-类"><a href="#JCC-类" class="headerlink" title="JCC 类"></a>JCC 类</h3><p>JMP：直接修改EIP。不会修改其他寄存器。<br>CALL：会影响堆栈和寄存器。CALL的下一个语句（返回地址）会入栈（ESP）。跳转之后会自动执行，因此需要先加入断点再跳转。<br>RETN：会返回返回地址，会弹栈。相当于POP EIP。如果是<code>RET 8</code>则还会执行<code>ESP+8</code>（内平栈）。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">JE</span> <span class="keyword">JZ</span> 目标操作数       <span class="comment">; ZF=1 相等跳转</span></span><br><span class="line"><span class="keyword">JNE</span> <span class="keyword">JNZ</span> 目标操作数     <span class="comment">; ZF=0 不相等跳转</span></span><br><span class="line"><span class="keyword">JS</span>  目标操作数         <span class="comment">; SF=1 负则跳转</span></span><br><span class="line"><span class="keyword">JNS</span> 目标操作数         <span class="comment">; SF=0 正或0则跳转</span></span><br><span class="line"><span class="keyword">JO</span>  目标操作数         <span class="comment">; OF=1 溢出跳转</span></span><br><span class="line"><span class="keyword">JNO</span> 目标操作数         <span class="comment">; OF=0 不溢出跳转</span></span><br><span class="line"><span class="comment">; 无符号</span></span><br><span class="line"><span class="keyword">JC</span> <span class="keyword">JB</span> <span class="keyword">JNAE</span> 目标操作数  <span class="comment">; CF=1 进位跳转，小于跳转</span></span><br><span class="line"><span class="keyword">JNC</span> <span class="keyword">JNB</span> <span class="keyword">JAE</span> 目标操作数 <span class="comment">; CF=0 无进位跳转，大于等于跳转</span></span><br><span class="line"><span class="keyword">JBE</span> <span class="keyword">JNA</span> 目标操作数     <span class="comment">; ZF=1 或 CF=1 小于等于跳转 </span></span><br><span class="line"><span class="keyword">JNBE</span> <span class="keyword">JA</span> 目标操作数     <span class="comment">; ZF=0 或 CF=0 大于则跳转</span></span><br><span class="line"><span class="comment">; 有符号</span></span><br><span class="line"><span class="keyword">JL</span> <span class="keyword">JNGE</span> 目标操作数     <span class="comment">; SF!=OF 小于则跳转</span></span><br><span class="line"><span class="keyword">JNL</span> <span class="keyword">JGE</span> 目标操作数     <span class="comment">; SF==OF 大于等于则跳转</span></span><br><span class="line"><span class="keyword">JLE</span> <span class="keyword">JNG</span> 目标操作数     <span class="comment">; ZF!=OF 或 ZF=1 小于等于则跳转</span></span><br><span class="line"><span class="keyword">JNLE</span> <span class="keyword">JG</span> 目标操作数     <span class="comment">; SF==OF 且 ZF=0 大于则跳转</span></span><br></pre></td></tr></table></figure></p>
<h3 id="SET-类"><a href="#SET-类" class="headerlink" title="SET 类"></a>SET 类</h3><p>通过判断条件来设置为1。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SETE</span> <span class="built_in">eax</span>  <span class="comment">; 如果相等，则设置为1</span></span><br></pre></td></tr></table></figure></p>
<h3 id="XCHG"><a href="#XCHG" class="headerlink" title="XCHG"></a>XCHG</h3><p>交换<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">XCHG</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ebx</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="STOS"><a href="#STOS" class="headerlink" title="STOS"></a>STOS</h3><p>将EAX AX AL的值存放到EDI中。同样增减方向受到DF标志影响。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STOS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="REP"><a href="#REP" class="headerlink" title="REP"></a>REP</h3><p>依据ECX指定重复次数。可以与STOS，MOVS一起用。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REP</span> MOVS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[ebi], <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esi</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h3><p>算术移位：左移，最低位补0，最高位移入CF。右移，最低位移入CF，最高位不变。<br>有符号数右移。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SAL</span>/<span class="keyword">SAR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure></p>
<p>逻辑移位：左移，最低位补0，最高位移入CF。右移，最低位移入CF，最改为补0。<br>无符号数右移。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHL</span>/<span class="keyword">SHR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure></p>
<p>循环移位：溢出位同时进入CF。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROL</span>/<span class="keyword">ROR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure></p>
<p>带进位的循环移位：左移，最高位移入CF，CF移入最低为。右移，最低位移入CF，CF移入最高位。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RCL</span>/<span class="keyword">RCR</span> 目标操作数, 移位次数</span><br></pre></td></tr></table></figure></p>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p>BYTE  8 bits<br>WORD  16 bits<br>DWORD 32 bits<br>内存单元宽度 8 bits</p>
<p>以32位计算机为例：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> [<span class="number">0x12345678</span>], <span class="number">0xFFFF</span>  <span class="comment">;不推荐</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">word</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x12345678</span>], <span class="number">0xFFFF</span></span><br><span class="line"><span class="comment">; MOV 数据宽度 地址（指针） 段寄存器：[地址编号], 0xFFFF</span></span><br></pre></td></tr></table></figure></p>
<p>每个程序都有一个独立的程序空间。以32位程序为例，程序独有一个4GB的程序空间。但是大多数空间不允许访问。</p>
<p>内存寻址方式：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 立即数</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x123456</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x123456</span>], <span class="built_in">eax</span>  <span class="comment">; 写</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="number">0x123456</span>]  <span class="comment">; 获取内存地址</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">esp</span> + <span class="number">8</span>]   <span class="comment">; 获取内存地址</span></span><br><span class="line"><span class="comment">; 寄存器寻址</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span> + <span class="number">1</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span> + <span class="built_in">ecx</span> * <span class="number">2</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">eax</span> + <span class="built_in">ecx</span> * <span class="number">2</span> + <span class="number">3</span>]  <span class="comment">; 读</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">ecx</span>], <span class="built_in">eax</span>  <span class="comment">; 写</span></span><br></pre></td></tr></table></figure></p>
<h3 id="堆栈"><a href="#堆栈" class="headerlink" title="堆栈"></a>堆栈</h3><p>在Windows中，栈由高地址向低地址生长。增加元素时，栈顶指针减小。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 创建栈顶栈底</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ebx</span>, <span class="number">0x12FFE0</span>   <span class="comment">; 栈底</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="number">0x12FFE0</span>   <span class="comment">; 栈顶</span></span><br><span class="line"><span class="comment">; 存放</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span> - <span class="number">4</span>], <span class="number">0xAAAAAAAA</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">edx</span>, <span class="number">4</span></span><br><span class="line"><span class="comment">;     或</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span> - <span class="number">4</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ds</span>:[<span class="built_in">edx</span>], <span class="number">0xBBBBBBBB</span></span><br></pre></td></tr></table></figure>
<p>专用栈：<br>ESP 栈顶<br>EBP 栈底<br>PUSH、POP 只能是16位或32位<br>栈顶指针移动的偏移量，如果是立即数，则偏移4，如果是容器，则偏移容器大小（push ax，偏移2个）</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="number">0x12345678</span>   <span class="comment">; 立即数，寄存器，内存</span></span><br><span class="line"><span class="keyword">POP</span>  <span class="built_in">eax</span>          <span class="comment">; 寄存器，内存</span></span><br><span class="line"><span class="keyword">PUSHAD</span> <span class="comment">; 存入所有寄存器</span></span><br><span class="line"><span class="keyword">POPAD</span>  <span class="comment">; 弹出所有寄存器</span></span><br></pre></td></tr></table></figure>
<h3 id="标志寄存器"><a href="#标志寄存器" class="headerlink" title="标志寄存器"></a>标志寄存器</h3><p>0  CF：进位借位标志寄存器<br>2  PF：结果中1的个数是不是偶数<br>4  AF：辅助进位标志（32位时看16位是否进位，16位时看8位是否进位）<br>6  ZF：零标志位，判断结果是否为0<br>7  SF：符号标志，计算结果的最高位<br>8  TF：<br>9  IF：<br>10 DF：方向标志，<br>11 OF：溢出标志位</p>
<h3 id="堆栈图"><a href="#堆栈图" class="headerlink" title="堆栈图"></a>堆栈图</h3><p>栈是由高地址向低地址生长。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 传入参数</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="number">1</span>    <span class="comment">; 也可以通过寄存器传入</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="number">2</span></span><br><span class="line"><span class="comment">; 调用</span></span><br><span class="line"><span class="keyword">CALL</span> <span class="number">0x40</span>  <span class="comment">; EIP 会变化，返回地址入栈（ESP）</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">ESP</span>, <span class="number">8</span> <span class="comment">; 去掉调用的参数（在函数外平衡堆栈，外平栈）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 0x40 程序，Debug 版本</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">EBP</span>      <span class="comment">; 旧栈入栈</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">EBP</span>, <span class="built_in">ESP</span>  <span class="comment">; 创建新栈，新栈底存存放旧栈栈底地址</span></span><br><span class="line"><span class="keyword">SUB</span> <span class="built_in">ESP</span>, <span class="number">40</span>   <span class="comment">; 生成缓冲区，大小不确定</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">EBX</span>      <span class="comment">;  </span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">ESI</span>      <span class="comment">; </span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">EDI</span>      <span class="comment">; 保存寄存器现场</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">edi</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> - <span class="number">40</span>]<span class="comment">; 将第1个缓冲区地址放入EDI</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ECX</span>, <span class="number">10</span>   <span class="comment">; 设置循环次数</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">EAX</span>, <span class="number">0xCCCCCCCC</span>             <span class="comment">; 赋值，CC是INT3，表示断点，防止缓冲区溢出</span></span><br><span class="line"><span class="keyword">REP</span> STOS <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> + <span class="number">8</span>] <span class="comment">; 缓冲区全部赋值为EAX</span></span><br><span class="line"><span class="comment">; 程序主要部分</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> + <span class="number">8</span>] <span class="comment">; 使用第1个参数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">ss</span>:[<span class="built_in">ebp</span> + C] <span class="comment">; 使用第2个参数</span></span><br><span class="line"><span class="comment">; 返回部分</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">EDI</span></span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">ESI</span>  </span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">EBX</span>       <span class="comment">; 恢复现场</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ESP</span>, <span class="built_in">EBP</span>  </span><br><span class="line"><span class="keyword">POP</span> <span class="built_in">EBP</span>       <span class="comment">; 弹出旧栈</span></span><br><span class="line"><span class="keyword">RETN</span>          <span class="comment">; 返回值在EAX中</span></span><br></pre></td></tr></table></figure>
<h3 id="Windows-堆栈"><a href="#Windows-堆栈" class="headerlink" title="Windows 堆栈"></a>Windows 堆栈</h3><ol>
<li>先进后出</li>
<li>向低地址扩展</li>
</ol>
<h3 id="裸函数"><a href="#裸函数" class="headerlink" title="裸函数"></a>裸函数</h3><p>编译器完全不管的函数。由CALL调用后跳转到函数中，函数没有任何汇编代码，全部都是INT3。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __declspec(naked) Plus()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>C语言里面也可以加入汇编。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __declspec(naked) Plus()</span><br><span class="line">&#123;</span><br><span class="line">    __asm&#123;  <span class="comment">// _asm 也可以</span></span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __declspec(naked) Plus(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span><br><span class="line">&#123;</span><br><span class="line">    __asm&#123; </span><br><span class="line">        <span class="comment">// 提升堆栈</span></span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp, esp</span><br><span class="line">        sub esp, <span class="number">0x40</span></span><br><span class="line">        <span class="comment">// 保留现场</span></span><br><span class="line">        push ebx</span><br><span class="line">        push esi</span><br><span class="line">        push edi</span><br><span class="line">        <span class="comment">// 填充缓冲区</span></span><br><span class="line">        mov eax, <span class="number">0xCCCCCCCC</span></span><br><span class="line">        mov ecx, <span class="number">0x10</span></span><br><span class="line">        lea edi, dword ptr ds:[epb - <span class="number">0x40</span>]</span><br><span class="line">        rep stosd</span><br><span class="line">        <span class="comment">// 主要功能</span></span><br><span class="line">        mov eax, dword ptr ds:[ebp + <span class="number">0x8</span>]</span><br><span class="line">        add eax, dword ptr ds:[ebp + <span class="number">0xC</span>]</span><br><span class="line">        <span class="comment">// 恢复现场</span></span><br><span class="line">        pop edi</span><br><span class="line">        pop esi</span><br><span class="line">        pop ebx</span><br><span class="line">        <span class="comment">// 恢复堆栈</span></span><br><span class="line">        mov esp, ebp</span><br><span class="line">        pop ebp</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__declspec</code>关键字用法：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 规定内存对齐的位置，不规定占用的长度</span></span><br><span class="line"><span class="comment">// #pragma pack() 规定内存对齐的最小值</span></span><br><span class="line">__declspec(align(<span class="number">32</span>)) </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stu</span>&#123;</span> <span class="keyword">int</span> a, b, c &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明数据段的一个数据项</span></span><br><span class="line"><span class="comment">// 与 #pragma code_seg, const_seg, data_seg, section, init_seg 配合使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg(<span class="meta-string">"share_data"</span>)</span></span><br><span class="line"><span class="keyword">int</span> a;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg() __declspec(allocate(<span class="meta-string">"share_data"</span>)) int c = 1;</span></span><br><span class="line">__declspec(allocate(<span class="string">"share_data"</span>)) <span class="keyword">int</span> d;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL调用与输出</span></span><br><span class="line"><span class="comment">// 输出端</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> ___<span class="title">declspec</span>(<span class="title">dllexport</span>)</span></span><br><span class="line"><span class="class"><span class="title">DllExport</span>&#123;</span>  </span><br><span class="line">    DllExport()&#123;&#125;;</span><br><span class="line">    ~DllExport()&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 输入端</span></span><br><span class="line"><span class="meta">#import comment(lib, <span class="meta-string">"dll_name.lib"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> ___<span class="title">declspec</span>(<span class="title">dllimportt</span>)</span></span><br><span class="line"><span class="class"><span class="title">DllExport</span>&#123;</span>  </span><br><span class="line">    DllExport()&#123;&#125;;</span><br><span class="line">    ~DllExport()&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 裸函数</span></span><br><span class="line"><span class="comment">// 仅在x86中有效，仅对函数有效</span></span><br><span class="line"><span class="keyword">void</span> __declspec(naked) func()&#123;</span><br><span class="line">    __asm &#123; ret &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// selectany</span></span><br><span class="line"><span class="comment">// 允许在.h文件中创建全局变量</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stu</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line">&#125;</span><br><span class="line">__declspec(selectany) <span class="keyword">int</span> Stu::count = <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h3><p>有如下调用约定，规定参数的传递，返回值的传递。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">plus</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span>     <span class="comment">// C/C++默认，从右向左压入参数，外平栈</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> __stdcall <span class="title">plus</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span>   <span class="comment">// WIN32 API，从右向左压入参数，内平栈</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">plus</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span>  <span class="comment">// ECX/EDX存入前两个，其他的从右向左压入，内平栈</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="程序入口"><a href="#程序入口" class="headerlink" title="程序入口"></a>程序入口</h3><p>控制台程序中，C语言程序运行后，函数堆栈如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main(<span class="keyword">int</span> <span class="number">1</span>, <span class="keyword">char</span>**)   <span class="comment">// 编程入口</span></span><br><span class="line">mainCRTStartup()      <span class="comment">// 真正的入口，Link-&gt;Output-&gt;Entry-point symbol中规定</span></span><br><span class="line">KERNEL32! <span class="number">7</span>c816d4f()  <span class="comment">//</span></span><br></pre></td></tr></table></figure></p>
<p><code>mainCRTStartup()</code>函数在<code>main()</code>之前先初始化：</p>
<ol>
<li>获取系统版本    GetVersion()</li>
<li>堆初始化        _heap_init()</li>
<li>获取命令行参数  GetCommandLineA()</li>
<li>获取环境变量    _crtGetEnvironmentStringA()</li>
<li>设置参数       _setargv()</li>
<li>设置环境PATH   _setenvp()</li>
<li>初始化C        _cinit()</li>
<li>调用<code>main(__argc, __argv, _environ)</code></li>
</ol>
<p>找Main方法，就是去找3个参数的方法。例如：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="built_in">edx</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">eax</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">CALL</span> ...</span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">0xC</span></span><br></pre></td></tr></table></figure></p>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>四种数据类型：</p>
<ol>
<li>基本类型：整数，浮点</li>
<li>构造类型：数组，结构体，联合体</li>
<li>指针类型</li>
<li>空类型：void</li>
</ol>
<p>有符号的和无符号的数存放方式一样，在使用时候才会区分。一般是类型转换，比较大小，数学运算中会区别使用。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 内存对齐</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], 0xFFh   <span class="comment">; 有符号无符号存储时都一样</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">word</span> <span class="built_in">ptr</span> [epb - <span class="number">8</span>], 0xFFh</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">0xC</span>], 0xFFh</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 比较有符号数</span></span><br><span class="line"><span class="keyword">JLE</span> </span><br><span class="line"><span class="comment">; 比较无符号数</span></span><br><span class="line"><span class="keyword">JBE</span></span><br></pre></td></tr></table></figure>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>传入参数<br>传参时，由于使用PUSH，因此不论是何种类型，一律是传入32位数据。</p>
<p>返回值<br>一般情况下，返回值放到EAX中，如果是64位数据，则高位放到EDX，低位放到EAX中。</p>
<p>局部变量<br>一般直接分配32位的整数倍，不论是char，short还是int。</p>
<p>数组<br>一般是按照32位的整数倍为数组分配空间。例如：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> x[<span class="number">5</span>];  <span class="comment">// 占8字节</span></span><br></pre></td></tr></table></figure></p>
<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><p>如果遇到连续赋值，但内存单元不是等宽，那么很有可能是结构体。<br>传参数传递结构体时，将结构体复制到栈里面。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SUB</span> <span class="built_in">esp</span>, <span class="number">18h</span>          <span class="comment">; 结构体大小</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="number">6</span>            <span class="comment">; 复制次数</span></span><br><span class="line"><span class="keyword">LEA</span> <span class="built_in">esi</span>, [<span class="built_in">ebp</span> - <span class="number">18h</span>]  <span class="comment">; 复制开始的地址  ESI</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edi</span>, <span class="built_in">esp</span>          <span class="comment">; 子程序栈上  EDI </span></span><br><span class="line"><span class="keyword">REP</span> MOVS <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>], <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>]  <span class="comment">; 复制</span></span><br></pre></td></tr></table></figure></p>
<p>做函数返回值时候，主函数首先创建缓冲区<code>LEA eax, [ebp-30h]</code>，之后<code>PUSH eax</code>，也就是将缓冲区地址传入子程序中。但是在函数执行完后，还要将数据从缓冲区复制到自己的局部变量里面。</p>
<p>结构体要数组对齐。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pach(n)  <span class="comment">// 自定义对齐</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack()   <span class="comment">// 恢复默认对齐</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="Sizeof"><a href="#Sizeof" class="headerlink" title="Sizeof"></a>Sizeof</h3><p>Sizeof是一个关键字，用于获取类型大小，结构体大小，数组占的内存大小。</p>
<h3 id="内存图"><a href="#内存图" class="headerlink" title="内存图"></a>内存图</h3><p>内存区域：</p>
<ol>
<li>代码区：可读，可执行</li>
<li>栈：参数，局部变量，临时数据</li>
<li>堆</li>
<li>全局变量：可读写</li>
<li>常量：可读</li>
</ol>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 全局变量特点：</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="number">0x00427320</span>], <span class="built_in">eax</span>   <span class="comment">; 直接写到某个地址</span></span><br><span class="line"><span class="comment">; 局部变量特点：</span></span><br><span class="line"><span class="keyword">mov</span> dwprd <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="built_in">eax</span>      <span class="comment">; 基址加偏移</span></span><br></pre></td></tr></table></figure>
<h3 id="分支语句"><a href="#分支语句" class="headerlink" title="分支语句"></a>分支语句</h3><p>IF 语句<br>当遇到CMP/TEST等影响标志位的命令，之后紧接JCC，则为IF。<br>汇编中和C语言中一般是反过来的。汇编中，如果满足条件则跳出；C语言中，如果满足条件则执行。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; IF</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">eax</span>, dowrd <span class="built_in">ptr</span> [epb + <span class="number">0xC</span>]</span><br><span class="line"><span class="keyword">JLE</span> <span class="number">0x00401049</span>  <span class="comment">; JMP 的下一行代码地址</span></span><br><span class="line"><span class="comment">; ...</span></span><br><span class="line"><span class="comment">; ELSE</span></span><br><span class="line"><span class="keyword">JMP</span> <span class="number">0x00401060</span>  <span class="comment">; IF 语句的结束位置</span></span><br><span class="line"><span class="comment">; ...</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; IF (a &gt; 1 &amp;&amp; b &gt; 1 &amp;&amp; c &gt; 1)</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="comment">; 条件 1</span></span><br><span class="line"><span class="keyword">JLE</span> <span class="comment">; 复合条件 则继续判断；否则跳到结尾</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="comment">; 条件 2</span></span><br><span class="line"><span class="keyword">JLE</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="comment">; 条件 3</span></span><br><span class="line"><span class="keyword">JLE</span></span><br><span class="line"><span class="comment">; 结尾</span></span><br></pre></td></tr></table></figure>
<p>SWITCH 语句</p>
<ol>
<li>当情况数较少时候（2 Cases + Default）实现和IF一样。</li>
<li><p>当情况数较多时候（4个分支时候），则生成大情况表。它会将每一个分支地址都存到大表中，然后通过给定的参数直接计算分支的地址直接跳转。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SUB</span> <span class="built_in">ecx</span>, <span class="number">01h</span>   <span class="comment">; 将传入的参数减 Case 1</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="built_in">ecx</span>  </span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="number">3</span>    <span class="comment">; 1 与 3 比较</span></span><br><span class="line"><span class="keyword">JA</span>  xxx                       <span class="comment">; 跳转到 Default</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, dowrd <span class="built_in">ptr</span> [epb - <span class="number">4</span>]  <span class="comment">; 将 1 放到 edx</span></span><br><span class="line"><span class="keyword">JMP</span> dowrd <span class="built_in">ptr</span> [<span class="built_in">edx</span> * <span class="number">4</span> + @ Case <span class="number">1</span>]  <span class="comment">; 依据表得到跳转地址</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>当 CASE 值连续相近时，才采取情况2的方式，如果中间断了一两个，那么空缺的地方则填入Default；如果 CASE 值混乱，则使用情况1方式。</p>
</li>
<li>当 CASE 值不太连续相近，但是又不够混乱时（例如CASE 字母），还会生产小表（CASE值转偏移值的表），之后通过小表查找偏移量，进一步再去查询大表（存放分支地址的表），此时大表中为连续的，不必插入Default。<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SUB</span> <span class="built_in">ecx</span>, <span class="number">01h</span>   <span class="comment">; 将传入的参数减 Case 1</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="built_in">ecx</span>  </span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [epb - <span class="number">4</span>], <span class="number">3</span>    <span class="comment">; 1 与 3 比较</span></span><br><span class="line"><span class="keyword">JA</span>  xxx                       <span class="comment">; 跳转到 Default</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, dowrd <span class="built_in">ptr</span> [epb - <span class="number">4</span>]  <span class="comment">; 将 1 放到 edx</span></span><br><span class="line"><span class="comment">; 新增</span></span><br><span class="line"><span class="keyword">XOR</span> <span class="built_in">edx</span>, <span class="built_in">edx</span>                        <span class="comment">; 清空 edx</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dl</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span> + 表开始地址]  <span class="comment">; 查询小表</span></span><br><span class="line"><span class="keyword">JMP</span> dowrd <span class="built_in">ptr</span> [<span class="built_in">edx</span> * <span class="number">4</span> + @ Case <span class="number">1</span>]  <span class="comment">; 依据小表得到大表中的跳转地址</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><p>do while性能最好。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span>  <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]    <span class="comment">; Start</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">eax</span>                         <span class="comment">; 调用函数的参数</span></span><br><span class="line"><span class="keyword">PUSH</span> offset string</span><br><span class="line"><span class="keyword">CALL</span> printf                      <span class="comment">; 调用函数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">8</span>                       <span class="comment">; 外平栈</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]     <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">ecx</span>, <span class="number">1</span>                       <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>], <span class="built_in">ecx</span>     <span class="comment">; 判断计次变量</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]</span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + 0xCh]</span><br><span class="line"><span class="keyword">JG</span>  Start</span><br></pre></td></tr></table></figure></p>
<p>While语句：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; Start</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + 0xCh]</span><br><span class="line"><span class="keyword">JGE</span> End                           <span class="comment">; 判断是否复合条件</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; 传入参数</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="keyword">PUSH</span> offset string</span><br><span class="line"><span class="keyword">CALL</span> printf                       <span class="comment">; 调用函数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">8</span>                        <span class="comment">; 外平栈</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">edx</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>], <span class="built_in">edx</span>      <span class="comment">; x++</span></span><br><span class="line"><span class="keyword">JMP</span> Start</span><br><span class="line"><span class="comment">; End</span></span><br></pre></td></tr></table></figure></p>
<p>For 语句<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + <span class="number">8</span>]      <span class="comment">; 取传入的参数</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>], <span class="built_in">eax</span>      <span class="comment">; 放入局部变量</span></span><br><span class="line"><span class="keyword">JMP</span> Middle                        <span class="comment">; 跳转到</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>]      <span class="comment">; Start</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">ecx</span>, <span class="number">1</span>                        <span class="comment">; i++</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>], <span class="built_in">ecx</span>      <span class="comment">; i++</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>]      <span class="comment">; Middle</span></span><br><span class="line"><span class="keyword">CMP</span> <span class="built_in">edx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> + 0xCh]   </span><br><span class="line"><span class="keyword">JGE</span> End                           <span class="comment">; 与传入的另一参数判断大小</span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">eax</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">4</span>]      <span class="comment">; 传入参数，调用Printf</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="built_in">eax</span></span><br><span class="line"><span class="keyword">PUSH</span> offset string</span><br><span class="line"><span class="keyword">CALL</span> printf                       <span class="comment">; 调用函数</span></span><br><span class="line"><span class="keyword">ADD</span> <span class="built_in">esp</span>, <span class="number">8</span>                        <span class="comment">; 外平栈</span></span><br><span class="line"><span class="keyword">JMP</span> Start</span><br><span class="line"><span class="comment">; End</span></span><br></pre></td></tr></table></figure></p>
<h3 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h3><p>32位机下，指针不论指向何种类型，都是32位4字节。<br>64位机下，指针不论指向何种类型，都是64位8字节。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; int x = *px;</span></span><br><span class="line"><span class="comment">; 寄存器间接寻址 </span></span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">ecx</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - <span class="number">8</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">edx</span>, dowrd <span class="built_in">ptr</span> [<span class="built_in">ecx</span>]</span><br><span class="line"><span class="keyword">MOV</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span> - 0xCh], <span class="built_in">edx</span></span><br></pre></td></tr></table></figure>
<h3 id="加壳"><a href="#加壳" class="headerlink" title="加壳"></a>加壳</h3><p>将需要保护的代码的硬编码放到数据区，并将代码区变为全零。<br>可以用位运算对代码加密，例如对执行代码取反后保存。<br>用一个进程执行另一个程序的代码，隐藏原程序。</p>
<h3 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h3><p>Windows程序在内存或硬盘中结构一般有这几部分：</p>
<ul>
<li>DOS 头</li>
<li>填充数据（无用，长度可变）</li>
<li>NT 头（标准PE头，可选PE头）</li>
<li>节表（各个节的位置）</li>
<li>节 x N （数据段，代码段等）</li>
</ul>
<p>程序在硬盘中和在运行时的二进制数据不一样。区别：</p>
<ol>
<li>地址起始位置：硬盘中从0开始，内存中不是。</li>
<li>对齐方式：早期程序，在硬盘中对齐单位是200h。现代程序对齐单位一般是1000h。内存中对齐一般是1000h。</li>
</ol>
<p>DOS 头：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 被注释的部分是16位程序使用的</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span>&#123;</span></span><br><span class="line">    <span class="number">0X00</span> WORD e_magic;      <span class="comment">//※Magic DOS signature MZ(4Dh 5Ah):MZ标记:用于标记是否是可执行文件</span></span><br><span class="line">    <span class="comment">//0X02 WORD e_cblp;     //Bytes on last page of file</span></span><br><span class="line">    <span class="comment">//0X04 WORD e_cp;       //Pages in file</span></span><br><span class="line">    <span class="comment">//0X06 WORD e_crlc;     //Relocations</span></span><br><span class="line">    <span class="comment">//0X08 WORD e_cparhdr;  //Size of header in paragraphs</span></span><br><span class="line">    <span class="comment">//0X0A WORD e_minalloc; //Minimun extra paragraphs needs</span></span><br><span class="line">    <span class="comment">//0X0C WORD e_maxalloc; //Maximun extra paragraphs needs</span></span><br><span class="line">    <span class="comment">//0X0E WORD e_ss;       //intial(relative)SS value</span></span><br><span class="line">    <span class="comment">//0X10 WORD e_sp;       //intial SP value</span></span><br><span class="line">    <span class="comment">//0X12 WORD e_csum;     //Checksum</span></span><br><span class="line">    <span class="comment">//0X14 WORD e_ip;       //intial IP value</span></span><br><span class="line">    <span class="comment">//0X16 WORD e_cs;       //intial(relative)CS value</span></span><br><span class="line">    <span class="comment">//0X18 WORD e_lfarlc;   //File Address of relocation table</span></span><br><span class="line">    <span class="comment">//0X1A WORD e_ovno;     //Overlay number</span></span><br><span class="line">    <span class="comment">//0x1C WORD e_res[4];   //Reserved words</span></span><br><span class="line">    <span class="comment">//0x24 WORD e_oemid;    //OEM identifier(for e_oeminfo)</span></span><br><span class="line">    <span class="comment">//0x26 WORD e_oeminfo;  //OEM information;e_oemid specific</span></span><br><span class="line">    <span class="comment">//0x28 WORD e_res2[10]; //Reserved words</span></span><br><span class="line">    <span class="number">0x3C</span> DWORD e_lfanew;    <span class="comment">//※Offset to start of PE header:定位PE文件，PE头相对于文件的偏移量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>NT 头：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NT 头</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span>&#123;</span></span><br><span class="line">    <span class="number">0x00</span> DWORD Signature;   <span class="comment">//PE文件标识:ASCII的"PE\0\0"  50h 45h</span></span><br><span class="line">    <span class="number">0x04</span> _IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    <span class="number">0x18</span> _IMAGE_OPTIONAL_HEADER OptionalHeader;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>标准 PE 头：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span>&#123;</span></span><br><span class="line">    <span class="number">0x00</span> WORD Machine;                  <span class="comment">//※程序执行的CPU平台:0X0:任何平台，0X14C:intel i386及后续处理器</span></span><br><span class="line">    <span class="number">0x02</span> WORD NumberOfSections;         <span class="comment">//※PE文件中区块数量</span></span><br><span class="line">    <span class="number">0x04</span> DWORD TimeDateStamp;           <span class="comment">//时间戳：连接器产生此文件的时间距1969/12/31-16:00P:00的总秒数</span></span><br><span class="line">    <span class="comment">//0x08 DWORD PointerToSymbolTable;  //COFF符号表格的偏移位置。此字段只对COFF除错信息有用</span></span><br><span class="line">    <span class="comment">//0x0c DWORD NumberOfSymbols;       //COFF符号表格中的符号个数。该值和上一个值在release版本的程序里为0</span></span><br><span class="line">    <span class="number">0x10</span> WORD SizeOfOptionalHeader;   <span class="comment">//IMAGE_OPTIONAL_HEADER结构的大小(字节数):32位默认E0H,64位默认F0H(可修改)</span></span><br><span class="line">    <span class="number">0x12</span> WORD Characteristics;          <span class="comment">//※描述文件属性,eg:</span></span><br><span class="line">                                        <span class="comment">//单属性(只有1bit为1)：#define IMAGE_FILE_DLL 0x2000  //File is a DLL.</span></span><br><span class="line">                                        <span class="comment">//组合属性(多个bit为1，单属性或运算):0X010F 可执行文件</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可选 PE 头：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span>&#123;</span></span><br><span class="line">    <span class="number">0x00</span> WORD Magic;                    <span class="comment">//※幻数(魔数)，0x0107:ROM image,0x010B:32位PE，0X020B:64位PE </span></span><br><span class="line">    <span class="comment">//0x02 BYTE MajorLinkerVersion;     //连接器主版本号</span></span><br><span class="line">    <span class="comment">//0x03 BYTE MinorLinkerVersion;     //连接器副版本号</span></span><br><span class="line">    <span class="number">0x04</span> DWORD SizeOfCode;              <span class="comment">//所有代码段的总和大小,注意：必须是FileAlignment的整数倍,存在但没用</span></span><br><span class="line">    <span class="number">0x08</span> DWORD SizeOfInitializedData;   <span class="comment">//已经初始化数据的大小,注意：必须是FileAlignment的整数倍,存在但没用</span></span><br><span class="line">    <span class="number">0x0c</span> DWORD SizeOfUninitializedData; <span class="comment">//未经初始化数据的大小,注意：必须是FileAlignment的整数倍,存在但没用</span></span><br><span class="line">    <span class="number">0x10</span> DWORD AddressOfEntryPoint;     <span class="comment">//※程序入口地址OEP，这是一个RVA(Relative Virtual Address),通常会落在.textsection,此字段对于DLLs/EXEs都适用。</span></span><br><span class="line">    <span class="number">0x14</span> DWORD BaseOfCode;              <span class="comment">//代码段起始地址(代码基址),(代码的开始和程序无必然联系)</span></span><br><span class="line">    <span class="number">0x18</span> DWORD BaseOfData;              <span class="comment">//数据段起始地址(数据基址)</span></span><br><span class="line">    <span class="number">0x1c</span> DWORD ImageBase;               <span class="comment">//※内存镜像基址(默认装入起始地址),默认为4000H</span></span><br><span class="line">    <span class="number">0x20</span> DWORD SectionAlignment;        <span class="comment">//※内存对齐:一旦映像到内存中，每一个section保证从一个「此值之倍数」的虚拟地址开始</span></span><br><span class="line">    <span class="number">0x24</span> DWORD FileAlignment;           <span class="comment">//※文件对齐：最初是200H，现在是1000H</span></span><br><span class="line">    <span class="comment">//0x28 WORD MajorOperatingSystemVersion;    //所需操作系统主版本号</span></span><br><span class="line">    <span class="comment">//0x2a WORD MinorOperatingSystemVersion;    //所需操作系统副版本号</span></span><br><span class="line">    <span class="comment">//0x2c WORD MajorImageVersion;              //自定义主版本号,使用连接器的参数设置,eg:LINK /VERSION:2.0 myobj.obj</span></span><br><span class="line">    <span class="comment">//0x2e WORD MinorImageVersion;              //自定义副版本号,使用连接器的参数设置</span></span><br><span class="line">    <span class="comment">//0x30 WORD MajorSubsystemVersion;          //所需子系统主版本号,典型数值4.0(Windows 4.0/即Windows 95)</span></span><br><span class="line">    <span class="comment">//0x32 WORD MinorSubsystemVersion;          //所需子系统副版本号</span></span><br><span class="line">    <span class="comment">//0x34 DWORD Win32VersionValue;             //总是0</span></span><br><span class="line">    <span class="number">0x38</span> DWORD SizeOfImage;         <span class="comment">//※PE文件在内存中映像总大小,sizeof(ImageBuffer),SectionAlignment的倍数</span></span><br><span class="line">    <span class="number">0x3c</span> DWORD SizeOfHeaders;       <span class="comment">//※DOS头(64B)+PE标记(4B)+标准PE头(20B)+可选PE头+节表的总大小，按照文件对齐(FileAlignment的倍数)</span></span><br><span class="line">    <span class="number">0x40</span> DWORD CheckSum;            <span class="comment">//PE文件CRC校验和，判断文件是否被修改</span></span><br><span class="line">    <span class="comment">//0x44 WORD Subsystem;          //用户界面使用的子系统类型</span></span><br><span class="line">    <span class="comment">//0x46 WORD DllCharacteristics;   //总是0</span></span><br><span class="line">    <span class="number">0x48</span> DWORD SizeOfStackReserve;  <span class="comment">//默认线程初始化栈的保留大小</span></span><br><span class="line">    <span class="number">0x4c</span> DWORD SizeOfStackCommit;   <span class="comment">//初始化时实际提交的线程栈大小</span></span><br><span class="line">    <span class="number">0x50</span> DWORD SizeOfHeapReserve;   <span class="comment">//默认保留给初始化的process heap的虚拟内存大小</span></span><br><span class="line">    <span class="number">0x54</span> DWORD SizeOfHeapCommit;    <span class="comment">//初始化时实际提交的process heap大小</span></span><br><span class="line">    <span class="comment">//0x58 DWORD LoaderFlags;       //总是0</span></span><br><span class="line">    <span class="number">0x5c</span> DWORD NumberOfRvaAndSizes; <span class="comment">//目录项数目：总为0X00000010H(16)</span></span><br><span class="line">    <span class="number">0x60</span> _IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<span class="comment">//#define IMAGE_NUMBEROF_DIRECTORY_ENTRIES 16</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>DataDictionary:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span>&#123;</span></span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   Size;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//占用16*8 = 128Byte = 80H = E0H(可选PE头默认大小) - 60H(前面所有成员固定占用大小)</span></span><br></pre></td></tr></table></figure></p>
<p>节表：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span>&#123;</span></span><br><span class="line">    BYTE Name[IMAGE_SIZEOF_SHORT_NAME]; <span class="comment">// 8个字节的节区名称</span></span><br><span class="line">    <span class="keyword">union</span> Misc&#123;</span><br><span class="line">        DWORD PhysicalAddress;       </span><br><span class="line">        DWORD VirtualSize;            <span class="comment">//节区的尺寸</span></span><br><span class="line">    &#125;</span><br><span class="line">    DWORD VirtualAddress;         <span class="comment">// 节区的 RVA 地址</span></span><br><span class="line">    DWORD SizeOfRawData;            <span class="comment">// 在文件中对齐后的尺寸</span></span><br><span class="line">    DWORD PointerToRawData;        <span class="comment">// 在文件中的偏移量</span></span><br><span class="line">    DWORD PointerToRelocations;     <span class="comment">// 在OBJ文件中使用，重定位的偏移</span></span><br><span class="line">    DWORD PointerToLinenumbers;   <span class="comment">// 行号表的偏移（供调试使用地）</span></span><br><span class="line">    WORD NumberOfRelocations;      <span class="comment">// 在OBJ文件中使用，重定位项数目</span></span><br><span class="line">    WORD NumberOfLinenumbers;    <span class="comment">// 行号表中行号的数目</span></span><br><span class="line">    DWORD Characteristics;       <span class="comment">// 节属性如可读，可写，可执行等</span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure></p>
<h3 id="空白区加代码"><a href="#空白区加代码" class="headerlink" title="空白区加代码"></a>空白区加代码</h3><ol>
<li>找到 MessageBoxA 函数。</li>
<li>在可选PE头中找到OEP，修改。</li>
<li>采用硬编码编写。<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">PUSH</span> <span class="comment">; 调用参数     ; 6A 00</span></span><br><span class="line"><span class="keyword">CALL</span> <span class="comment">; OEP 指向这里 ; E8 XX XX XX XX</span></span><br><span class="line"><span class="keyword">JMP</span>  <span class="comment">; OEP 原来的值 ; E9 XX XX XX XX 这个X的值是 要跳转的地址与此条指令的下一条指令地址之间的差</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="节"><a href="#节" class="headerlink" title="节"></a>节</h3><p>当要修改节的内容或新增节时（都是修改拉伸后的内容）：</p>
<ol>
<li>分配空间。（SizeOfImage）</li>
<li>复制头部：DOS, PE, Option PE, 节表。（SizeOfHeaders）</li>
<li>确定每一节的大小。（VirtualSize，SizeOfRawData，SizeOfImage）</li>
<li>确定节的位置。（PointToRawData，VirtualAddress）</li>
<li>修改代码时注意偏移。（ImageBase）</li>
<li>新加入一节，需要在节表中新增条目，修改PE头中节数量，以及SizeOfImage。</li>
<li>节表新加入节条目后，后面需要补一个全零的条目。（40个字节）</li>
<li>当扩大最后一节时，需要修改SizeOfRawData，VirtualSize，SizeOfImage。</li>
<li>当合并节时，需要修改节表。（SizeOfHeaders，SizeOfRawData，VirtualSize，PointToRawData）</li>
</ol>
<p>注意：</p>
<ol>
<li>SizeOfHeaders不可以随便变，一旦改变，下面所有的地址都需要变。</li>
<li>如果节表空间不够，则将NT头网上移动，占据DOS STUB空间。</li>
<li>一旦节表空间不足，DOS STUB空间不足等情况发生，则扩大最后一个节添加数据。</li>
<li>有时节表的后面不一定是空闲空间，也可能是有用数据，就不增加节，而是直接修改现有节。</li>
</ol>
<h3 id="数据字典"><a href="#数据字典" class="headerlink" title="数据字典"></a>数据字典</h3><p>记录了16种不同的信息：<strong>导出表</strong>，<strong>导入表</strong>，资源表，异常信息表，安全证书表，<strong>重定位表</strong>，调试信息表，版权所有表，全局指针表，TLS表，加载配置表，绑定导入表，<strong>IAT表</strong>，延迟导入表，COM信息表，未使用（作为保留）。</p>
<p>Data Dictionary:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span>&#123;</span></span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   Size;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//占用16*8 = 128Byte = 80H = E0H(可选PE头默认大小) - 60H(前面所有成员固定占用大小)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h3><h3 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h3><h3 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h3><h3 id="IAT表"><a href="#IAT表" class="headerlink" title="IAT表"></a>IAT表</h3><h3 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h3><h4 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h4><p>IN OUT<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只是用来标记，没有任何作用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OUT</span></span><br></pre></td></tr></table></figure></p>
<p>LPVOID：等于<code>void *</code></p>
<p>LPSTR：字符串</p>
<p>FILE：文件</p>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LPSTR file_name = <span class="string">"xxx"</span></span><br><span class="line">FILE file = fopen(file_name, <span class="string">"rb"</span>);</span><br><span class="line"><span class="comment">// 获取文件大小</span></span><br><span class="line">fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">DWORD file_size = ftell(file);</span><br><span class="line"><span class="comment">// 指针回归头部</span></span><br><span class="line">fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"><span class="comment">// 读取文件数据</span></span><br><span class="line"><span class="keyword">size_t</span> n = fread(buffer, file_size, <span class="number">1</span>, file);</span><br><span class="line"><span class="comment">// 关闭文件</span></span><br><span class="line">fclose(file);</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kali/" rel="tag"># Kali</a>
          
            <a href="/tags/汇编/" rel="tag"># 汇编</a>
          
            <a href="/tags/逆向/" rel="tag"># 逆向</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/13/BasicLanguage/CPPSTL/" rel="next" title="C++ STL">
                <i class="fa fa-chevron-left"></i> C++ STL
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MzY0MS8yMDE4MA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Peng</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">50</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/yourname" title="GitHub &rarr; https://github.com/yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#综述"><span class="nav-text">综述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kali-渗透测试"><span class="nav-text">Kali 渗透测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#标准"><span class="nav-text">标准</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-扫描与防御"><span class="nav-text">Linux 扫描与防御</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主机扫描"><span class="nav-text">主机扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#netstat-查看端口"><span class="nav-text">netstat 查看端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#禁用-ICMP-连接"><span class="nav-text">禁用 ICMP 连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-Dump"><span class="nav-text">TCP Dump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fping-批量主机扫描工具（ICMP）"><span class="nav-text">fping 批量主机扫描工具（ICMP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hping-批量主机扫描工具（TCP-IP）"><span class="nav-text">hping 批量主机扫描工具（TCP/IP）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由扫描"><span class="nav-text">路由扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Trace-Route"><span class="nav-text">Trace Route</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MTR"><span class="nav-text">MTR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扫描服务"><span class="nav-text">扫描服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NMAP"><span class="nav-text">NMAP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NCAT"><span class="nav-text">NCAT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#攻击防御"><span class="nav-text">攻击防御</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IP-Tables"><span class="nav-text">IP Tables</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Web-漏洞"><span class="nav-text">Web 漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS"><span class="nav-text">XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注入点"><span class="nav-text">注入点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拦截"><span class="nav-text">拦截</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS-拦截集成库"><span class="nav-text">XSS 拦截集成库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSP-内容安全策略"><span class="nav-text">CSP 内容安全策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSRF-跨站请求伪造"><span class="nav-text">CSRF 跨站请求伪造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#防御"><span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookies"><span class="nav-text">Cookies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#点击劫持"><span class="nav-text">点击劫持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-传输窃听"><span class="nav-text">HTTP 传输窃听</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Windows-逆向"><span class="nav-text">Windows 逆向</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OD"><span class="nav-text">OD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#快捷键"><span class="nav-text">快捷键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插件"><span class="nav-text">插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#汇编"><span class="nav-text">汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#寄存器"><span class="nav-text">寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOV-类"><span class="nav-text">MOV 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADD-SUB"><span class="nav-text">ADD / SUB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AND-OR-XOR-NOT"><span class="nav-text">AND / OR / XOR / NOT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADC-SBB"><span class="nav-text">ADC / SBB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CMP-TEST"><span class="nav-text">CMP / TEST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JCC-类"><span class="nav-text">JCC 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SET-类"><span class="nav-text">SET 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XCHG"><span class="nav-text">XCHG</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STOS"><span class="nav-text">STOS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#REP"><span class="nav-text">REP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#位运算"><span class="nav-text">位运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存"><span class="nav-text">内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#堆栈"><span class="nav-text">堆栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#标志寄存器"><span class="nav-text">标志寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#堆栈图"><span class="nav-text">堆栈图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-堆栈"><span class="nav-text">Windows 堆栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#裸函数"><span class="nav-text">裸函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用约定"><span class="nav-text">调用约定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#程序入口"><span class="nav-text">程序入口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据类型"><span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量"><span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结构体"><span class="nav-text">结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sizeof"><span class="nav-text">Sizeof</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存图"><span class="nav-text">内存图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分支语句"><span class="nav-text">分支语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#循环语句"><span class="nav-text">循环语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指针"><span class="nav-text">指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加壳"><span class="nav-text">加壳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PE"><span class="nav-text">PE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#空白区加代码"><span class="nav-text">空白区加代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#节"><span class="nav-text">节</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据字典"><span class="nav-text">数据字典</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导出表"><span class="nav-text">导出表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导入表"><span class="nav-text">导入表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定位表"><span class="nav-text">重定位表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IAT表"><span class="nav-text">IAT表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-API"><span class="nav-text">Windows API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#关键字"><span class="nav-text">关键字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#函数"><span class="nav-text">函数</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Peng</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.1</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,255,128" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  
    <script>
  window.livereOptions = {
    refer: '2020/09/20/BasicLanguage/KaliLearn/'
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
<script>
if ($('body').find('div.pdf').length) {
  $.ajax({
    type: 'GET',
    url: '//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js',
    dataType: 'script',
    cache: true,
    success: function() {
      $('body').find('div.pdf').each(function(i, o) {
        PDFObject.embed($(o).attr('target'), $(o), {
          pdfOpenParams: {
            navpanes: 0,
            toolbar: 0,
            statusbar: 0,
            pagemode: 'thumbs',
            view: 'FitH'
          },
          PDFJS_URL: '/lib/pdf/web/viewer.html',
          height: $(o).attr('height') || '600px'
        });
      });
    },
  });
}
</script>


  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  



<!-- <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script> -->


</body>
</html>
